"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var n=e(require("fs")),t=e(require("path")),o=e(require("module"));process.env.UNICLOUD_DEBUGGER_PATH=process.env.UNICLOUD_DEBUGGER_PATH||t.resolve(__dirname,"../");const r=process.env.UNICLOUD_DEBUGGER_PATH,i=t.resolve(r,"share/index"),{parseJson:s,getType:c,getRealWorkspace:l,getCloudfunctionPathList:u,getFunctionEntry:a,getCommonModulePath:d,getActionPath:f,isModuleEncrypted:p,isFileEncrypted:m,JsonRpcClient:h}=require(i),g=t.resolve(r,"internal-functions");n.readdirSync(g).filter(e=>n.statSync(t.resolve(g,e)).isDirectory());const y=[];var v=e=>{const o=function e(o){const r=[];try{const{dependencies:i}=JSON.parse(n.readFileSync(t.resolve(o,"package.json")));if(!i)return[];Object.keys(i).filter(e=>0===i[e].indexOf("file:")).map(n=>{const s=t.resolve(o,i[n].replace("file:",""));r.push({moduleName:n,modulePath:s}),r.push(...e(s))})}catch(e){}return r}(e);return 0===o.length||(function(e){const n={};for(let t=0;t<e.length;t++){const{moduleName:o,modulePath:r}=e[t];n[o]||(n[o]=new Set),n[o].add(r)}let t=!1;const o=[];if(Object.keys(n).forEach(e=>{n[e].size>1&&(t=!0,console.error(`公共模块[${e}]只能存在一个，请从下面候选中删除不使用的公共模块：`),n[e].forEach(e=>{console.error(e)}),o.push(e))}),t)throw new Error(`公共模块[${o.join("、")}]只能存在一个，删除不使用的公共模块后再试`)}(o),o.forEach(({moduleName:e,modulePath:n})=>{y.indexOf(e)>-1||p(n)&&y.push(e)})),y};class x extends Error{constructor(e){super(e.message),this.errMsg=e.message||"",this.code=e.code,Object.defineProperties(this,{message:{get(){return`errCode: ${e.code||""} | errMsg: `+this.errMsg},set(e){this.errMsg=e}}})}}const C=module.constructor.length>1?module.constructor:o,E=C._resolveFilename,D=[{regexp:/.*uniCloud(?:.*?)\/cloudfunctions\/common\/(.*)\//i,type:"common"},{regexp:/.*uniCloud(?:.*?)\/cloudfunctions\/uni-clientDB-actions\/(.*)/i,type:"clientDBAction"},{regexp:/.*uniCloud(?:.*?)\/database\/validateFunction\/(.*)/i,type:"validateFunction"},{regexp:/.*uniCloud(?:.*?)\/cloudfunctions\/(.*)\//i,type:"function"},{regexp:/.*unicloud\/internal-functions\/common\/(.*)\//i,type:"inernalCommon"},{regexp:/.*unicloud\/internal-functions\/(.*)\//i,type:"inernalFunction"}];function _(e,n){const t=e.match(n.regexp);if(t)return{modulePath:t[0],moduleName:t[1],type:n.type}}function O(e){let o;try{o=n.statSync(e)}catch(e){}if(!o)return;if(o.isFile()||o.isSymbolicLink())return e;const r=Object.keys(C._extensions);if(o.isDirectory()){const o=t.resolve(e,"package.json"),i=n.existsSync(o)&&require(o),s=i&&i.main;if(s)return t.resolve(e,s);for(let o=0;o<r.length;o++){const i=r[o],s=t.resolve(e,"index."+i);if(n.existsSync(s))return s}}}var F=e=>{C._resolveFilename=function(o,r,i,s){function c(){return E.call(C,o,r,i,s)}const l=o.split("/"),u=l.shift();if(u.startsWith(".")||!r.filename)return c();const a=l.join("/");if(e.indexOf(u)>-1)throw new x({code:"MODULE_ENCRYPTED",message:u+"模块已加密，不支持本地运行"});const f=function(e){e=e.replace(/\\/g,"/");for(let n=0;n<D.length;n++){const t=_(e,D[n]);if(t)return t}}(r.filename);if(!f)return c();const{modulePath:p,moduleName:m,type:h}=f;if("clientDBAction"===h||"validateFunction"===h||"inernalFunction"===h&&"DCloud-clientDB"===m){const{realWorkspace:e,provider:o}=global.uniCloudDebug;let r=["uni-id","uni-config-center"].indexOf(u)>-1;const i=d(e,o,u),s=t.resolve(i,"package.json"),l=n.existsSync(s)&&require(s);if(r=r||l.includeInClientDB,!r)return c();const a=O(i);return a||c()}const g=t.resolve(p,"package.json"),y=n.existsSync(g)&&require(g),v=y&&y.dependencies;if(!v)return c();let F=v[u];if(!F||!F.startsWith("file:"))return c();F=F.replace("file:","");let N=t.resolve(p,F);a&&(N=t.resolve(N,a));const P=O(N);return P||c()}};exports.callFunction=async function({name:e,data:o}={}){const{realWorkspace:r,provider:i}=global.uniCloudDebug,s=a(r,i,e);let c;try{c=n.statSync(t.resolve(s,"encrypt"))}catch(e){}if(c&&c.isFile())throw new x({code:"FUNCTION_ENCRYPTED",message:"此云函数已加密，不可本地运行"});const l=v(s);let u;F(l);try{u=require(s);return{result:await u.main(o,{SPACEINFO:global.__ctx__.SPACEINFO}),success:!0}}catch(e){throw"MODULE_NOT_FOUND"===e.code&&console.error("请求云函数错误，可能是由于云函数名称错误或者引用的其他模块未找到导致的，请参考下方详细错误信息。注意公共模块需要参考 https://uniapp.dcloud.net.cn/uniCloud/cf-common 进行本地安装。"),e}};
