"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var n=e(require("path")),t=e(require("fs")),o=e(require("module"));const r=Object.prototype.toString;function i(e,n,{parseSource:t,parseClientIP:o,parseClientUserAgent:i,parseSpaceInfo:c,parseFunctionName:s}={}){e||(e={}),e.clientInfo||(e.clientInfo={});const l=e.clientInfo;return l.SOURCE=t(e,n),l.CLIENTIP=o(e,n)||"",l.CLIENTUA=i(e,n)||"",l.SPACEINFO=c(e,n)||"",l.FUNCTION_NAME=s(e,n)||"",function(e,n){const t=e.clientInfo,o=e.headers;o&&(t.CLIENTIP||(t.CLIENTIP=o["x-real-ip"]),t.CLIENTUA||(t.CLIENTUA=o["user-agent"]));t.DEVICEID||(t.DEVICEID=e.uniCloudDeviceId);if(t&&"[object Object]"===r.call(t))for(const e in t)Object.hasOwnProperty.call(t,e)&&!n[e]&&(n[e]=t[e]);delete e.uniCloudDeviceId,delete e.clientInfo,delete e.uniCloudClientInfo}(e,n),e}const c={};var s=async(e,o,r)=>{i(e,o,r),function(e,n){global.__ctx__=n,global.__args__=e}(e,o),delete process.env.accessKeyID,delete process.env.accessKeySecret,delete process.env.securityToken,o=Object.assign({},o),r.initUniCloud(),function(){const e=require("path"),n=e.resolve(__dirname,"./@common_modules");let t;try{t=require(e.resolve(__dirname,"package.json"))}catch(e){}if(!t||!t.extensions)return;const o=Object.keys(t.extensions);if(o.length)throw new Error("当前云函数用到了扩展能力暂不支持本地调试，请上传到云端调试");o.forEach(t=>{const o=c[t]||t;require(e.resolve(n,o))})}();const s=global.uniCloudDebug.functionEntry;{let r;try{return r=require(s),r.main(e,o)}catch(e){throw"MODULE_NOT_FOUND"===e.code&&(t.existsSync(n.resolve(s,"index.js"))?console.error("请求云函数错误，可能是由于引用的模块未找到导致的，请参考下方详细错误信息。注意公共模块需要参考 https://uniapp.dcloud.net.cn/uniCloud/cf-common 进行本地安装。"):console.log("云函数名称错误或所请求云函数在cloudfunctions目录不存在，如果云端已上传可以下载到本地")),e}}return require(s).main(e,o)};const l=require("./@dcloudio/serverless/lib/tcb/uni-cloud");let u,a;try{u=require(n.resolve(global.uniCloudDebug.functionEntry,"./credentials.json"))}catch(e){}function d(e,n){return"client"}function f(e,n){return global.uniCloudDebug.clientIP||"127.0.0.1"}function p(e,n){return global.uniCloudDebug.userAgent||"HBuilderX"}function g(e,n){return{spaceId:global.__space_id__,provider:"tencent"}}function C(e,n){return global.uniCloudDebug.functionName}function E(e){global.uniCloud,global.uniCloud=new l({credentials:u,...a,context:e});{const e=a||{};if(process.env.TENCENTCLOUD_SECRETID=e.secretId,process.env.TENCENTCLOUD_SECRETKEY=e.secretKey,process.env.TENCENTCLOUD_SESSIONTOKEN=e.sessionToken,global.uniCloud.isLocal=!0,global.uniCloudDebug.isServe){const e=require("./local").callFunction;global.uniCloud.callFunction=e}}}async function m(e,{uniCloudSecret:n}={}){const t=console.warn;let o;console.warn=function(){arguments&&arguments[0]&&0===arguments[0].indexOf("请检查您是否在本地环境")||t.apply(this,arguments)};try{o=n||JSON.parse(process.env.UNICLOUD_SECRET)}catch(e){throw new Error("未能获取本地调试所需参数，请稍后再试")}global.__space_id__=o.spaceId;return await async function(e,n,{uniCloudSecret:t}={}){return a=t,s(e,n,{parseSource:d,parseClientIP:f,parseClientUserAgent:p,parseSpaceInfo:g,parseFunctionName:C,initUniCloud:E})}(e,{},{uniCloudSecret:o})}s.toString=function(){return""},process.env.UNICLOUD_DEBUGGER_PATH=process.env.UNICLOUD_DEBUGGER_PATH||n.resolve(__dirname,"../");const h=process.env.UNICLOUD_DEBUGGER_PATH,v=n.resolve(h,"share/index"),{parseJson:y,getType:I,getRealWorkspace:_,getCloudfunctionPathList:D,getFunctionEntry:b,getCommonModulePath:N,getActionPath:O,isModuleEncrypted:S,isFileEncrypted:x,JsonRpcClient:U}=require(v),P=n.resolve(h,"internal-functions"),T=t.readdirSync(P).filter(e=>t.statSync(n.resolve(P,e)).isDirectory());const F=[];var j=e=>{const o=function e(o){const r=[];try{const{dependencies:i}=JSON.parse(t.readFileSync(n.resolve(o,"package.json")));if(!i)return[];Object.keys(i).filter(e=>0===i[e].indexOf("file:")).map(t=>{const c=n.resolve(o,i[t].replace("file:",""));r.push({moduleName:t,modulePath:c}),r.push(...e(c))})}catch(e){}return r}(e);return 0===o.length||(function(e){const n={};for(let t=0;t<e.length;t++){const{moduleName:o,modulePath:r}=e[t];n[o]||(n[o]=new Set),n[o].add(r)}let t=!1;const o=[];if(Object.keys(n).forEach(e=>{n[e].size>1&&(t=!0,console.error(`公共模块[${e}]只能存在一个，请从下面候选中删除不使用的公共模块：`),n[e].forEach(e=>{console.error(e)}),o.push(e))}),t)throw new Error(`公共模块[${o.join("、")}]只能存在一个，删除不使用的公共模块后再试`)}(o),o.forEach(({moduleName:e,modulePath:n})=>{F.indexOf(e)>-1||S(n)&&F.push(e)})),F};class L extends Error{constructor(e){super(e.message),this.errMsg=e.message||"",this.code=e.code,Object.defineProperties(this,{message:{get(){return`errCode: ${e.code||""} | errMsg: `+this.errMsg},set(e){this.errMsg=e}}})}}const w=module.constructor.length>1?module.constructor:o,A=w._resolveFilename,k=[{regexp:/.*uniCloud(?:.*?)\/cloudfunctions\/common\/(.*)\//i,type:"common"},{regexp:/.*uniCloud(?:.*?)\/cloudfunctions\/uni-clientDB-actions\/(.*)/i,type:"clientDBAction"},{regexp:/.*uniCloud(?:.*?)\/database\/validateFunction\/(.*)/i,type:"validateFunction"},{regexp:/.*uniCloud(?:.*?)\/cloudfunctions\/(.*)\//i,type:"function"},{regexp:/.*unicloud\/internal-functions\/common\/(.*)\//i,type:"inernalCommon"},{regexp:/.*unicloud\/internal-functions\/(.*)\//i,type:"inernalFunction"}];function q(e,n){const t=e.match(n.regexp);if(t)return{modulePath:t[0],moduleName:t[1],type:n.type}}function R(e){let o;try{o=t.statSync(e)}catch(e){}if(!o)return;if(o.isFile()||o.isSymbolicLink())return e;const r=Object.keys(w._extensions);if(o.isDirectory()){const o=n.resolve(e,"package.json"),i=t.existsSync(o)&&require(o),c=i&&i.main;if(c)return n.resolve(e,c);for(let o=0;o<r.length;o++){const i=r[o],c=n.resolve(e,"index."+i);if(t.existsSync(c))return c}}}var B=e=>{w._resolveFilename=function(o,r,i,c){function s(){return A.call(w,o,r,i,c)}const l=o.split("/"),u=l.shift();if(u.startsWith(".")||!r.filename)return s();const a=l.join("/");if(e.indexOf(u)>-1)throw new L({code:"MODULE_ENCRYPTED",message:u+"模块已加密，不支持本地运行"});const d=function(e){e=e.replace(/\\/g,"/");for(let n=0;n<k.length;n++){const t=q(e,k[n]);if(t)return t}}(r.filename);if(!d)return s();const{modulePath:f,moduleName:p,type:g}=d;if("clientDBAction"===g||"validateFunction"===g||"inernalFunction"===g&&"DCloud-clientDB"===p){const{realWorkspace:e,provider:o}=global.uniCloudDebug;let r=["uni-id","uni-config-center"].indexOf(u)>-1;const i=N(e,o,u),c=n.resolve(i,"package.json"),l=t.existsSync(c)&&require(c);if(r=r||l.includeInClientDB,!r)return s();const a=R(i);return a||s()}const C=n.resolve(f,"package.json"),E=t.existsSync(C)&&require(C),m=E&&E.dependencies;if(!m)return s();let h=m[u];if(!h||!h.startsWith("file:"))return s();h=h.replace("file:","");let v=n.resolve(f,h);a&&(v=n.resolve(v,a));const y=R(v);return y||s()}};const M=process.env.SPACE_PROVIDER,G=_({uniCloudInfo:JSON.parse(process.env.UNICLOUD_INFO),workspaceFolder:process.env.WORKSPACE_FOLDER,provider:M});global.uniCloudDebug={realWorkspace:G,provider:M},process.noDeprecation=!0,module.exports=async function(e,t,{userAgent:o,clientIP:r,uniCloudSecret:i={}}={}){t=t||{};const c=function(e,t,o){return T.indexOf(o)>-1?n.resolve(P,o):b(e,t,o)}(G,M,e);if(S(c))throw new L({code:"FUNCTION_ENCRYPTED",message:"此云函数已加密，不可本地运行"});Object.assign(global.uniCloudDebug,{functionName:e,functionEntry:c,userAgent:o,clientIP:r,isServe:!0});const s=j(c);return B(s),await m(t,{uniCloudSecret:i})};
