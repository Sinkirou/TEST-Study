"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("path")),n=e(require("module")),a=e(require("@cloudbase/node-sdk")),r=e(require("crypto"));!function(e,t,n){e(n={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&n.path)}},n.exports),n.exports}((function(e){{const a=e.constructor.length>1?e.constructor:n,r=t.resolve(__dirname,"../../../../@common_modules"),s=a._nodeModulePaths;a._nodeModulePaths=function(e){let t=s.call(this,e);return t=t.concat(r),t}}}));class s extends Error{constructor(e){super(e.message),this.errMsg=e.message||"",this.code=e.code,Object.defineProperties(this,{message:{get(){return`errCode: ${e.code||""} | errMsg: `+this.errMsg},set(e){this.errMsg=e}}})}}const o=[{rule:/Cannot create field (\S+) in element {(\S+): \[\]}/,content:"，不可在{$2}上新增字段{$1}，因为{$2}是一个数组",mode:"append"},{rule:/Db or Table not exist/,content:"，服务空间内不存在名为{collName}的表，请检查表名是否正确",mode:"append"},{rule:/operation exceeded time limit|云数据库执行时间超限/,content:"，集合{collName}操作超时，请参照此文档进行优化：https://uniapp.dcloud.net.cn/uniCloud/db-performance",mode:"append"},{rule:/TransientTransactionError.*WriteConflict/,content:"，事务写数据冲突，请优化事务流程",mode:"append"}];function i(e,t,n){return new Promise((function(a,r){e.then(e=>{e.code?r(new s(n?n(e):e)):a(t?t(e):e)}).catch(e=>{r(new s(n?n(e):e))})}))}const c=Object.prototype.toString,l=Object.prototype.hasOwnProperty;function u(e){return c.call(e).slice(8,-1).toLowerCase()}function d(e,t){return new Error(e.replace("%err%",t))}function m({param:e,rule:t,errTpl:n="%err%",paramPath:a=""}){Object.keys(t).forEach(r=>{if(!function(e,t){return l.call(e,t)}(e,r))throw d(n,`缺少参数${a}${r}`);if(!e[r]&&!1!==e[r]&&0!==e[r])throw d(n,`参数${a}${r}值不可为空`);if("object"===u(t[r]))m({param:e[r],rule:t[r],errTpl:n,paramPath:r+"."});else{const s=u(e[r]);if(-1===t[r].indexOf(s))throw d(n,`参数${a}${r}类型不正确，期望传入类型${t[r].join("、")}，实际传入${s}`)}})}var p=/[\\^$.*+?()[\]{}|]/g,h=RegExp(p.source);function g(e,t,n){return e.replace(new RegExp((a=t)&&h.test(a)?a.replace(p,"\\$&"):a,"g"),n);var a}function f({collName:e}){return function(t){const n=t&&t.message;return n?(t.message=function({message:e="",extraInfo:t={},formatter:n=[]}={}){for(let a=0;a<n.length;a++){const{rule:r,content:s,mode:o}=n[a],i=e.match(r);if(!i)continue;let c=s;for(let e=1;e<i.length;e++)c=g(c,`{$${e}}`,i[e]);for(const e in t)c=g(c,`{${e}}`,t[e]);switch(o){case"replace":return c;case"append":default:return e+c}}return e}({message:n,extraInfo:{collName:e},formatter:o}),t):t}}const y=["uploadFile","getTempFileURL","deleteFile","downloadFile"];const b=Object.prototype.toString;function v(e){return e.map(e=>{if("[object object]"===b.call(e).toLowerCase())try{e=JSON.stringify(e)}catch(t){e=String(e)}else e=String(e);return e}).join(" ")}function w(e,t){const n=t(e);return new Proxy(e,{get:(e,t)=>n[t]?n[t]:e[t],set:(e,t,n)=>(e[t]=n,!0)})}const x=["create","set","update","remove","get"];function _(e){const t={field:t=>w(e.field(t),_)};return x.forEach(n=>{t[n]=function(...t){return i(e[n].apply(e,t))}}),t}function $(e){return{end:()=>i(e.end(),null,f({collName:e._coll}))}}const S=["add","get","count","update","remove"],k=["where","orderBy","limit","skip","field"],M={add:function(e){return e.id?e.inserted=1:e.ids&&(e.inserted=e.ids.length),e}};function O(e){const t={doc:t=>w(e.doc(t),_),aggregate:()=>w(e.aggregate(),$)};return k.forEach(n=>{t[n]=function(...t){return w(e[n].apply(e,t),O)}}),S.forEach(n=>{t[n]=function(...t){return i(e[n].apply(e,t),M[n],f({collName:e._coll}))}}),t}function j(e){return{collection:t=>w(e.collection(t),O),createCollection:t=>i(e.createCollection(t))}}async function I(e={}){const t=e.appid||global.__ctx__.APPID||void 0,n=global.__ctx__.SPACEINFO.spaceId,a={aliyun:"aliyun",tencent:"tcb"}[global.__ctx__.SPACEINFO.provider],{apiKey:o,apiSecret:i,access_token:c,openid:l}=e,u={token:c,openid:l,appid:t,spaceId:n,provider:a,apiKey:o};for(const e in u)void 0===u[e]&&delete u[e];const d=Object.keys(u).sort().map(e=>`${e}=${""+u[e]}`);d.push("apiSecret="+i);const m=r.createHash("md5");m.update(d.join("&"));const p=m.digest("hex").toLowerCase();let h;try{h=await uniCloud.httpclient.request("https://c2c84d41-a90b-40ed-83e2-025e60889a78.bspapp.com/http/get-mobile-space",{data:{...u,sign:p},dataAsQueryString:!0,dataType:"json",timeout:3e4})}catch(e){h={}}if(h&&h.status>=400)try{h=await uniCloud.httpclient.request("https://hbonshoregewslogypti.dcloud.net.cn/get-mobile-space",{data:{...u,sign:p},dataAsQueryString:!0,dataType:"json",timeout:3e4})}catch(e){h={}}if(h&&h.data){if(0===h.data.ret)return{code:0,success:!0,phoneNumber:h.data.data.mobile};throw 4002===h.data.ret?new s({code:4002,message:"获取手机号码失败：请检查密钥是否正确"}):new s({code:h.data.ret||5e3,message:"获取手机号码失败："+h.data.desc})}throw new s({code:5e3,message:"获取手机号码失败"})}async function L(e){const t={univerify:I},{provider:n}=e;let a;switch(n){case"univerify":a={access_token:["string"],openid:["string"],apiKey:["string"],apiSecret:["string"]};break;case void 0:throw new s({code:1001,message:"getPhoneNumber缺少参数provider"});default:throw new s({code:1001,message:"getPhoneNumber不支持provider:"+n})}try{m({param:e,rule:a,errTpl:"getPhoneNumber%err%"})}catch(e){throw new s({code:1001,message:e.message})}return await t[n](e)}const E={uniID_code:["name","code","action","expMinute"],uni_verify_code:["name","code","action","expMinute"],uni_order_unpaid:["name","orderNo","minute"],uni_booking:["name","service","dateTime","notice"],uni_order_shipped:["name","orderNo","expressCompany","expressNo"]},N={name:{rule:/^[\s\S]{1,15}$/,msg:"data.name长度限制为1-15位"},code:{rule:/^[\d|\w|\W]{1,6}$/,msg:"data.code只支持数字和大小写字母，长度不可超过6位"},action:{rule:/^[\s\S]{1,6}$/,msg:"data.action长度限制为1-6位"},expMinute:{rule:/^\d{1,2}$/,msg:"data.expMinute需为正整数字符串，长度不可超过2位"},time:{rule:/^\d{1,2}$/,msg:"data.time需为正整数字符串，长度不可超过2位"},orderNo:{rule:/^[\s\S]{1,20}$/,msg:"data.orderNo长度限制为1-20位"},minute:{rule:/^\d{1,2}$/,msg:"data.minute需为正整数字符串，长度不可超过2位"},service:{rule:/^[\s\S]{1,10}$/,msg:"data.service长度限制为1-10位"},dateTime:{rule:/^[\s\S]{1,18}$/,msg:"data.dateTime长度限制为1-18位"},notice:{rule:/^[\s\S]{1,20}$/,msg:"data.notice长度限制为1-20位"},expressCompany:{rule:/^[\s\S]{1,12}$/,msg:"data.expressCompany长度限制为1-12位"},expressNo:{rule:/^[\s\S]{1,20}$/,msg:"data.expressNo长度限制为1-20位"}};async function C(e){const t={smsKey:["string"],smsSecret:["string"],templateId:["string"],phone:["string"],data:["object"]};try{m({param:e,rule:t,errTpl:"sendSms%err%"})}catch(e){throw new s({code:1001,message:e.message})}const n=e.appid||global.__ctx__.APPID||void 0,a=global.__ctx__.SPACEINFO.spaceId,o={aliyun:"aliyun",tencent:"tcb"}[global.__ctx__.SPACEINFO.provider],i=""+Date.now(),{smsKey:c,smsSecret:l,templateId:u,phone:d,data:p}=e;if(E[u]){if(!/^(0|17951|86|\+86)?(1\d{10})$/.test(d))throw new s({code:1001,message:"手机号格式不正确，仅支持中国大陆手机号"});const e=E[u],t=Object.keys(p);t.forEach(t=>{if(-1===e.indexOf(t))throw new s({code:1001,message:`模板${u}不可使用参数data.${t}`})}),e.forEach(e=>{if(-1===t.indexOf(e))throw new s({code:1001,message:`模板${u}缺少参数data.${e}`})}),e.forEach(e=>{if(!N[e].rule.test(p[e]))throw new s({code:1001,message:N[e].msg})}),p.expMinute&&(p.time=p.expMinute,delete p.expMinute)}const h=Object.keys(p).reduce((e,t)=>e+=p[t],"");if(/【|】/.test(h))throw new s({code:1001,message:"为避免与签名混淆，短信内容不可包含“【】”符号"});let g;/(测试|test)/i.test(h)&&console.warn("短信内容包含“测试”、“test”字样时，系统可能会被判定为测试用途，不会真正把短信下发到对应手机（此行为由运营商控制，可能真实发送，也可能不发送）"),g=E[u]?Object.assign({appid:n,apiKey:c,templateId:u,timestamp:i,phone:d,spaceId:a,provider:o},p):{appid:n,apiKey:c,templateId:u,timestamp:i,phone:d,spaceId:a,provider:o,params:JSON.stringify(p)};for(const e in g)void 0===g[e]&&delete g[e];const f=Object.keys(g).sort().map(e=>`${e}=${""+g[e]}`);f.push("apiSecret="+l);const y=r.createHash("md5");y.update(f.join("&"));const b=y.digest("hex").toLowerCase();let v;try{v=await uniCloud.httpclient.request("https://c2c84d41-a90b-40ed-83e2-025e60889a78.bspapp.com/http/send-sms-space",{data:{...g,sign:b},dataAsQueryString:!0,dataType:"json",timeout:3e4})}catch(e){v={}}if(v&&v.status>=400)try{v=await uniCloud.httpclient.request("https://hbonshoregewslogypti.dcloud.net.cn/send-sms-space",{data:{...g,sign:b},dataAsQueryString:!0,dataType:"json",timeout:3e4})}catch(e){v={}}if(v&&v.data){if(0===v.data.ret)return{code:0,errCode:0,success:!0};throw 4002===v.data.ret?new s({code:4002,message:"短信发送失败：请检查密钥是否正确"}):new s({code:v.data.ret||5e3,message:"短信发送失败："+v.data.desc})}throw new s({code:5e3,message:"短信发送失败"})}const A=/^(?:\d)+/,T=/^(?:\w)+/;const F=Object.prototype.hasOwnProperty,P=new class{constructor(){this._caches=Object.create(null)}interpolate(e,t){if(!t)return[e];let n=this._caches[e];return n||(n=function(e){const t=[];let n=0,a="";for(;n<e.length;){let r=e[n++];if("{"===r){a&&t.push({type:"text",value:a}),a="";let s="";for(r=e[n++];void 0!==r&&"}"!==r;)s+=r,r=e[n++];const o="}"===r,i=A.test(s)?"list":o&&T.test(s)?"named":"unknown";t.push({value:s,type:i})}else"%"===r?"{"!==e[n]&&(a+=r):a+=r}return a&&t.push({type:"text",value:a}),t}(e),this._caches[e]=n),function(e,t){const n=[];let a=0;const r=Array.isArray(t)?"list":(s=t,null!==s&&"object"==typeof s?"named":"unknown");var s;if("unknown"===r)return n;for(;a<e.length;){const s=e[a];switch(s.type){case"text":n.push(s.value);break;case"list":n.push(t[parseInt(s.value,10)]);break;case"named":"named"===r&&n.push(t[s.value])}a++}return n}(n,t)}};function q(e,t){if(!e)return;if(t[e=e.trim().replace(/_/g,"-")])return e;if(0===(e=e.toLowerCase()).indexOf("zh"))return-1!==e.indexOf("-hans")?"zh-Hans":-1!==e.indexOf("-hant")?"zh-Hant":(n=e,["-tw","-hk","-mo","-cht"].find(e=>-1!==n.indexOf(e))?"zh-Hant":"zh-Hans");var n;const a=function(e,t){return t.find(t=>0===e.indexOf(t))}(e,["en","fr","es"]);return a||void 0}class z{constructor({locale:e,fallbackLocale:t,messages:n,watcher:a,formater:r}){this.locale="en",this.fallbackLocale="en",this.message={},this.messages={},this.watchers=[],t&&(this.fallbackLocale=t),this.formater=r||P,this.messages=n,this.setLocale(e),a&&this.watchLocale(a)}setLocale(e){const t=this.locale;this.locale=q(e,this.messages)||this.fallbackLocale,this.message=this.messages[this.locale],this.watchers.forEach(e=>{e(this.locale,t)})}getLocale(){return this.locale}watchLocale(e){const t=this.watchers.push(e)-1;return()=>{this.watchers.splice(t,1)}}t(e,t,n){let a=this.message;return"string"==typeof t?(t=q(t,this.messages))&&(a=this.messages[t]):n=t,((e,t)=>F.call(e,t))(a,e)?this.formater.interpolate(a[e],n).join(""):(console.warn(`Cannot translate the value of keypath ${e}. Use the value of keypath as default.`),e)}}function R({locale:e,fallbackLocale:t,messages:n}){return new z({locale:e,fallbackLocale:t,messages:n})}var D={email:/^\S+?@\S+?\.\S+?$/,idcard:/^[1-9]\d{5}(18|19|([23]\d))\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$/,url:new RegExp("^(?!mailto:)(?:(?:http|https|ftp)://|//)(?:\\S+(?::\\S*)?@)?(?:(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[0-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-*)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-*)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))|localhost)(?::\\d{2,5})?(?:(/|\\?|#)[^\\s]*)?$","i")};const U={int:"integer",bool:"boolean",double:"number",long:"number",password:"string"};function V(e,t=""){["label"].forEach(t=>{void 0===e[t]&&(e[t]="")});let n=t;for(const t in e){const a=new RegExp("{"+t+"}");n=n.replace(a,e[t])}return n}const H={integer:e=>H.number(e)&&parseInt(e,10)===e,string:e=>"string"==typeof e,number:e=>!isNaN(e)&&"number"==typeof e,boolean:function(e){return"boolean"==typeof e},float:function(e){return H.number(e)&&!H.integer(e)},array:e=>Array.isArray(e),object:e=>"object"==typeof e&&!H.array(e),date:e=>e instanceof Date,timestamp(e){return!(!this.integer(e)||Math.abs(e).toString().length>16)},file:e=>"string"==typeof e.url,email:e=>"string"==typeof e&&!!e.match(D.email)&&e.length<255,url:e=>"string"==typeof e&&!!e.match(D.url),pattern(e,t){try{return new RegExp(e).test(t)}catch(e){return!1}},method:e=>"function"==typeof e,idcard:e=>"string"==typeof e&&!!e.match(D.idcard),"url-https"(e){return this.url(e)&&e.startsWith("https://")},"url-scheme":e=>e.startsWith("://")};const K={required:(e,t,n)=>e.required&&function(e,t){return null==e||("string"==typeof e&&!e||(!(!Array.isArray(e)||e.length)||"object"===t&&!Object.keys(e).length))}(t,e.format||typeof t)?V(e,e.errorMessage||n.required):null,range(e,t,n){const{range:a,errorMessage:r}=e,s=new Array(a.length);for(let e=0;e<a.length;e++){const t=a[e];H.object(t)&&void 0!==t.value?s[e]=t.value:s[e]=t}let o=!1;return Array.isArray(t)?o=new Set(t.concat(s)).size===s.length:s.indexOf(t)>-1&&(o=!0),o?null:V(e,r||n.enum)},rangeNumber(e,t,n){if(!H.number(t))return V(e,e.errorMessage||n.pattern.mismatch);const{minimum:a,maximum:r,exclusiveMinimum:s,exclusiveMaximum:o}=e,i=s?t<=a:t<a,c=o?t>=r:t>r;return void 0!==a&&i?V(e,e.errorMessage||n.number[s?"exclusiveMinimum":"minimum"]):void 0!==r&&c?V(e,e.errorMessage||n.number[o?"exclusiveMaximum":"maximum"]):void 0!==a&&void 0!==r&&(i||c)?V(e,e.errorMessage||n.number.range):null},rangeLength(e,t,n){if(!H.string(t)&&!H.array(t))return V(e,e.errorMessage||n.pattern.mismatch);const a=e.minLength,r=e.maxLength,s=t.length;return void 0!==a&&s<a?V(e,e.errorMessage||n.length.minLength):void 0!==r&&s>r?V(e,e.errorMessage||n.length.maxLength):void 0!==a&&void 0!==r&&(s<a||s>r)?V(e,e.errorMessage||n.length.range):null},pattern:(e,t,n)=>H.pattern(e.pattern,t)?null:V(e,e.errorMessage||n.pattern.mismatch),format(e,t,n){var a=Object.keys(H),r=U[e.format]?U[e.format]:e.format||e.arrayType;return a.indexOf(r)>-1&&!H[r](t)?V(e,e.errorMessage||n.typeError):null},arrayTypeFormat(e,t,n){if(!Array.isArray(t))return V(e,e.errorMessage||n.typeError);for(let a=0;a<t.length;a++){const r=t[a],s=this.format(e,r,n);if(null!==s)return s}return null}};class Q extends class{constructor(e){this._message=e}async validateRule(e,t,n,a,r){var s=null;const o=t.rules;if(o.findIndex(e=>e.required)<0){if(null==n)return s;if("string"==typeof n&&!n.length)return s}var i=this._message;if(void 0===o)return i.default;for(var c=0;c<o.length;c++){const l=o[c],u=this._getValidateType(l);if(Object.assign(l,{label:t.label||`["${e}"]`}),K[u]&&null!=(s=K[u](l,n,i)))break;if(l.validateExpr){const e=Date.now();if(!1===l.validateExpr(n,r,e)){s=this._getMessage(l,l.errorMessage||this._message.default);break}}if(l.validateFunction&&null!==(s=await this.validateFunction(l,n,a,r,u)))break}return null!==s&&(s=i.TAG+s),s}async validateFunction(e,t,n,a,r){let s=null;try{let o=null;const i=await e.validateFunction(e,t,a||n,e=>{o=e});(o||"string"==typeof i&&i||!1===i)&&(s=this._getMessage(e,o||i,r))}catch(t){s=this._getMessage(e,t.message,r)}return s}_getMessage(e,t,n){return V(e,t||e.errorMessage||this._message[n]||t.default)}_getValidateType(e){var t="";return e.required?t="required":e.format?t="format":e.arrayType?t="arrayTypeFormat":e.range?t="range":void 0!==e.maximum||void 0!==e.minimum?t="rangeNumber":void 0!==e.maxLength||void 0!==e.minLength?t="rangeLength":e.pattern?t="pattern":e.validateFunction&&(t="validateFunction"),t}}{constructor(e,t){super(Q.message),this._schema=e,this._options=t||null}updateSchema(e){this._schema=e}async validate(e,t){let n=this._checkFieldInSchema(e);return n||(n=await this.invokeValidate(e,!1,t)),n.length?n[0]:null}async validateAll(e,t){let n=this._checkFieldInSchema(e);return n||(n=await this.invokeValidate(e,!0,t)),n}async validateUpdate(e,t){let n=this._checkFieldInSchema(e);return n||(n=await this.invokeValidateUpdate(e,!1,t)),n.length?n[0]:null}async invokeValidate(e,t,n){const a=[],r=this._schema;for(const s in r){const o=r[s],i=await this.validateRule(s,o,e[s],e,n);if(null!=i&&(a.push({key:s,errorMessage:i}),!t))break}return a}async invokeValidateUpdate(e,t,n){const a=[];for(const r in e){const s=await this.validateRule(r,this._schema[r],e[r],e,n);if(null!=s&&(a.push({key:r,errorMessage:s}),!t))break}return a}_checkFieldInSchema(e){var t=Object.keys(e),n=Object.keys(this._schema);if(new Set(t.concat(n)).size===n.length)return"";var a=t.filter(e=>n.indexOf(e)<0);return[{key:"invalid",errorMessage:V({field:JSON.stringify(a)},Q.message.TAG+Q.message.defaultInvalid)}]}}function W(e={},t){this.$provider="tencent",this.$options=e,this.$context=e.context||global.__ctx__,function(e){e.$options.spaceId&&(e.$options.env=e.$options.spaceId),e.$options.credentials&&!e.$options.credentials.env_id&&(e.$options.credentials.env_id=e.$options.env),e.$scope=a.init(Object.assign({env:a.SYMBOL_CURRENT_ENV},e.$options))}(this),function(e){e.auth=function(t){return e.$scope.auth(t)},e.customAuth=e.auth}(this),function(e){const t=e.$scope;y.forEach(n=>{e[n]=function(...e){return i(t[n].apply(t,e))}})}(this),function(e){const t=e.$scope.logger();function n(e){return function(...n){return t[e]({[e]:v(n)})}}e.logger={log:n("log"),info:n("info"),warn:n("warn"),error:n("error")}}(this),function(e){e.database=function(t){return t&&t.spaceId&&(t.env=t.spaceId),w(e.$scope.database(t),j)}}(this),function(e){e.callFunction=function({name:t,data:n}){return i(e.$scope.callFunction({name:t,data:n}))}}(this),function(e){let t;Object.defineProperty(e,"httpclient",{get:function(){return t||(t=require("urllib").create()),t}})}(this),function(e){e.getPhoneNumber=L,e.sendSms=C,e.initI18n=R,e.validate=async function(e,t,n={}){const a=new Q(t,n);return n.ignoreRequired?a.validateUpdate(e):a.validate(e)}}(this)}Q.message=new function(){return{TAG:"数据库验证失败：",default:"验证错误",defaultInvalid:`提交的字段{field}在${"true"===process.env.USE_CLOUD_SCHEMA?"云端":"本地"}数据表的schema文件中不存在`,validateFunction:"验证无效",required:"{label}必填",enum:"{label}字段为枚举类型，提交内容不在枚举范围内",timestamp:"{label}格式无效",whitespace:"{label}不能为空",typeError:"{label}类型无效",date:{format:"{label}日期{value}格式无效",parse:"{label}日期无法解析,{value}无效",invalid:"{label}日期{value}无效"},length:{minLength:"{label}长度不能少于{minLength}",maxLength:"{label}长度不能超过{maxLength}",range:"{label}必须介于{minLength}和{maxLength}之间"},number:{minimum:"{label}不能小于{minimum}",maximum:"{label}不能大于{maximum}",exclusiveMinimum:"{label}不能小于等于{minimum}",exclusiveMaximum:"{label}不能大于等于{maximum}",range:"{label}必须介于{minimum}and{maximum}之间"},pattern:{mismatch:"{label}格式不匹配"}}},W.prototype.init=function(e){return"tencent"===uniCloud.$provider&&e.context&&!e.spaceId?this:new W(e)},module.exports=W;
