"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("path")),r=e(require("module")),n=e(require("crypto"));!function(e,t,r){e(r={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&r.path)}},r.exports),r.exports}((function(e){{const n=e.constructor.length>1?e.constructor:r,i=t.resolve(__dirname,"../../../../@common_modules"),o=n._nodeModulePaths;n._nodeModulePaths=function(e){let t=o.call(this,e);return t=t.concat(i),t}}}));class i extends Error{constructor(e){super(e.message),this.errMsg=e.message||"",this.code=e.code,Object.defineProperties(this,{message:{get(){return`errCode: ${e.code||""} | errMsg: `+this.errMsg},set(e){this.errMsg=e}}})}}const o=[{rule:/Cannot create field (\S+) in element {(\S+): \[\]}/,content:"，不可在{$2}上新增字段{$1}，因为{$2}是一个数组",mode:"append"},{rule:/Db or Table not exist/,content:"，服务空间内不存在名为{collName}的表，请检查表名是否正确",mode:"append"},{rule:/operation exceeded time limit|云数据库执行时间超限/,content:"，集合{collName}操作超时，请参照此文档进行优化：https://uniapp.dcloud.net.cn/uniCloud/db-performance",mode:"append"},{rule:/TransientTransactionError.*WriteConflict/,content:"，事务写数据冲突，请优化事务流程",mode:"append"}];function s(e){return function(){throw new Error("阿里云服务空间暂不支持 "+e)}}function a(e,t,r){return new Promise((function(n,o){e.then(e=>{e.code?o(new i(r?r(e):e)):n(t?t(e):e)}).catch(e=>{o(new i(r?r(e):e))})}))}const c=Object.prototype.toString,l=Object.prototype.hasOwnProperty;function d(e,t){return l.call(e,t)}function u(e){return"[object Object]"===c.call(e)}function h(e){return c.call(e).slice(8,-1).toLowerCase()}function p(e,t){return new Error(e.replace("%err%",t))}function f({param:e,rule:t,errTpl:r="%err%",paramPath:n=""}){Object.keys(t).forEach(i=>{if(!d(e,i))throw p(r,`缺少参数${n}${i}`);if(!e[i]&&!1!==e[i]&&0!==e[i])throw p(r,`参数${n}${i}值不可为空`);if("object"===h(t[i]))f({param:e[i],rule:t[i],errTpl:r,paramPath:i+"."});else{const o=h(e[i]);if(-1===t[i].indexOf(o))throw p(r,`参数${n}${i}类型不正确，期望传入类型${t[i].join("、")}，实际传入${o}`)}})}var m=/[\\^$.*+?()[\]{}|]/g,w=RegExp(m.source);function g(e,t,r){return e.replace(new RegExp((n=t)&&w.test(n)?n.replace(m,"\\$&"):n,"g"),r);var n}function y({collName:e}){return function(t){const r=t&&t.message;return r?(t.message=function({message:e="",extraInfo:t={},formatter:r=[]}={}){for(let n=0;n<r.length;n++){const{rule:i,content:o,mode:s}=r[n],a=e.match(i);if(!a)continue;let c=o;for(let e=1;e<a.length;e++)c=g(c,`{$${e}}`,a[e]);for(const e in t)c=g(c,`{${e}}`,t[e]);switch(s){case"replace":return c;case"append":default:return e+c}}return e}({message:r,extraInfo:{collName:e},formatter:o}),t):t}}function _(e){e.uploadFile=function(e){return async function(t={}){const r={fileName:t.cloudPath};return Buffer.isBuffer(t.fileContent)?r.fileBuffer=t.fileContent:r.filePath=t.fileContent,e.$scope.file.uploadFile(r).then(e=>({fileID:e.fileUrl}))}}(e),e.deleteFile=function(e){return async function({fileList:t=[]}={}){if(Array.isArray(t)&&t.length){const r=[];return t.forEach(t=>{t&&r.push(e.$scope.file.deleteFile(t))}),Promise.all(r)}return{}}}(e),e.getUploadFileOptions=function(e){return async function({cloudPath:t=""}={}){return e.$scope.file.getUploadFileOptions({filePath:t})}}(e),e.getTempFileURL=async function({fileList:e}={}){if(!Array.isArray(e)||0===e.length)throw new i({code:"INVALID_PARAM",message:"fileList的元素必须是非空的字符串"});return{fileList:e.map(e=>({fileID:e,tempFileURL:e}))}},e.downloadFile=s("downloadFile")}const b=[],O={};class E extends class{constructor(e){Object.defineProperties(this,{target:{enumerable:!1,writable:!1,configurable:!1,value:e}})}}{constructor(e,t){if(t!==O)throw new TypeError("InternalSymbol cannot be constructed with new operator");super(e)}static for(e){for(let t=0,r=b.length;t<r;t++)if(b[t].target===e)return b[t].instance;const t=new E(e,O);return b.push({target:e,instance:t}),t}}const A=E.for("UNSET_FIELD_NAME"),N=E.for("UPDATE_COMMAND"),v=E.for("QUERY_COMMAND"),I=E.for("LOGIC_COMMAND"),S=E.for("GEO_POINT"),T=E.for("SYMBOL_GEO_LINE_STRING"),M=E.for("SYMBOL_GEO_POLYGON"),D=E.for("SYMBOL_GEO_MULTI_POINT"),L=E.for("SYMBOL_GEO_MULTI_LINE_STRING"),P=E.for("SYMBOL_GEO_MULTI_POLYGON"),$=E.for("SERVER_DATE"),x=E.for("REGEXP");var j;!function(e){e.SET="set",e.REMOVE="remove",e.INC="inc",e.MUL="mul",e.PUSH="push",e.PULL="pull",e.PULL_ALL="pullAll",e.POP="pop",e.SHIFT="shift",e.UNSHIFT="unshift",e.ADD_TO_SET="addToSet",e.BIT="bit",e.RENAME="rename",e.MAX="max",e.MIN="min"}(j||(j={}));class k{constructor(e,t,r){this._internalType=N,Object.defineProperties(this,{_internalType:{enumerable:!1,configurable:!1}}),this.operator=e,this.operands=t,this.fieldName=r||A}_setFieldName(e){return new k(this.operator,this.operands,e)}}function R(e){return e&&e instanceof k&&e._internalType===N}const C=e=>Object.prototype.toString.call(e).slice(8,-1).toLowerCase(),F=e=>"object"===C(e),q=e=>"number"===C(e),U=e=>Array.isArray(e),G=e=>"date"===C(e),V=e=>"regexp"===C(e),W=e=>e&&e._internalType instanceof E;var Q,H;!function(e){e.AND="and",e.OR="or",e.NOT="not",e.NOR="nor"}(Q||(Q={}));class B{constructor(e,t,r){if(this._internalType=I,Object.defineProperties(this,{_internalType:{enumerable:!1,configurable:!1}}),this.operator=e,this.operands=t,this.fieldName=r||A,this.fieldName!==A)if(Array.isArray(t)){t=t.slice(),this.operands=t;for(let e=0,r=t.length;e<r;e++){const r=t[e];(J(r)||Ee(r))&&(t[e]=r._setFieldName(this.fieldName))}}else{const e=t;(J(e)||Ee(e))&&(t=e._setFieldName(this.fieldName))}}_setFieldName(e){const t=this.operands.map(t=>t instanceof B?t._setFieldName(e):t);return new B(this.operator,t,e)}and(...e){const t=Array.isArray(arguments[0])?arguments[0]:Array.from(arguments);return t.unshift(this),new B(Q.AND,t,this.fieldName)}or(...e){const t=Array.isArray(arguments[0])?arguments[0]:Array.from(arguments);return t.unshift(this),new B(Q.OR,t,this.fieldName)}}function J(e){return e&&e instanceof B&&e._internalType===I}!function(e){e.DocIDError="文档ID不合法",e.CollNameError="集合名称不合法",e.OpStrError="操作符不合法",e.DirectionError="排序字符不合法",e.IntergerError="must be integer",e.QueryParamTypeError="查询参数必须为对象",e.QueryParamValueError="查询参数对象值不能均为undefined"}(H||(H={}));const z="Number",Y="Object",K="Array",X="GeoPoint",Z="GeoLineString",ee="GeoPolygon",te="GeoMultiPoint",re="GeoMultiLineString",ne="GeoMultiPolygon",ie="Date",oe="ServerDate",se="BsonDate",ae=["desc","asc"],ce=["<","<=","==",">=",">"];var le;!function(e){e.lt="<",e.gt=">",e.lte="<=",e.gte=">=",e.eq="=="}(le||(le={}));le.eq,le.lt,le.lte,le.gt,le.gte;var de;!function(e){e.WHERE="WHERE",e.DOC="DOC"}(de||(de={}));class ue{}ue.formatResDocumentData=e=>e.map(e=>ue.formatField(e)),ue.formatField=e=>{const t=Object.keys(e);let r={};return Array.isArray(e)&&(r=[]),t.forEach(t=>{const n=e[t];let i;switch(ue.whichType(n)){case X:i=new pe(n.coordinates[0],n.coordinates[1]);break;case Z:i=new fe(n.coordinates.map(e=>new pe(e[0],e[1])));break;case ee:i=new me(n.coordinates.map(e=>new fe(e.map(([e,t])=>new pe(e,t)))));break;case te:i=new we(n.coordinates.map(e=>new pe(e[0],e[1])));break;case re:i=new ge(n.coordinates.map(e=>new fe(e.map(([e,t])=>new pe(e,t)))));break;case ne:i=new ye(n.coordinates.map(e=>new me(e.map(e=>new fe(e.map(([e,t])=>new pe(e,t)))))));break;case ie:i=new Date(1e3*n.$timestamp);break;case Y:case K:i=ue.formatField(n);break;case oe:i=new Date(n.$date);break;default:i=n}Array.isArray(r)?r.push(i):r[t]=i}),r},ue.whichType=e=>{let t=Object.prototype.toString.call(e).slice(8,-1);if(t===ie)return se;if(t===Y){if(e instanceof pe)return X;if(e instanceof Date)return ie;if(e instanceof class{constructor({offset:e=0}={}){this.offset=e}get _internalType(){return $}parse(){return{$date:{offset:this.offset}}}})return oe;e.$timestamp?t=ie:e.$date?t=oe:pe.validate(e)?t=X:fe.validate(e)?t=Z:me.validate(e)?t=ee:we.validate(e)?t=te:ge.validate(e)?t=re:ye.validate(e)&&(t=ne)}return t},ue.generateDocId=()=>{let e="ABCDEFabcdef0123456789",t="";for(let r=0;r<24;r++)t+=e.charAt(Math.floor(Math.random()*e.length));return t};class he{static isGeopoint(e,t){if(ue.whichType(t)!==z)throw new Error("Geo Point must be number type");const r=Math.abs(t);if("latitude"===e&&r>90)throw new Error("latitude should be a number ranges from -90 to 90");if("longitude"===e&&r>180)throw new Error("longitude should be a number ranges from -180 to 180");return!0}static isInteger(e,t){if(!Number.isInteger(t))throw new Error(e+H.IntergerError);return!0}static isFieldOrder(e){if(-1===ae.indexOf(e))throw new Error(H.DirectionError);return!0}static isFieldPath(e){if(!/^[a-zA-Z0-9-_\.]/.test(e))throw new Error;return!0}static isOperator(e){if(-1===ce.indexOf(e))throw new Error(H.OpStrError);return!0}static isCollName(e){if(!/^[a-zA-Z0-9]([a-zA-Z0-9-_]){1,32}$/.test(e))throw new Error(H.CollNameError);return!0}static isDocID(e){if(!/^([a-fA-F0-9]){24}$/.test(e))throw new Error(H.DocIDError);return!0}}class pe{constructor(e,t){he.isGeopoint("longitude",e),he.isGeopoint("latitude",t),this.longitude=e,this.latitude=t}parse(e){return{[e]:{type:"Point",coordinates:[this.longitude,this.latitude]}}}toJSON(){return{type:"Point",coordinates:[this.longitude,this.latitude]}}toReadableString(){return`[${this.longitude},${this.latitude}]`}static validate(e){return"Point"===e.type&&U(e.coordinates)&&he.isGeopoint("longitude",e.coordinates[0])&&he.isGeopoint("latitude",e.coordinates[1])}get _internalType(){return S}}class fe{constructor(e){if(!U(e))throw new TypeError('"points" must be of type Point[]. Received type '+typeof e);if(e.length<2)throw new Error('"points" must contain 2 points at least');e.forEach(e=>{if(!(e instanceof pe))throw new TypeError(`"points" must be of type Point[]. Received type ${typeof e}[]`)}),this.points=e}parse(e){return{[e]:{type:"LineString",coordinates:this.points.map(e=>e.toJSON().coordinates)}}}toJSON(){return{type:"LineString",coordinates:this.points.map(e=>e.toJSON().coordinates)}}static validate(e){if("LineString"!==e.type||!U(e.coordinates))return!1;for(let t of e.coordinates)if(!q(t[0])||!q(t[1]))return!1;return!0}static isClosed(e){const t=e.points[0],r=e.points[e.points.length-1];if(t.latitude===r.latitude&&t.longitude===r.longitude)return!0}get _internalType(){return T}}class me{constructor(e){if(!U(e))throw new TypeError('"lines" must be of type LineString[]. Received type '+typeof e);if(0===e.length)throw new Error("Polygon must contain 1 linestring at least");e.forEach(e=>{if(!(e instanceof fe))throw new TypeError(`"lines" must be of type LineString[]. Received type ${typeof e}[]`);if(!fe.isClosed(e))throw new Error(`LineString ${e.points.map(e=>e.toReadableString())} is not a closed cycle`)}),this.lines=e}parse(e){return{[e]:{type:"Polygon",coordinates:this.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude]))}}}toJSON(){return{type:"Polygon",coordinates:this.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude]))}}static validate(e){if("Polygon"!==e.type||!U(e.coordinates))return!1;for(let t of e.coordinates){if(!this.isCloseLineString(t))return!1;for(let e of t)if(!q(e[0])||!q(e[1]))return!1}return!0}static isCloseLineString(e){const t=e[0],r=e[e.length-1];return t[0]===r[0]&&t[1]===r[1]}get _internalType(){return P}}class we{constructor(e){if(!U(e))throw new TypeError('"points" must be of type Point[]. Received type '+typeof e);if(0===e.length)throw new Error('"points" must contain 1 point at least');e.forEach(e=>{if(!(e instanceof pe))throw new TypeError(`"points" must be of type Point[]. Received type ${typeof e}[]`)}),this.points=e}parse(e){return{[e]:{type:"MultiPoint",coordinates:this.points.map(e=>e.toJSON().coordinates)}}}toJSON(){return{type:"MultiPoint",coordinates:this.points.map(e=>e.toJSON().coordinates)}}static validate(e){if("MultiPoint"!==e.type||!U(e.coordinates))return!1;for(let t of e.coordinates)if(!q(t[0])||!q(t[1]))return!1;return!0}get _internalType(){return D}}class ge{constructor(e){if(!U(e))throw new TypeError('"lines" must be of type LineString[]. Received type '+typeof e);if(0===e.length)throw new Error("Polygon must contain 1 linestring at least");e.forEach(e=>{if(!(e instanceof fe))throw new TypeError(`"lines" must be of type LineString[]. Received type ${typeof e}[]`)}),this.lines=e}parse(e){return{[e]:{type:"MultiLineString",coordinates:this.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude]))}}}toJSON(){return{type:"MultiLineString",coordinates:this.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude]))}}static validate(e){if("MultiLineString"!==e.type||!U(e.coordinates))return!1;for(let t of e.coordinates)for(let e of t)if(!q(e[0])||!q(e[1]))return!1;return!0}get _internalType(){return L}}class ye{constructor(e){if(!U(e))throw new TypeError('"polygons" must be of type Polygon[]. Received type '+typeof e);if(0===e.length)throw new Error("MultiPolygon must contain 1 polygon at least");for(let t of e)if(!(t instanceof me))throw new TypeError(`"polygon" must be of type Polygon[]. Received type ${typeof t}[]`);this.polygons=e}parse(e){return{[e]:{type:"MultiPolygon",coordinates:this.polygons.map(e=>e.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude])))}}}toJSON(){return{type:"MultiPolygon",coordinates:this.polygons.map(e=>e.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude])))}}static validate(e){if("MultiPolygon"!==e.type||!U(e.coordinates))return!1;for(let t of e.coordinates)for(let e of t)for(let t of e)if(!q(t[0])||!q(t[1]))return!1;return!0}get _internalType(){return M}}var _e,be=Object.freeze({__proto__:null,Point:pe,LineString:fe,Polygon:me,MultiPoint:we,MultiLineString:ge,MultiPolygon:ye});!function(e){e.EQ="eq",e.NEQ="neq",e.GT="gt",e.GTE="gte",e.LT="lt",e.LTE="lte",e.IN="in",e.NIN="nin",e.ALL="all",e.ELEM_MATCH="elemMatch",e.EXISTS="exists",e.SIZE="size",e.MOD="mod",e.GEO_NEAR="geoNear",e.GEO_WITHIN="geoWithin",e.GEO_INTERSECTS="geoIntersects"}(_e||(_e={}));class Oe extends B{constructor(e,t,r){super(e,t,r),this.operator=e,this._internalType=v}toJSON(){switch(this.operator){case _e.IN:case _e.NIN:return{["$"+this.operator]:this.operands};case _e.NEQ:return{$ne:this.operands[0]};default:return{["$"+this.operator]:this.operands[0]}}}_setFieldName(e){return new Oe(this.operator,this.operands,e)}eq(e){const t=new Oe(_e.EQ,[e],this.fieldName);return this.and(t)}neq(e){const t=new Oe(_e.NEQ,[e],this.fieldName);return this.and(t)}gt(e){const t=new Oe(_e.GT,[e],this.fieldName);return this.and(t)}gte(e){const t=new Oe(_e.GTE,[e],this.fieldName);return this.and(t)}lt(e){const t=new Oe(_e.LT,[e],this.fieldName);return this.and(t)}lte(e){const t=new Oe(_e.LTE,[e],this.fieldName);return this.and(t)}in(e){const t=new Oe(_e.IN,e,this.fieldName);return this.and(t)}nin(e){const t=new Oe(_e.NIN,e,this.fieldName);return this.and(t)}geoNear(e){if(!(e.geometry instanceof pe))throw new TypeError('"geometry" must be of type Point. Received type '+typeof e.geometry);if(void 0!==e.maxDistance&&!q(e.maxDistance))throw new TypeError('"maxDistance" must be of type Number. Received type '+typeof e.maxDistance);if(void 0!==e.minDistance&&!q(e.minDistance))throw new TypeError('"minDistance" must be of type Number. Received type '+typeof e.minDistance);const t=new Oe(_e.GEO_NEAR,[e],this.fieldName);return this.and(t)}geoWithin(e){if(!(e.geometry instanceof ye||e.geometry instanceof me))throw new TypeError('"geometry" must be of type Polygon or MultiPolygon. Received type '+typeof e.geometry);const t=new Oe(_e.GEO_WITHIN,[e],this.fieldName);return this.and(t)}geoIntersects(e){if(!(e.geometry instanceof pe||e.geometry instanceof fe||e.geometry instanceof me||e.geometry instanceof we||e.geometry instanceof ge||e.geometry instanceof ye))throw new TypeError('"geometry" must be of type Point, LineString, Polygon, MultiPoint, MultiLineString or MultiPolygon. Received type '+typeof e.geometry);const t=new Oe(_e.GEO_INTERSECTS,[e],this.fieldName);return this.and(t)}}function Ee(e){return e&&e instanceof Oe&&e._internalType===v}function Ae(e){return Ee(e)}const Ne={};for(const e in _e)Ne[e]="$"+e;for(const e in Q)Ne[e]="$"+e;for(const e in j)Ne[e]="$"+e;function ve(e){return Ne[e]||"$"+e}function Ie(e){return function e(t,r){if(!W(t)){if(G(t))return t;if(V(t))return{$regex:t.source,$options:t.flags};if(U(t))return t.map(t=>{if(r.indexOf(t)>-1)throw new Error("Cannot convert circular structure to JSON");return e(t,[...r,t])});if(F(t)){const n=Object.assign({},t);for(const t in n){if(r.indexOf(n[t])>-1)throw new Error("Cannot convert circular structure to JSON");n[t]=e(n[t],[...r,n[t]])}return n}return t}switch(t._internalType){case S:return t.toJSON();case $:case x:return t.parse();default:return t.toJSON?t.toJSON():t}}(e,[e])}function Se(e){return function e(t,r,n,i){const o=Object.assign({},t);for(const s in t){if(/^\$/.test(s))continue;const a=t[s];if(a&&(F(a)&&!r(a))){if(i.indexOf(a)>-1)throw new Error("Cannot convert circular structure to JSON");const t=e(a,r,[...n,s],[...i,a]);o[s]=t;let c=!1;for(const e in t)/^\$/.test(e)?c=!0:(o[`${s}.${e}`]=t[e],delete o[s][e]);c||delete o[s]}}return o}(e,Me,[],[e])}function Te(e,t,r){t[r]||delete e[r];for(const n in t)e[n]?U(e[n])?e[n].push(t[n]):F(e[n])?F(t[n])?Object.assign(e[n],t[n]):(console.warn(`unmergable condition, query is object but condition is ${C(t)}, can only overwrite`,t,r),e[n]=t[n]):(console.warn(`to-merge query is of type ${C(e)}, can only overwrite`,e,t,r),e[n]=t[n]):e[n]=t[n]}function Me(e){return W(e)||G(e)||V(e)}function De(e){return Ie(e)}Ne[_e.NEQ]="$ne",Ne[j.REMOVE]="$unset",Ne[j.SHIFT]="$pop",Ne[j.UNSHIFT]="$push";class Le{static encode(e){return(new Le).encodeUpdate(e)}encodeUpdate(e){return R(e)?this.encodeUpdateCommand(e):"object"===C(e)?this.encodeUpdateObject(e):e}encodeUpdateCommand(e){if(e.fieldName===A)throw new Error("Cannot encode a comparison command with unset field name");switch(e.operator){case j.PUSH:case j.PULL:case j.PULL_ALL:case j.POP:case j.SHIFT:case j.UNSHIFT:case j.ADD_TO_SET:return this.encodeArrayUpdateCommand(e);default:return this.encodeFieldUpdateCommand(e)}}encodeFieldUpdateCommand(e){const t=ve(e.operator);switch(e.operator){case j.REMOVE:return{[t]:{[e.fieldName]:""}};default:return{[t]:{[e.fieldName]:e.operands[0]}}}}encodeArrayUpdateCommand(e){const t=ve(e.operator);switch(e.operator){case j.PUSH:{let r;return r=U(e.operands)?{$each:e.operands.map(De)}:e.operands,{[t]:{[e.fieldName]:r}}}case j.UNSHIFT:{const r={$each:e.operands.map(De),$position:0};return{[t]:{[e.fieldName]:r}}}case j.POP:return{[t]:{[e.fieldName]:1}};case j.SHIFT:return{[t]:{[e.fieldName]:-1}};default:return{[t]:{[e.fieldName]:De(e.operands)}}}}encodeUpdateObject(e){const t=Se(e);for(const e in t){if(/^\$/.test(e))continue;let r=t[e];if(R(r)){t[e]=r._setFieldName(e);Te(t,this.encodeUpdateCommand(t[e]),e)}else{t[e]=r=De(r);const n=new k(j.SET,[r],e);Te(t,this.encodeUpdateCommand(n),e)}}return t}}function Pe(e){if(!u(e))return e;const t={};return Object.keys(e).forEach(r=>{"$"===r.charAt(0)?t[r]=e[r]:(t.$set=t.$set||{},t.$set[r]=e[r])}),t}function $e(e){return{id:e.result&&e.result.insertedId}}function xe(e){return{affectedDocs:e.affectedDocs,deleted:e.affectedDocs}}function je(e){return{affectedDocs:e.affectedDocs,updated:e.result.nModified,upserted:e.result.upserted}}function ke(e){let t=null;return e.result&&Array.isArray(e.result.upserted)&&1===e.result.upserted.length&&(t=e.result.upserted[0]._id),{affectedDocs:e.affectedDocs,updated:e.affectedDocs,upsertedId:t}}function Re(e){return{affectedDocs:e.affectedDocs,data:e.result}}function Ce(e){return{affectedDocs:e.affectedDocs,data:e.result}}function Fe(e){return{updated:e.affectedDocs,doc:e.result.value}}class qe{constructor(e,t){this._db=e,this._coll=t}insertOne(e){return a(this._db.collection(this._coll).insertOne(e),$e)}deleteOne(e){return a(this._db.collection(this._coll).deleteOne(e),xe)}replaceOne(e,t,r){return a(this._db.collection(this._coll).replaceOne(e,t,r),je)}updateOne(e,t,r){return t=Pe(t),a(this._db.collection(this._coll).updateOne(e,t,r),ke)}findOne(e,t){return a(this._db.collection(this._coll).findOne(e,t),Re)}findOneAndUpdate(e,t,r){return t=Pe(t),a(this._db.collection(this._coll).findOneAndUpdate(e,t,r),Fe,this._errorWrapper)}find(e,t){return a(this._db.collection(this._coll).find(e,t),Ce)}}class Ue{constructor(e,t,r,n={}){this.watch=s("watch"),this._db=e,this._coll=t,this.id=r,this.projection=n}create(e){return this.id&&(e._id=this.id),e=Ie(e),new qe(this._db,this._coll).insertOne(e)}set(e){if(!this.id)throw new i({code:"INVALID_PARAM",message:"docId不能为空"});if(!e||"object"!=typeof e)throw new i({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(d(e,"_id"))throw new i({code:"INVALID_PARAM",message:"不能更新_id的值"});let t=!1;const r=e=>{if("object"==typeof e)for(const n in e)e[n]instanceof k?t=!0:"object"==typeof e[n]&&r(e[n])};if(r(e),t)throw new i({code:"DATABASE_REQUEST_FAILED",message:"update operator complicit"});return new qe(this._db,this._coll).replaceOne({_id:this.id},Ie(e),{upsert:!0}).then(e=>(e.upserted?e.upsertedId=this.id:e.upsertedId=null,delete e.upserted,Promise.resolve(e)))}update(e){if(!e||"object"!=typeof e)throw new i({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(d(e,"_id"))throw new i({code:"INVALID_PARAM",message:"不能更新_id的值"});return new qe(this._db,this._coll).updateOne({_id:this.id},Le.encode(e))}updateAndReturn(e){if(!e||"object"!=typeof e)throw new i({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(d(e,"_id"))throw new i({code:"INVALID_PARAM",message:"不能更新_id的值"});return new qe(this._db,this._coll).findOneAndUpdate({_id:this.id},Le.encode(e),{returnNewDocument:!0})}remove(){return new qe(this._db,this._coll).deleteOne({_id:this.id})}get(){return new qe(this._db,this._coll).findOne({_id:this.id},{projection:this.projection})}field(e){for(const t in e)e[t]?e[t]=1:e[t]=0;return new Ue(this._db,this._coll,this.id,e)}}class Ge{static encode(e){return(new Ve).encodeQuery(e)}}class Ve{encodeQuery(e,t){return Me(e)?J(e)?this.encodeLogicCommand(e):Ee(e)?this.encodeQueryCommand(e):{[t]:this.encodeQueryObject(e)}:F(e)?this.encodeQueryObject(e):e}encodeRegExp(e){return{$regex:e.source,$options:e.flags}}encodeLogicCommand(e){switch(e.operator){case Q.NOR:case Q.AND:case Q.OR:return{[ve(e.operator)]:e.operands.map(t=>this.encodeQuery(t,e.fieldName))};case Q.NOT:{const t=ve(e.operator),r=e.operands[0];if(V(r))return{[e.fieldName]:{[t]:this.encodeRegExp(r)}};{const n=this.encodeQuery(r)[e.fieldName];return{[e.fieldName]:{[t]:n}}}}default:{const t=ve(e.operator);if(1===e.operands.length){return{[t]:this.encodeQuery(e.operands[0])}}return{[t]:e.operands.map(this.encodeQuery.bind(this))}}}}encodeQueryCommand(e){return Ae(e),this.encodeComparisonCommand(e)}encodeComparisonCommand(e){if(e.fieldName===A)throw new Error("Cannot encode a comparison command with unset field name");const t=ve(e.operator);switch(e.operator){case _e.EQ:case _e.NEQ:case _e.LT:case _e.LTE:case _e.GT:case _e.GTE:case _e.ELEM_MATCH:case _e.EXISTS:case _e.SIZE:case _e.MOD:return{[e.fieldName]:{[t]:De(e.operands[0])}};case _e.IN:case _e.NIN:case _e.ALL:return{[e.fieldName]:{[t]:De(e.operands)}};case _e.GEO_NEAR:{const t=e.operands[0];return{[e.fieldName]:{$nearSphere:{$geometry:t.geometry.toJSON(),$maxDistance:t.maxDistance,$minDistance:t.minDistance}}}}case _e.GEO_WITHIN:{const t=e.operands[0];return{[e.fieldName]:{$geoWithin:{$geometry:t.geometry.toJSON()}}}}case _e.GEO_INTERSECTS:{const t=e.operands[0];return{[e.fieldName]:{$geoIntersects:{$geometry:t.geometry.toJSON()}}}}default:return{[e.fieldName]:{[t]:De(e.operands[0])}}}}encodeQueryObject(e){const t=Se(e);for(const e in t){const r=t[e];if(J(r)){t[e]=r._setFieldName(e);const n=this.encodeLogicCommand(t[e]);this.mergeConditionAfterEncode(t,n,e)}else if(Ae(r)){t[e]=r._setFieldName(e);const n=this.encodeComparisonCommand(t[e]);this.mergeConditionAfterEncode(t,n,e)}else Me(r)&&(t[e]=De(r))}return t}mergeConditionAfterEncode(e,t,r){t[r]||delete e[r];for(const n in t)e[n]?U(e[n])?e[n]=e[n].concat(t[n]):F(e[n])?F(t[n])?Object.assign(e,t):(console.warn(`unmergable condition, query is object but condition is ${C(t)}, can only overwrite`,t,r),e[n]=t[n]):(console.warn(`to-merge query is of type ${C(e)}, can only overwrite`,e,t,r),e[n]=t[n]):e[n]=t[n]}}const We={asc:1,desc:-1};class Qe{constructor(e,t,r,n,i){this._db=e,this._coll=t,this._fieldFilters=r,this._fieldOrders=n||[],this._queryOptions=i||{}}get(){const e={};return this._fieldOrders.length&&(e.sort={},this._fieldOrders.forEach(t=>{Object.assign(e.sort,t)})),this._queryOptions.skip&&(e.skip=this._queryOptions.skip),this._queryOptions.limit?e.limit=this._queryOptions.limit<1e3?this._queryOptions.limit:1e3:e.limit=100,this._queryOptions.projection&&(e.projection=this._queryOptions.projection),new qe(this._db,this._coll).find(this._fieldFilters||{},e)}update(e){if(!e||"object"!=typeof e)throw new i({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(d(e,"_id"))throw new i({code:"INVALID_PARAM",message:"不能更新_id的值"});return new qe(this._db,this._coll).updateMany(this._fieldFilters||{},Le.encode(e))}updateAndReturn(e){if(!e||"object"!=typeof e)throw new i({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(d(e,"_id"))throw new i({code:"INVALID_PARAM",message:"不能更新_id的值"});return new qe(this._db,this._coll).findOneAndUpdate(this._fieldFilters||{},Le.encode(e),{returnNewDocument:!0})}remove(e){return Object.keys(this._queryOptions).length>0&&console.warn("`offset`, `limit` and `projection` are not supported in remove() operation"),this._fieldOrders.length>0&&console.warn("`orderBy` is not supported in remove() operation"),new qe(this._db,this._coll).deleteMany(this._fieldFilters||{})}count(){return new qe(this._db,this._coll).count(this._fieldFilters||{})}where(e){if(!u(e))throw Error(H.QueryParamTypeError);const t=Object.keys(e),r=t.some(t=>void 0!==e[t]);if(t.length&&!r)throw Error(H.QueryParamValueError);return new Qe(this._db,this._coll,Ge.encode(e),this._fieldOrders,this._queryOptions)}orderBy(e,t){he.isFieldPath(e),he.isFieldOrder(t);const r={};r[e]=We[t];const n=this._fieldOrders.concat([r]);return new Qe(this._db,this._coll,this._fieldFilters,n,this._queryOptions)}limit(e){he.isInteger("limit",e);const t={...this._queryOptions};return t.limit=e,new Qe(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}skip(e){he.isInteger("offset",e);const t={...this._queryOptions};return t.skip=e,new Qe(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}field(e){for(const t in e)e[t]?"object"!=typeof e[t]&&(e[t]=1):e[t]=0;const t={...this._queryOptions};return t.projection=e,new Qe(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}watch(e){throw Error(H.WatchError)}}class He extends Qe{get name(){return this._coll}doc(e){if("string"!=typeof e&&"number"!=typeof e)throw new Error("docId必须为字符串或数字");return new Ue(this._db,this._coll,e)}add(e){const t=new Ue(this._db,this._coll,void 0);return Array.isArray(e)?t.createMany(e):t.create(e)}}class Be{constructor(e,t){this._transaction=e,this.config=t}collection(e){if(!e)throw new Error("Collection name is required");return new He(this._transaction,e)}commit(){return this._transaction.commit()}rollback(){return this._transaction.rollback()}}function Je(e){if(!u(e))return e;const t={};return Object.keys(e).forEach(r=>{"$"===r.charAt(0)?t[r]=e[r]:(t.$set=t.$set||{},t.$set[r]=e[r])}),t}function ze(e){return{id:e.result&&e.result.insertedId}}function Ye(e){const t=[];return Object.keys(e.result).sort().forEach(r=>{t.push(e.result[r])}),{inserted:e.affectedDocs,result:e.result,ids:t}}function Ke(e){return{affectedDocs:e.affectedDocs,deleted:e.affectedDocs}}function Xe(e){return{affectedDocs:e.affectedDocs,deleted:e.affectedDocs}}function Ze(e){return{affectedDocs:e.affectedDocs,updated:e.result.nModified,upserted:e.result.upserted}}function et(e){let t=null;return e.result&&Array.isArray(e.result.upserted)&&1===e.result.upserted.length&&(t=e.result.upserted[0]._id),{affectedDocs:e.affectedDocs,updated:e.affectedDocs,upsertedId:t}}function tt(e){return{affectedDocs:e.affectedDocs,updated:e.affectedDocs}}function rt(e){return{updated:e.affectedDocs,doc:e.result.value}}function nt(e){const t=[];return e.result&&t.push(e.result),{affectedDocs:e.affectedDocs,data:t}}function it(e){return{affectedDocs:e.affectedDocs,data:e.result}}function ot(e){return{affectedDocs:e.affectedDocs,total:e.result}}function st(e){return{affectedDocs:e.affectedDocs,data:e.result}}class at{constructor(e,t){this._coll=t,this._errorWrapper=y({collName:t})}get _db(){return global.uniCloud.$scope.db}insertOne(e){return a(this._db.collection(this._coll).insertOne(e),ze,this._errorWrapper)}insertMany(e){return a(this._db.collection(this._coll).insertMany(e),Ye,this._errorWrapper)}deleteOne(e){return a(this._db.collection(this._coll).deleteOne(e),Ke,this._errorWrapper)}deleteMany(e){return a(this._db.collection(this._coll).deleteMany(e),Xe,this._errorWrapper)}replaceOne(e,t,r){return a(this._db.collection(this._coll).replaceOne(e,t,r),Ze,this._errorWrapper)}updateOne(e,t,r){return t=Je(t),a(this._db.collection(this._coll).updateOne(e,t,r),et,this._errorWrapper)}updateMany(e,t,r){return t=Je(t),a(this._db.collection(this._coll).updateMany(e,t,r),tt,this._errorWrapper)}findOneAndUpdate(e,t,r){return t=Je(t),a(this._db.collection(this._coll).findOneAndUpdate(e,t,r),rt,this._errorWrapper)}findOne(e,t){return a(this._db.collection(this._coll).findOne(e,t),nt,this._errorWrapper)}find(e,t){return a(this._db.collection(this._coll).find(e,t),it,this._errorWrapper)}count(e,t){return a(this._db.collection(this._coll).count(e,t),ot,this._errorWrapper)}aggregate(e){return a(this._db.collection(this._coll).aggregate(e),st,this._errorWrapper)}}class ct{constructor(e,t){this._stages=[],e&&t&&(this._db=e,this._coll=t)}end(){if(!this._coll||!this._db)throw new Error("Aggregation pipeline cannot send request");return new at(this._db,this._coll).aggregate(this.done())}unwrap(){return this._stages}done(){return this._stages.map(({stageKey:e,stageValue:t})=>({[e]:JSON.parse(t)}))}_pipe(e,t){return this._stages.push({stageKey:"$"+e,stageValue:JSON.stringify(t)}),this}addFields(e){return this._pipe("addFields",e)}bucket(e){return this._pipe("bucket",e)}bucketAuto(e){return this._pipe("bucketAuto",e)}count(e){return this._pipe("count",e)}geoNear(e){return e.query&&(e.query=Ge.encode(e.query)),this._pipe("geoNear",e)}group(e){return this._pipe("group",e)}limit(e){return this._pipe("limit",e)}match(e){return this._pipe("match",Ge.encode(e))}project(e){return this._pipe("project",e)}lookup(e){return this._pipe("lookup",e)}replaceRoot(e){return this._pipe("replaceRoot",e)}sample(e){return this._pipe("sample",e)}skip(e){return this._pipe("skip",e)}sort(e){return this._pipe("sort",e)}sortByCount(e){return this._pipe("sortByCount",e)}unwind(e){return this._pipe("unwind",e)}}const lt={eq:e=>new Oe(_e.EQ,[e]),neq:e=>new Oe(_e.NEQ,[e]),lt:e=>new Oe(_e.LT,[e]),lte:e=>new Oe(_e.LTE,[e]),gt:e=>new Oe(_e.GT,[e]),gte:e=>new Oe(_e.GTE,[e]),in:e=>new Oe(_e.IN,e),nin:e=>new Oe(_e.NIN,e),all:e=>new Oe(_e.ALL,e),elemMatch:e=>new Oe(_e.ELEM_MATCH,[e]),exists:e=>new Oe(_e.EXISTS,[e]),size:e=>new Oe(_e.SIZE,[e]),mod:e=>new Oe(_e.MOD,[e]),geoNear:e=>new Oe(_e.GEO_NEAR,[e]),geoWithin:e=>new Oe(_e.GEO_WITHIN,[e]),geoIntersects:e=>new Oe(_e.GEO_INTERSECTS,[e]),and(...e){const t=U(arguments[0])?arguments[0]:Array.from(arguments);return new B(Q.AND,t)},nor(...e){const t=U(arguments[0])?arguments[0]:Array.from(arguments);return new B(Q.NOR,t)},or(...e){const t=U(arguments[0])?arguments[0]:Array.from(arguments);return new B(Q.OR,t)},not(...e){const t=U(arguments[0])?arguments[0]:Array.from(arguments);return new B(Q.NOT,t)},set:e=>new k(j.SET,[e]),remove:()=>new k(j.REMOVE,[]),inc:e=>new k(j.INC,[e]),mul:e=>new k(j.MUL,[e]),push(...e){let t;if(F(e[0])&&e[0].hasOwnProperty("each")){const r=e[0];t={$each:r.each,$position:r.position,$sort:r.sort,$slice:r.slice}}else t=U(e[0])?e[0]:Array.from(e);return new k(j.PUSH,t)},pull:e=>new k(j.PULL,e),pullAll:e=>new k(j.PULL_ALL,e),pop:()=>new k(j.POP,[]),shift:()=>new k(j.SHIFT,[]),unshift(...e){const t=U(arguments[0])?arguments[0]:Array.from(arguments);return new k(j.UNSHIFT,t)},addToSet:e=>new k(j.ADD_TO_SET,e),rename:e=>new k(j.RENAME,[e]),bit:e=>new k(j.BIT,[e]),max:e=>new k(j.MAX,[e]),min:e=>new k(j.MIN,[e]),expr:e=>({$expr:e}),jsonSchema:e=>({$jsonSchema:e}),text:e=>"string"===C(e)?{$search:e.search}:{$search:e.search,$language:e.language,$caseSensitive:e.caseSensitive,$diacriticSensitive:e.diacriticSensitive},aggregate:{pipeline:()=>new ct,abs:e=>new dt("abs",e),add:e=>new dt("add",e),ceil:e=>new dt("ceil",e),divide:e=>new dt("divide",e),exp:e=>new dt("exp",e),floor:e=>new dt("floor",e),ln:e=>new dt("ln",e),log:e=>new dt("log",e),log10:e=>new dt("log10",e),mod:e=>new dt("mod",e),multiply:e=>new dt("multiply",e),pow:e=>new dt("pow",e),sqrt:e=>new dt("sqrt",e),subtract:e=>new dt("subtract",e),trunc:e=>new dt("trunc",e),arrayElemAt:e=>new dt("arrayElemAt",e),arrayToObject:e=>new dt("arrayToObject",e),concatArrays:e=>new dt("concatArrays",e),filter:e=>new dt("filter",e),in:e=>new dt("in",e),indexOfArray:e=>new dt("indexOfArray",e),isArray:e=>new dt("isArray",e),map:e=>new dt("map",e),range:e=>new dt("range",e),reduce:e=>new dt("reduce",e),reverseArray:e=>new dt("reverseArray",e),size:e=>new dt("size",e),slice:e=>new dt("slice",e),zip:e=>new dt("zip",e),and:e=>new dt("and",e),not:e=>new dt("not",e),or:e=>new dt("or",e),cmp:e=>new dt("cmp",e),eq:e=>new dt("eq",e),gt:e=>new dt("gt",e),gte:e=>new dt("gte",e),lt:e=>new dt("lt",e),lte:e=>new dt("lte",e),neq:e=>new dt("ne",e),cond:e=>new dt("cond",e),ifNull:e=>new dt("ifNull",e),switch:e=>new dt("switch",e),dateFromParts:e=>new dt("dateFromParts",e),dateFromString:e=>new dt("dateFromString",e),dayOfMonth:e=>new dt("dayOfMonth",e),dayOfWeek:e=>new dt("dayOfWeek",e),dayOfYear:e=>new dt("dayOfYear",e),isoDayOfWeek:e=>new dt("isoDayOfWeek",e),isoWeek:e=>new dt("isoWeek",e),isoWeekYear:e=>new dt("isoWeekYear",e),millisecond:e=>new dt("millisecond",e),minute:e=>new dt("minute",e),month:e=>new dt("month",e),second:e=>new dt("second",e),hour:e=>new dt("hour",e),week:e=>new dt("week",e),year:e=>new dt("year",e),literal:e=>new dt("literal",e),mergeObjects:e=>new dt("mergeObjects",e),objectToArray:e=>new dt("objectToArray",e),allElementsTrue:e=>new dt("allElementsTrue",e),anyElementTrue:e=>new dt("anyElementTrue",e),setDifference:e=>new dt("setDifference",e),setEquals:e=>new dt("setEquals",e),setIntersection:e=>new dt("setIntersection",e),setIsSubset:e=>new dt("setIsSubset",e),setUnion:e=>new dt("setUnion",e),concat:e=>new dt("concat",e),dateToString:e=>new dt("dateToString",e),indexOfBytes:e=>new dt("indexOfBytes",e),indexOfCP:e=>new dt("indexOfCP",e),split:e=>new dt("split",e),strLenBytes:e=>new dt("strLenBytes",e),strLenCP:e=>new dt("strLenCP",e),strcasecmp:e=>new dt("strcasecmp",e),substr:e=>new dt("substr",e),substrBytes:e=>new dt("substrBytes",e),substrCP:e=>new dt("substrCP",e),toLower:e=>new dt("toLower",e),toUpper:e=>new dt("toUpper",e),meta:e=>new dt("meta",e),addToSet:e=>new dt("addToSet",e),avg:e=>new dt("avg",e),first:e=>new dt("first",e),last:e=>new dt("last",e),max:e=>new dt("max",e),min:e=>new dt("min",e),push:e=>new dt("push",e),stdDevPop:e=>new dt("stdDevPop",e),stdDevSamp:e=>new dt("stdDevSamp",e),sum:e=>new dt("sum",e),let:e=>new dt("let",e)},project:{slice:e=>new ut("slice",e),elemMatch:e=>new ut("elemMatch",e)}};class dt{constructor(e,t){this["$"+e]=t}}class ut{constructor(e,t){this["$"+e]=t}}class ht{constructor(e,t,r,n={}){this.watch=s("watch"),this._db=e,this._coll=t,this.id=r,this.projection=n}create(e){return this.id&&(e._id=this.id),e=Ie(e),new at(this._db,this._coll).insertOne(e)}createMany(e){return e=Ie(e),new at(this._db,this._coll).insertMany(e)}set(e){if(!this.id)throw new i({code:"INVALID_PARAM",message:"docId不能为空"});if(!e||"object"!=typeof e)throw new i({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(d(e,"_id"))throw new i({code:"INVALID_PARAM",message:"不能更新_id的值"});let t=!1;const r=e=>{if("object"==typeof e)for(const n in e)e[n]instanceof k?t=!0:"object"==typeof e[n]&&r(e[n])};if(r(e),t)throw new i({code:"DATABASE_REQUEST_FAILED",message:"update operator complicit"});return new at(this._db,this._coll).replaceOne({_id:this.id},Ie(e),{upsert:!0}).then(e=>(e.upserted?e.upsertedId=this.id:e.upsertedId=null,delete e.upserted,Promise.resolve(e)))}update(e){if(!e||"object"!=typeof e)throw new i({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(d(e,"_id"))throw new i({code:"INVALID_PARAM",message:"不能更新_id的值"});return new at(this._db,this._coll).updateOne({_id:this.id},Le.encode(e))}updateAndReturn(e){if(!e||"object"!=typeof e)throw new i({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(d(e,"_id"))throw new i({code:"INVALID_PARAM",message:"不能更新_id的值"});return new at(this._db,this._coll).findOneAndUpdate({_id:this.id},Le.encode(e),{returnNewDocument:!0})}remove(){return new at(this._db,this._coll).deleteOne({_id:this.id})}get(){return new at(this._db,this._coll).findOne({_id:this.id},{projection:this.projection})}field(e){for(const t in e)e[t]?e[t]=1:e[t]=0;return new ht(this._db,this._coll,this.id,e)}}const pt={asc:1,desc:-1};class ft{constructor(e,t,r,n,i){this._db=e,this._coll=t,this._fieldFilters=r,this._fieldOrders=n||[],this._queryOptions=i||{}}get(){const e={};return this._fieldOrders.length&&(e.sort={},this._fieldOrders.forEach(t=>{Object.assign(e.sort,t)})),this._queryOptions.skip&&(e.skip=this._queryOptions.skip),this._queryOptions.limit?e.limit=this._queryOptions.limit<1e3?this._queryOptions.limit:1e3:e.limit=100,this._queryOptions.projection&&(e.projection=this._queryOptions.projection),new at(this._db,this._coll).find(this._fieldFilters||{},e)}update(e){if(!e||"object"!=typeof e)throw new i({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(d(e,"_id"))throw new i({code:"INVALID_PARAM",message:"不能更新_id的值"});return new at(this._db,this._coll).updateMany(this._fieldFilters||{},Le.encode(e))}updateAndReturn(e){if(!e||"object"!=typeof e)throw new i({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(d(e,"_id"))throw new i({code:"INVALID_PARAM",message:"不能更新_id的值"});return new at(this._db,this._coll).findOneAndUpdate(this._fieldFilters||{},Le.encode(e),{returnNewDocument:!0})}remove(e){return Object.keys(this._queryOptions).length>0&&console.warn("`offset`, `limit` and `projection` are not supported in remove() operation"),this._fieldOrders.length>0&&console.warn("`orderBy` is not supported in remove() operation"),new at(this._db,this._coll).deleteMany(this._fieldFilters||{})}count(){return new at(this._db,this._coll).count(this._fieldFilters||{})}where(e){if(!u(e))throw Error(H.QueryParamTypeError);const t=Object.keys(e),r=t.some(t=>void 0!==e[t]);if(t.length&&!r)throw Error(H.QueryParamValueError);return new ft(this._db,this._coll,Ge.encode(e),this._fieldOrders,this._queryOptions)}orderBy(e,t){he.isFieldPath(e),he.isFieldOrder(t);const r={};r[e]=pt[t];const n=this._fieldOrders.concat([r]);return new ft(this._db,this._coll,this._fieldFilters,n,this._queryOptions)}limit(e){he.isInteger("limit",e);const t={...this._queryOptions};return t.limit=e,new ft(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}skip(e){he.isInteger("offset",e);const t={...this._queryOptions};return t.skip=e,new ft(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}field(e){for(const t in e)e[t]?"object"!=typeof e[t]&&(e[t]=1):e[t]=0;const t={...this._queryOptions};return t.projection=e,new ft(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}watch(e){throw Error(H.WatchError)}}class mt extends ft{get name(){return this._coll}doc(e){if("string"!=typeof e&&"number"!=typeof e)throw new Error("docId必须为字符串或数字");return new ht(this._db,this._coll,e)}add(e){const t=new ht(this._db,this._coll,void 0);return Array.isArray(e)?t.createMany(e):t.create(e)}aggregate(){return new ct(this._db,this._coll)}}const wt=s("createCollection"),gt=s("serverDate"),yt=s("runTransaction");class _t{constructor(e,t){this._db=e,this.config=t,this.Geo=be,this.command=lt}get _latestDB(){return global.uniCloud.$scope.db}get serverDate(){return gt()}get RegExp(){return class{constructor({regex:e,options:t}){return new RegExp(e,t)}}}collection(e){if(!e)throw new Error("Collection name is required");return new mt(this._db,e)}createCollection(e){return wt(e)}async startTransaction(){const e=await(this._latestDB||this._db).startTransaction();return new Be(e,this.config)}runTransaction(){return yt()}}async function bt(e={}){const t=e.appid||global.__ctx__.APPID||void 0,r=global.__ctx__.SPACEINFO.spaceId,o={aliyun:"aliyun",tencent:"tcb"}[global.__ctx__.SPACEINFO.provider],{apiKey:s,apiSecret:a,access_token:c,openid:l}=e,d={token:c,openid:l,appid:t,spaceId:r,provider:o,apiKey:s};for(const e in d)void 0===d[e]&&delete d[e];const u=Object.keys(d).sort().map(e=>`${e}=${""+d[e]}`);u.push("apiSecret="+a);const h=n.createHash("md5");h.update(u.join("&"));const p=h.digest("hex").toLowerCase();let f;try{f=await uniCloud.httpclient.request("https://c2c84d41-a90b-40ed-83e2-025e60889a78.bspapp.com/http/get-mobile-space",{data:{...d,sign:p},dataAsQueryString:!0,dataType:"json",timeout:3e4})}catch(e){f={}}if(f&&f.status>=400)try{f=await uniCloud.httpclient.request("https://hbonshoregewslogypti.dcloud.net.cn/get-mobile-space",{data:{...d,sign:p},dataAsQueryString:!0,dataType:"json",timeout:3e4})}catch(e){f={}}if(f&&f.data){if(0===f.data.ret)return{code:0,success:!0,phoneNumber:f.data.data.mobile};throw 4002===f.data.ret?new i({code:4002,message:"获取手机号码失败：请检查密钥是否正确"}):new i({code:f.data.ret||5e3,message:"获取手机号码失败："+f.data.desc})}throw new i({code:5e3,message:"获取手机号码失败"})}async function Ot(e){const t={univerify:bt},{provider:r}=e;let n;switch(r){case"univerify":n={access_token:["string"],openid:["string"],apiKey:["string"],apiSecret:["string"]};break;case void 0:throw new i({code:1001,message:"getPhoneNumber缺少参数provider"});default:throw new i({code:1001,message:"getPhoneNumber不支持provider:"+r})}try{f({param:e,rule:n,errTpl:"getPhoneNumber%err%"})}catch(e){throw new i({code:1001,message:e.message})}return await t[r](e)}const Et={uniID_code:["name","code","action","expMinute"],uni_verify_code:["name","code","action","expMinute"],uni_order_unpaid:["name","orderNo","minute"],uni_booking:["name","service","dateTime","notice"],uni_order_shipped:["name","orderNo","expressCompany","expressNo"]},At={name:{rule:/^[\s\S]{1,15}$/,msg:"data.name长度限制为1-15位"},code:{rule:/^[\d|\w|\W]{1,6}$/,msg:"data.code只支持数字和大小写字母，长度不可超过6位"},action:{rule:/^[\s\S]{1,6}$/,msg:"data.action长度限制为1-6位"},expMinute:{rule:/^\d{1,2}$/,msg:"data.expMinute需为正整数字符串，长度不可超过2位"},time:{rule:/^\d{1,2}$/,msg:"data.time需为正整数字符串，长度不可超过2位"},orderNo:{rule:/^[\s\S]{1,20}$/,msg:"data.orderNo长度限制为1-20位"},minute:{rule:/^\d{1,2}$/,msg:"data.minute需为正整数字符串，长度不可超过2位"},service:{rule:/^[\s\S]{1,10}$/,msg:"data.service长度限制为1-10位"},dateTime:{rule:/^[\s\S]{1,18}$/,msg:"data.dateTime长度限制为1-18位"},notice:{rule:/^[\s\S]{1,20}$/,msg:"data.notice长度限制为1-20位"},expressCompany:{rule:/^[\s\S]{1,12}$/,msg:"data.expressCompany长度限制为1-12位"},expressNo:{rule:/^[\s\S]{1,20}$/,msg:"data.expressNo长度限制为1-20位"}};async function Nt(e){const t={smsKey:["string"],smsSecret:["string"],templateId:["string"],phone:["string"],data:["object"]};try{f({param:e,rule:t,errTpl:"sendSms%err%"})}catch(e){throw new i({code:1001,message:e.message})}const r=e.appid||global.__ctx__.APPID||void 0,o=global.__ctx__.SPACEINFO.spaceId,s={aliyun:"aliyun",tencent:"tcb"}[global.__ctx__.SPACEINFO.provider],a=""+Date.now(),{smsKey:c,smsSecret:l,templateId:d,phone:u,data:h}=e;if(Et[d]){if(!/^(0|17951|86|\+86)?(1\d{10})$/.test(u))throw new i({code:1001,message:"手机号格式不正确，仅支持中国大陆手机号"});const e=Et[d],t=Object.keys(h);t.forEach(t=>{if(-1===e.indexOf(t))throw new i({code:1001,message:`模板${d}不可使用参数data.${t}`})}),e.forEach(e=>{if(-1===t.indexOf(e))throw new i({code:1001,message:`模板${d}缺少参数data.${e}`})}),e.forEach(e=>{if(!At[e].rule.test(h[e]))throw new i({code:1001,message:At[e].msg})}),h.expMinute&&(h.time=h.expMinute,delete h.expMinute)}const p=Object.keys(h).reduce((e,t)=>e+=h[t],"");if(/【|】/.test(p))throw new i({code:1001,message:"为避免与签名混淆，短信内容不可包含“【】”符号"});let m;/(测试|test)/i.test(p)&&console.warn("短信内容包含“测试”、“test”字样时，系统可能会被判定为测试用途，不会真正把短信下发到对应手机（此行为由运营商控制，可能真实发送，也可能不发送）"),m=Et[d]?Object.assign({appid:r,apiKey:c,templateId:d,timestamp:a,phone:u,spaceId:o,provider:s},h):{appid:r,apiKey:c,templateId:d,timestamp:a,phone:u,spaceId:o,provider:s,params:JSON.stringify(h)};for(const e in m)void 0===m[e]&&delete m[e];const w=Object.keys(m).sort().map(e=>`${e}=${""+m[e]}`);w.push("apiSecret="+l);const g=n.createHash("md5");g.update(w.join("&"));const y=g.digest("hex").toLowerCase();let _;try{_=await uniCloud.httpclient.request("https://c2c84d41-a90b-40ed-83e2-025e60889a78.bspapp.com/http/send-sms-space",{data:{...m,sign:y},dataAsQueryString:!0,dataType:"json",timeout:3e4})}catch(e){_={}}if(_&&_.status>=400)try{_=await uniCloud.httpclient.request("https://hbonshoregewslogypti.dcloud.net.cn/send-sms-space",{data:{...m,sign:y},dataAsQueryString:!0,dataType:"json",timeout:3e4})}catch(e){_={}}if(_&&_.data){if(0===_.data.ret)return{code:0,errCode:0,success:!0};throw 4002===_.data.ret?new i({code:4002,message:"短信发送失败：请检查密钥是否正确"}):new i({code:_.data.ret||5e3,message:"短信发送失败："+_.data.desc})}throw new i({code:5e3,message:"短信发送失败"})}const vt=/^(?:\d)+/,It=/^(?:\w)+/;const St=Object.prototype.hasOwnProperty,Tt=new class{constructor(){this._caches=Object.create(null)}interpolate(e,t){if(!t)return[e];let r=this._caches[e];return r||(r=function(e){const t=[];let r=0,n="";for(;r<e.length;){let i=e[r++];if("{"===i){n&&t.push({type:"text",value:n}),n="";let o="";for(i=e[r++];void 0!==i&&"}"!==i;)o+=i,i=e[r++];const s="}"===i,a=vt.test(o)?"list":s&&It.test(o)?"named":"unknown";t.push({value:o,type:a})}else"%"===i?"{"!==e[r]&&(n+=i):n+=i}return n&&t.push({type:"text",value:n}),t}(e),this._caches[e]=r),function(e,t){const r=[];let n=0;const i=Array.isArray(t)?"list":(o=t,null!==o&&"object"==typeof o?"named":"unknown");var o;if("unknown"===i)return r;for(;n<e.length;){const o=e[n];switch(o.type){case"text":r.push(o.value);break;case"list":r.push(t[parseInt(o.value,10)]);break;case"named":"named"===i&&r.push(t[o.value])}n++}return r}(r,t)}};function Mt(e,t){if(!e)return;if(t[e=e.trim().replace(/_/g,"-")])return e;if(0===(e=e.toLowerCase()).indexOf("zh"))return-1!==e.indexOf("-hans")?"zh-Hans":-1!==e.indexOf("-hant")?"zh-Hant":(r=e,["-tw","-hk","-mo","-cht"].find(e=>-1!==r.indexOf(e))?"zh-Hant":"zh-Hans");var r;const n=function(e,t){return t.find(t=>0===e.indexOf(t))}(e,["en","fr","es"]);return n||void 0}class Dt{constructor({locale:e,fallbackLocale:t,messages:r,watcher:n,formater:i}){this.locale="en",this.fallbackLocale="en",this.message={},this.messages={},this.watchers=[],t&&(this.fallbackLocale=t),this.formater=i||Tt,this.messages=r,this.setLocale(e),n&&this.watchLocale(n)}setLocale(e){const t=this.locale;this.locale=Mt(e,this.messages)||this.fallbackLocale,this.message=this.messages[this.locale],this.watchers.forEach(e=>{e(this.locale,t)})}getLocale(){return this.locale}watchLocale(e){const t=this.watchers.push(e)-1;return()=>{this.watchers.splice(t,1)}}t(e,t,r){let n=this.message;return"string"==typeof t?(t=Mt(t,this.messages))&&(n=this.messages[t]):r=t,((e,t)=>St.call(e,t))(n,e)?this.formater.interpolate(n[e],r).join(""):(console.warn(`Cannot translate the value of keypath ${e}. Use the value of keypath as default.`),e)}}function Lt({locale:e,fallbackLocale:t,messages:r}){return new Dt({locale:e,fallbackLocale:t,messages:r})}var Pt={email:/^\S+?@\S+?\.\S+?$/,idcard:/^[1-9]\d{5}(18|19|([23]\d))\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$/,url:new RegExp("^(?!mailto:)(?:(?:http|https|ftp)://|//)(?:\\S+(?::\\S*)?@)?(?:(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[0-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-*)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-*)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))|localhost)(?::\\d{2,5})?(?:(/|\\?|#)[^\\s]*)?$","i")};const $t={int:"integer",bool:"boolean",double:"number",long:"number",password:"string"};function xt(e,t=""){["label"].forEach(t=>{void 0===e[t]&&(e[t]="")});let r=t;for(const t in e){const n=new RegExp("{"+t+"}");r=r.replace(n,e[t])}return r}const jt={integer:e=>jt.number(e)&&parseInt(e,10)===e,string:e=>"string"==typeof e,number:e=>!isNaN(e)&&"number"==typeof e,boolean:function(e){return"boolean"==typeof e},float:function(e){return jt.number(e)&&!jt.integer(e)},array:e=>Array.isArray(e),object:e=>"object"==typeof e&&!jt.array(e),date:e=>e instanceof Date,timestamp(e){return!(!this.integer(e)||Math.abs(e).toString().length>16)},file:e=>"string"==typeof e.url,email:e=>"string"==typeof e&&!!e.match(Pt.email)&&e.length<255,url:e=>"string"==typeof e&&!!e.match(Pt.url),pattern(e,t){try{return new RegExp(e).test(t)}catch(e){return!1}},method:e=>"function"==typeof e,idcard:e=>"string"==typeof e&&!!e.match(Pt.idcard),"url-https"(e){return this.url(e)&&e.startsWith("https://")},"url-scheme":e=>e.startsWith("://")};const kt={required:(e,t,r)=>e.required&&function(e,t){return null==e||("string"==typeof e&&!e||(!(!Array.isArray(e)||e.length)||"object"===t&&!Object.keys(e).length))}(t,e.format||typeof t)?xt(e,e.errorMessage||r.required):null,range(e,t,r){const{range:n,errorMessage:i}=e,o=new Array(n.length);for(let e=0;e<n.length;e++){const t=n[e];jt.object(t)&&void 0!==t.value?o[e]=t.value:o[e]=t}let s=!1;return Array.isArray(t)?s=new Set(t.concat(o)).size===o.length:o.indexOf(t)>-1&&(s=!0),s?null:xt(e,i||r.enum)},rangeNumber(e,t,r){if(!jt.number(t))return xt(e,e.errorMessage||r.pattern.mismatch);const{minimum:n,maximum:i,exclusiveMinimum:o,exclusiveMaximum:s}=e,a=o?t<=n:t<n,c=s?t>=i:t>i;return void 0!==n&&a?xt(e,e.errorMessage||r.number[o?"exclusiveMinimum":"minimum"]):void 0!==i&&c?xt(e,e.errorMessage||r.number[s?"exclusiveMaximum":"maximum"]):void 0!==n&&void 0!==i&&(a||c)?xt(e,e.errorMessage||r.number.range):null},rangeLength(e,t,r){if(!jt.string(t)&&!jt.array(t))return xt(e,e.errorMessage||r.pattern.mismatch);const n=e.minLength,i=e.maxLength,o=t.length;return void 0!==n&&o<n?xt(e,e.errorMessage||r.length.minLength):void 0!==i&&o>i?xt(e,e.errorMessage||r.length.maxLength):void 0!==n&&void 0!==i&&(o<n||o>i)?xt(e,e.errorMessage||r.length.range):null},pattern:(e,t,r)=>jt.pattern(e.pattern,t)?null:xt(e,e.errorMessage||r.pattern.mismatch),format(e,t,r){var n=Object.keys(jt),i=$t[e.format]?$t[e.format]:e.format||e.arrayType;return n.indexOf(i)>-1&&!jt[i](t)?xt(e,e.errorMessage||r.typeError):null},arrayTypeFormat(e,t,r){if(!Array.isArray(t))return xt(e,e.errorMessage||r.typeError);for(let n=0;n<t.length;n++){const i=t[n],o=this.format(e,i,r);if(null!==o)return o}return null}};class Rt extends class{constructor(e){this._message=e}async validateRule(e,t,r,n,i){var o=null;const s=t.rules;if(s.findIndex(e=>e.required)<0){if(null==r)return o;if("string"==typeof r&&!r.length)return o}var a=this._message;if(void 0===s)return a.default;for(var c=0;c<s.length;c++){const l=s[c],d=this._getValidateType(l);if(Object.assign(l,{label:t.label||`["${e}"]`}),kt[d]&&null!=(o=kt[d](l,r,a)))break;if(l.validateExpr){const e=Date.now();if(!1===l.validateExpr(r,i,e)){o=this._getMessage(l,l.errorMessage||this._message.default);break}}if(l.validateFunction&&null!==(o=await this.validateFunction(l,r,n,i,d)))break}return null!==o&&(o=a.TAG+o),o}async validateFunction(e,t,r,n,i){let o=null;try{let s=null;const a=await e.validateFunction(e,t,n||r,e=>{s=e});(s||"string"==typeof a&&a||!1===a)&&(o=this._getMessage(e,s||a,i))}catch(t){o=this._getMessage(e,t.message,i)}return o}_getMessage(e,t,r){return xt(e,t||e.errorMessage||this._message[r]||t.default)}_getValidateType(e){var t="";return e.required?t="required":e.format?t="format":e.arrayType?t="arrayTypeFormat":e.range?t="range":void 0!==e.maximum||void 0!==e.minimum?t="rangeNumber":void 0!==e.maxLength||void 0!==e.minLength?t="rangeLength":e.pattern?t="pattern":e.validateFunction&&(t="validateFunction"),t}}{constructor(e,t){super(Rt.message),this._schema=e,this._options=t||null}updateSchema(e){this._schema=e}async validate(e,t){let r=this._checkFieldInSchema(e);return r||(r=await this.invokeValidate(e,!1,t)),r.length?r[0]:null}async validateAll(e,t){let r=this._checkFieldInSchema(e);return r||(r=await this.invokeValidate(e,!0,t)),r}async validateUpdate(e,t){let r=this._checkFieldInSchema(e);return r||(r=await this.invokeValidateUpdate(e,!1,t)),r.length?r[0]:null}async invokeValidate(e,t,r){const n=[],i=this._schema;for(const o in i){const s=i[o],a=await this.validateRule(o,s,e[o],e,r);if(null!=a&&(n.push({key:o,errorMessage:a}),!t))break}return n}async invokeValidateUpdate(e,t,r){const n=[];for(const i in e){const o=await this.validateRule(i,this._schema[i],e[i],e,r);if(null!=o&&(n.push({key:i,errorMessage:o}),!t))break}return n}_checkFieldInSchema(e){var t=Object.keys(e),r=Object.keys(this._schema);if(new Set(t.concat(r)).size===r.length)return"";var n=t.filter(e=>r.indexOf(e)<0);return[{key:"invalid",errorMessage:xt({field:JSON.stringify(n)},Rt.message.TAG+Rt.message.defaultInvalid)}]}}function Ct(e={},t){this.$provider="aliyun",this.$options=e,this.$context=e.context||global.__ctx__,function(e){e.$scope=e.$context.mpserverless}(this),function(e){e.auth=s("auth"),e.customAuth=e.auth}(this),_(this),function(e){e.logger=console}(this),function(e){e.database=function(t){return e.$scope.db.toJSON=function(){return"_db"},new _t(e.$scope.db,t)}}(this),function(e){e.callFunction=function({name:t,data:r}){return new Promise((n,o)=>{e.$scope.function.invoke(t,r).then(e=>{n(e)}).catch(e=>{o(new i(e))})})}}(this),function(e){e.httpclient=e.$context.httpclient}(this),function(e){e.getPhoneNumber=Ot,e.sendSms=Nt,e.initI18n=Lt,e.validate=async function(e,t,r={}){const n=new Rt(t,r);return r.ignoreRequired?n.validateUpdate(e):n.validate(e)}}(this)}Rt.message=new function(){return{TAG:"数据库验证失败：",default:"验证错误",defaultInvalid:`提交的字段{field}在${"true"===process.env.USE_CLOUD_SCHEMA?"云端":"本地"}数据表的schema文件中不存在`,validateFunction:"验证无效",required:"{label}必填",enum:"{label}字段为枚举类型，提交内容不在枚举范围内",timestamp:"{label}格式无效",whitespace:"{label}不能为空",typeError:"{label}类型无效",date:{format:"{label}日期{value}格式无效",parse:"{label}日期无法解析,{value}无效",invalid:"{label}日期{value}无效"},length:{minLength:"{label}长度不能少于{minLength}",maxLength:"{label}长度不能超过{maxLength}",range:"{label}必须介于{minLength}和{maxLength}之间"},number:{minimum:"{label}不能小于{minimum}",maximum:"{label}不能大于{maximum}",exclusiveMinimum:"{label}不能小于等于{minimum}",exclusiveMaximum:"{label}不能大于等于{maximum}",range:"{label}必须介于{minimum}and{maximum}之间"},pattern:{mismatch:"{label}格式不匹配"}}},Ct.prototype.init=function(e){return"tencent"===uniCloud.$provider&&e.context&&!e.spaceId?this:new Ct(e)},module.exports=Ct;
