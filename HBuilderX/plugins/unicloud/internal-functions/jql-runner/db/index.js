"use strict";function t(t){return t&&"string"==typeof t?JSON.parse(t):t}t(process.env.UNICLOUD_DEBUG),t(process.env.UNI_CLOUD_PROVIDER),process.env.RUN_BY_HBUILDERX;const e=Symbol("CLIENT_DB_INTERNAL");function r(t,r){return t.then="DoNotReturnProxyWithAFunctionNamedThen",t._internalType=e,new Proxy(t,{get:(t,e,n)=>e in t||"string"!=typeof e?t[e]:r.get(t,e,n)})}function n(t){switch(r=t,Object.prototype.toString.call(r).slice(8,-1).toLowerCase()){case"array":return t.map((t=>n(t)));case"object":return t._internalType===e||Object.keys(t).forEach((e=>{t[e]=n(t[e])})),t;case"regexp":return{$regexp:{source:t.source,flags:t.flags}};case"date":return{$date:t.toISOString()};default:return t}var r}let o={};function a(t,e={}){var r,n;return r=o,n=t,Object.prototype.hasOwnProperty.call(r,n)||(o[t]=e),o[t]}a("_globalUniCloudInterceptor");const s={database:function(){if(this._database)return this._database;const t={};let e={};this.isDefault&&(e=a("_globalUniCloudDatabaseCallback"));class o{constructor(t,e){this.content=t,this.prevStage=e,this.udb=null}toJSON(){let t=this;const e=[t.content];for(;t.prevStage;)t=t.prevStage,e.push(t.content);return{$db:e.reverse().map((t=>({$method:t.$method,$param:n(t.$param)})))}}getAction(){const t=this.toJSON().$db.find((t=>"action"===t.$method));return t&&t.$param&&t.$param[0]}getCommand(){return{$db:this.toJSON().$db.filter((t=>"action"!==t.$method))}}get useAggregate(){let t=this,e=!1;for(;t.prevStage;){t=t.prevStage;const r=t.content.$method;if("aggregate"===r||"pipeline"===r){e=!0;break}}return e}get count(){if(!this.useAggregate)return function(){return this._send("count",Array.from(arguments))};const t=this;return function(){return u({$method:"count",$param:n(Array.from(arguments))},t)}}get(){return this._send("get",Array.from(arguments))}add(){return this._send("add",Array.from(arguments))}remove(){return this._send("remove",Array.from(arguments))}update(){return this._send("update",Array.from(arguments))}end(){return this._send("end",Array.from(arguments))}set(){throw new Error("clientDB禁止使用set方法")}get multiSend(){}_send(t,e){const r=this.getAction(),o=this.getCommand();if(o.$db.push({$method:t,$param:n(e)}),r)throw new Error("本地直接执行jql文件时不允许使用action");return{command:o}}}const s=["db.Geo","db.command","command.aggregate"];function i(t,e){return s.indexOf(`${t}.${e}`)>-1}function u(t,e){return r(new o(t,e),{get(t,e){let r="db";return t&&t.content&&(r=t.content.$method),i(r,e)?u({$method:e},t):function(){return u({$method:e,$param:n(Array.from(arguments))},t)}}})}function c({path:t,method:e}){return class{constructor(){this.param=Array.from(arguments)}toJSON(){return{$newDb:[...t.map((t=>({$method:t}))),{$method:e,$param:this.param}]}}}}const d={auth:{on:(e,r)=>{t[e]=t[e]||[],t[e].indexOf(r)>-1||t[e].push(r)},off:(e,r)=>{t[e]=t[e]||[];const n=t[e].indexOf(r);-1!==n&&t[e].splice(n,1)}},on:(t,r)=>{e[t]=e[t]||[],e[t].indexOf(r)>-1||e[t].push(r)},off:(t,r)=>{e[t]=e[t]||[];const n=e[t].indexOf(r);-1!==n&&e[t].splice(n,1)},env:r({},{get:(t,e)=>({$env:e})}),Geo:r({},{get:(t,e)=>c({path:["Geo"],method:e})}),getCloudEnv:function(t){if("string"!=typeof t||!t.trim())throw new Error("getCloudEnv参数错误");return{$env:t.replace("$cloudEnv_","")}},multiSend(){return{multiCommand:Array.from(arguments).map((t=>{const e=t.getAction(),r=t.getCommand();if(e)throw new Error("本地直接执行jql文件时不允许使用action");if("getTemp"!==r.$db[r.$db.length-1].$method)throw new Error("multiSend只支持子命令内使用getTemp");return{action:e,command:r}}))}},get serverDate(){return c({path:[],method:"serverDate"})},get RegExp(){return c({path:[],method:"RegExp"})}},m=r(d,{get:(t,e)=>i("db",e)?u({$method:e}):function(){return u({$method:e,$param:n(Array.from(arguments))})}});return this._database=m,m}};var i=s.database();module.exports=i;