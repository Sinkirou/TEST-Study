"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("path")),s=e(require("hbuilderx")),r=e(require("fs")),n=e(require("os")),i=require("child_process"),o=require("events"),a=e(o),c=e(require("http")),l=e(require("https")),h=e(require("net")),u=e(require("tls")),d=e(require("crypto")),p=e(require("url")),f=e(require("zlib")),m=e(require("stream"));"darwin"===process.platform&&(process.env.PATH=["./node_modules/.bin","/.nodebrew/current/bin","/usr/local/bin",process.env.PATH].join(":")),process.env.UNICLOUD_DEBUGGER_PATH=t.resolve(__dirname,"../");class _ extends Error{constructor({code:e,message:t}){super(t),this.code=e}}var g={EOL:n.EOL||"\n",tryParseNumber:function(e,t){var s,r,n="",i=0,o=!0,a=0;function c(){return r=e.charAt(a),a++,r}for(c(),"-"===r&&(n="-",c());r>="0"&&r<="9";)o&&("0"==r?i++:o=!1),n+=r,c();if(o&&i--,"."===r)for(n+=".";c()&&r>="0"&&r<="9";)n+=r;if("e"===r||"E"===r)for(n+=r,c(),"-"!==r&&"+"!==r||(n+=r,c());r>="0"&&r<="9";)n+=r,c();for(;r&&r<=" ";)c();return t&&(","!==r&&"}"!==r&&"]"!==r&&"#"!==r&&("/"!==r||"/"!==e[a]&&"*"!==e[a])||(r=0)),s=+n,r||i||!isFinite(s)?void 0:s},createComment:function(e,t){return Object.defineProperty&&Object.defineProperty(e,"__COMMENTS__",{enumerable:!1,writable:!0}),e.__COMMENTS__=t||{}},removeComment:function(e){Object.defineProperty(e,"__COMMENTS__",{value:void 0})},getComment:function(e){return e.__COMMENTS__},forceComment:function(e){if(!e)return"";var t,s,r,n,i=e.split("\n");for(r=0;r<i.length;r++)for(n=(t=i[r]).length,s=0;s<n;s++){var o=t[s];if("#"===o)break;if("/"===o&&("/"===t[s+1]||"*"===t[s+1])){"*"===t[s+1]&&(r=i.length);break}if(o>" "){i[r]="# "+t;break}}return i.join("\n")}};function v(e,t){if(e)for(var s=0;s<e.length;s++){var r=e[s](t);if(void 0!==r)return r}}function y(){}function w(e){return"{"===e||"}"===e||"["===e||"]"===e||","===e}function b(){return{name:"math",parse:function(e){switch(e){case"+inf":case"inf":case"+Inf":case"Inf":return 1/0;case"-inf":case"-Inf":return-1/0;case"nan":case"NaN":return NaN}},stringify:function(e){if("number"==typeof e)return 1/e==-1/0?"-0":e===1/0?"Inf":e===-1/0?"-Inf":isNaN(e)?"NaN":void 0}}}function S(e){var t=e&&e.out;return{name:"hex",parse:function(e){if(/^0x[0-9A-Fa-f]+$/.test(e))return parseInt(e,16)},stringify:function(e){if(t&&Number.isInteger(e))return"0x"+e.toString(16)}}}function k(){return{name:"date",parse:function(e){if(/^\d{4}-\d{2}-\d{2}$/.test(e)||/^\d{4}-\d{2}-\d{2}T\d{2}\:\d{2}\:\d{2}(?:.\d+)(?:Z|[+-]\d{2}:\d{2})$/.test(e)){var t=Date.parse(e);if(!isNaN(t))return new Date(t)}},stringify:function(e){if("[object Date]"===Object.prototype.toString.call(e)){var t=e.toISOString();return-1!==t.indexOf("T00:00:00.000Z",t.length-14)?t.substr(0,10):t}}}}b.description="support for Inf/inf, -Inf/-inf, Nan/naN and -0",S.description="parse hexadecimal numbers prefixed with 0x",k.description="support ISO dates";var x={loadDsf:function(e,t){if("[object Array]"!==Object.prototype.toString.apply(e)){if(e)throw new Error("dsf option must contain an array!");return y}if(0===e.length)return y;var s=[];function r(e){return"[object Function]"==={}.toString.call(e)}return e.forEach((function(e){if(!e.name||!r(e.parse)||!r(e.stringify))throw new Error("extension does not match the DSF interface");s.push((function(){try{if("parse"==t)return e.parse.apply(null,arguments);if("stringify"==t){var s=e.stringify.apply(null,arguments);if(void 0!==s&&("string"!=typeof s||0===s.length||'"'===s[0]||[].some.call(s,(function(e){return w(e)}))))throw new Error("value may not be empty, start with a quote or contain a punctuator character except colon: "+s);return s}throw new Error("Invalid type")}catch(t){throw new Error("DSF-"+e.name+" failed; "+t.message)}}))})),v.bind(null,s)},std:{math:b,hex:S,date:k}},C=function(e,t){var s,r,n,i,o,a=g,c=x,l={'"':'"',"'":"'","\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};function h(){r=0,n=" "}function u(e){return"{"===e||"}"===e||"["===e||"]"===e||","===e||":"===e}function d(e){var t,n=0,i=1;for(t=r-1;t>0&&"\n"!==s[t];t--,n++);for(;t>0;t--)"\n"===s[t]&&i++;throw new Error(e+" at line "+i+","+n+" >>>"+s.substr(r-n,20)+" ...")}function p(){return n=s.charAt(r),r++,n}function f(e){return s.charAt(r+e)}function m(e){for(var t="",s=n;p();){if(n===s)return p(),e&&"'"===s&&"'"===n&&0===t.length?(p(),_()):t;if("\\"===n)if(p(),"u"===n){for(var r=0,i=0;i<4;i++){p();var o,a=n.charCodeAt(0);n>="0"&&n<="9"?o=a-48:n>="a"&&n<="f"?o=a-97+10:n>="A"&&n<="F"?o=a-65+10:d("Bad \\u char "+n),r=16*r+o}t+=String.fromCharCode(r)}else{if("string"!=typeof l[n])break;t+=l[n]}else"\n"===n||"\r"===n?d("Bad string containing newline"):t+=n}d("Bad string")}function _(){for(var e="",t=0,s=0;;){var r=f(-s-5);if(!r||"\n"===r)break;s++}function i(){for(var e=s;n&&n<=" "&&"\n"!==n&&e-- >0;)p()}for(;n&&n<=" "&&"\n"!==n;)p();for("\n"===n&&(p(),i());;){if(n){if("'"===n){if(t++,p(),3===t)return"\n"===e.slice(-1)&&(e=e.slice(0,-1)),e;continue}for(;t>0;)e+="'",t--}else d("Bad multiline string");"\n"===n?(e+="\n",p(),i()):("\r"!==n&&(e+=n),p())}}function v(){if('"'===n||"'"===n)return m(!1);for(var e="",t=r,s=-1;;){if(":"===n)return e?s>=0&&s!==e.length&&(r=t+s,d("Found whitespace in your key name (use quotes to include)")):d("Found ':' but no key name (for an empty key name use quotes)"),e;n<=" "?n?s<0&&(s=e.length):d("Found EOF while looking for a key name (check your syntax)"):u(n)?d("Found '"+n+"' where a key name was expected (check your syntax or use quotes if the key name includes {}[],: or whitespace)"):e+=n,p()}}function y(){for(;n;){for(;n&&n<=" ";)p();if("#"===n||"/"===n&&"/"===f(0))for(;n&&"\n"!==n;)p();else{if("/"!==n||"*"!==f(0))break;for(p(),p();n&&("*"!==n||"/"!==f(0));)p();n&&(p(),p())}}}function w(e,t){var n;for(e--,n=r-2;n>e&&s[n]<=" "&&"\n"!==s[n];n--);"\n"===s[n]&&n--,"\r"===s[n]&&n--;var i=s.substr(e,n-e+1);for(n=0;n<i.length;n++)if(i[n]>" "){var o=i.indexOf("\n");if(o>=0){var a=[i.substr(0,o),i.substr(o+1)];return t&&0===a[0].trim().length&&a.shift(),a}return[i]}return[]}function b(e){function t(t){var s=function e(t,s){var r,n,i,o;switch(typeof t){case"string":t.indexOf(s)>=0&&(o=t);break;case"object":if("[object Array]"===Object.prototype.toString.apply(t))for(r=0,i=t.length;r<i;r++)o=e(t[r],s)||o;else for(n in t)Object.prototype.hasOwnProperty.call(t,n)&&(o=e(t[n],s)||o)}return o}(e,t);return s?"found '"+t+"' in a string value, your mistake could be with:\n  > "+s+"\n  (unquoted strings contain everything up to the next line!)":""}return t("}")||t("]")}function S(){var e,t,s,o=[];try{if(i&&(e=a.createComment(o,{a:[]})),p(),t=r,y(),e&&(s=w(t,!0).join("\n")),"]"===n)return p(),e&&(e.e=[s]),o;for(;n;){if(o.push(C()),t=r,y(),","===n&&(p(),t=r,y()),e){var c=w(t);e.a.push([s||"",c[0]||""]),s=c[1]}if("]"===n)return p(),e&&(e.a[e.a.length-1][1]+=s||""),o;y()}d("End of input while parsing an array (missing ']')")}catch(e){throw e.hint=e.hint||b(o),e}}function k(e){var t,s,o,c="",l={};try{if(i&&(t=a.createComment(l,{c:{},o:[]})),e?s=1:(p(),s=r),y(),t&&(o=w(s,!0).join("\n")),"}"===n&&!e)return t&&(t.e=[o]),p(),l;for(;n;){if(c=v(),y(),":"!==n&&d("Expected ':' instead of '"+n+"'"),p(),l[c]=C(),s=r,y(),","===n&&(p(),s=r,y()),t){var h=w(s);t.c[c]=[o||"",h[0]||""],o=h[1],t.o.push(c)}if("}"===n&&!e)return p(),t&&(t.c[c][1]+=o||""),l;y()}if(e)return l;d("End of input while parsing an object (missing '}')")}catch(e){throw e.hint=e.hint||b(l),e}}function C(){switch(y(),n){case"{":return k();case"[":return S();case"'":case'"':return m(!0);default:return function(){var e=n;for(u(n)&&d("Found a punctuator character '"+n+"' when expecting a quoteless string (check your syntax)");;){p();var t="\r"===n||"\n"===n||""===n;if(t||","===n||"}"===n||"]"===n||"#"===n||"/"===n&&("/"===f(0)||"*"===f(0))){var s=e[0];switch(s){case"f":if("false"===e.trim())return!1;break;case"n":if("null"===e.trim())return null;break;case"t":if("true"===e.trim())return!0;break;default:if("-"===s||s>="0"&&s<="9"){var r=a.tryParseNumber(e);if(void 0!==r)return r}}if(t){e=e.trim();var i=o(e);return void 0!==i?i:e}}e+=n}}()}}function E(e,t){var s=r;if(y(),n&&d("Syntax error, found trailing characters"),i){var o=t.join("\n"),c=w(s).join("\n");if(c||o)a.createComment(e,a.getComment(e)).r=[o,c]}return e}if("string"!=typeof e)throw new Error("source is not a string");var P=null,O=!0;return t&&"object"==typeof t&&(i=t.keepWsc,P=t.dsf,O=!1!==t.legacyRoot),o=c.loadDsf(P,"parse"),s=e,h(),O?function(){y();var e=i?w(1):null;switch(n){case"{":return E(k(),e);case"[":return E(S(),e)}try{return E(k(!0),e)}catch(t){h();try{return E(C(),e)}catch(e){throw t}}}():function(){y();var e=i?w(1):null;switch(n){case"{":return E(k(),e);case"[":return E(S(),e);default:return E(C(),e)}}()};var E=C;const P=require("hbuilderx");class O extends Error{constructor({message:e,code:t}={}){super(e),this.code=t}}const I=-32601,N=-32603;var T={JsonRpcClient:class{constructor({bridgeProcess:e}){this._id=0,this._bridgeProcess=e,this._promiseMap=new Map,this._bridgeProcess.on("message",({type:e,result:t,error:s,id:r})=>{"JSON_RPC_Message"===e&&this._processMessage({result:t,error:s,id:r})})}_processMessage({result:e,error:t,id:s}){if(!this._promiseMap.has(s))return;const{resolve:r,reject:n}=this._promiseMap.get(s);t?n(new O({code:t.code,message:t.message})):r(e)}_send({method:e,params:t}){const s=++this._id;this._bridgeProcess.send({type:"JSON_RPC_Message",id:s,method:e,params:t})}call(e,t){return new Promise((s,r)=>{this._send({method:e,params:t}),this._promiseMap.set(this._id,{resolve:s,reject:r})})}},JsonRpcServer:class{constructor({bridgeProcess:e}){this._bridgeProcess=e,this._methodMap=new Map,this._bridgeProcess.on("message",({type:e,id:t,method:s,params:r})=>{"JSON_RPC_Message"===e&&this._processMessage({id:t,method:s,params:r})})}expose(e,t){this._methodMap.set(e,t)}_send(e,t){this._bridgeProcess.send({type:"JSON_RPC_Message",id:e,result:t})}_sendError(e,t,s,r){this._bridgeProcess.send({type:"JSON_RPC_Message",id:e,error:{code:t,message:s&&s.message||s,data:r}})}_processMessage({id:e,method:t,params:s}){this._methodMap.has(t)||this._sendError(e,I,`method[${t}] not found`);const r=this._methodMap.get(t);try{const t=r(s);t instanceof Promise?t.then(t=>{this._send(e,t)}).catch(t=>{this._sendError(e,N,t)}):this._send(e,t)}catch(t){this._sendError(e,N,t)}}}};class L extends Error{constructor(e,t){super(e),this.code=t}}function M(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function R(e,t="path"){let s;return s="path"===t?r.readFileSync(e).toString().replace("\r\n","\n").replace("\r","\n"):e,E(s)}function j(e){return[t.resolve(e,"src","manifest.json"),t.resolve(e,"src","pages.json")].every(e=>r.existsSync(e))}function D(e){const s=t.resolve(e,j(e)?"src":"","uni_modules");try{if(!r.statSync(s).isDirectory())return[]}catch(e){return[]}return r.readdirSync(s).filter(e=>{try{return!!r.statSync(t.resolve(s,e)).isDirectory()}catch(e){return!1}})}function F(e){let s={};try{s=R(t.resolve(e,j(e)?"src":"","uni-modules.config.json"))}catch(e){}let r=s&&s.uni_modules;return r&&"object"===M(r)||(r={}),r}function $(e,s){const n=[t.resolve(e,`uniCloud-${s}/cloudfunctions/`)],i=D(e);if(!i||0===i.length)return n;const o=F(e);for(let a=0;a<i.length;a++){const c=i[a],l=o[c];let h=l&&l.uniCloud;if(h&&"array"===M(h)||(h=[s]),h.indexOf(s)>-1){const s=t.resolve(e,j(e)?"src":"",`uni_modules/${c}/uniCloud/cloudfunctions`);r.existsSync(s)&&n.push(s)}}return n}function U(e,s){const n=[t.resolve(e,`uniCloud-${s}/database`)],i=D(e);if(!i||0===i.length)return n;const o=F(e);for(let a=0;a<i.length;a++){const c=i[a];let l=o[c];if(l&&"array"===M(l)||(l=[s]),l.indexOf(s)>-1){const s=t.resolve(e,j(e)?"src":"",`uni_modules/${c}/uniCloud/database`);r.existsSync(s)&&n.push(s)}}return n}function B(e){const t=["common","uni-clientDB-actions"];let s=[];try{s=r.readdirSync(e).filter(e=>-1===t.indexOf(e))}catch(e){}return s}function A(e,s,n){const i=function(e,s,n){const i=$(e,s),o=[];for(let e=0;e<i.length;e++){const s=i[e];let a;const c=t.resolve(s,"common/"+n);try{a=r.statSync(c)}catch(e){}a&&a.isDirectory()&&o.push(c)}return o}(e,s,n);if(0===i.length)throw new L(`未找到公共模块[${n}]`,"NOT_FOUND");if(i.length>1)throw console.error(`公共模块[${n}]存在名称冲突，请解决冲突后再试。产生冲突的路径如下：`),i.forEach(e=>{console.error(e)}),new L(`公共模块[${n}]名称冲突，请解决后再试', 'CONFLICT_NAME`);return i[0]}var q={getType:M,parseJson:R,getRealWorkspace:function({workspaceFolder:e,uniCloudInfo:t,provider:s}){const r=t.find(e=>e.provider===s);return r&&function(e){return e&&e.uri&&e.uri.fsPath}(r.workspaceFolder)||e},getAppid:function(e){const s=j(e),r=t.resolve(e,s?"src":"","manifest.json");let n={};try{n=R(r)}catch(e){}return n.appid},getModuleList:D,getCloudfunctionPathList:$,getFunctionPathList:function(e){const s=["common","uni-clientDB-actions"];let n=[];try{n=r.readdirSync(e).filter(e=>-1===s.indexOf(e)).map(s=>t.resolve(e,s))}catch(e){}return n},getCommonModulePathList:function(e){let s=[];const n=t.resolve(e,"common");try{s=r.readdirSync(n).map(e=>t.resolve(n,e))}catch(e){}return s},getCommonModulePath:A,getFunctionEntry:function(e,s,r){const n=function(e,s,r){const n=$(e,s),i=[];for(let e=0;e<n.length;e++){const s=n[e];B(s).indexOf(r)>-1&&i.push(t.resolve(s,r))}return i}(e,s,r);if(0===n.length)throw new L(`未匹配到云函数[${r}]`,"NOT_FOUND");if(n.length>1)throw console.error(`云函数[${r}]存在名称冲突，请解决冲突后再试。产生冲突的路径如下：`),n.forEach(e=>{console.error(e)}),new L("云函数名称冲突，请解决后再试","CONFLICT_NAME");return n[0]},getUniIdPath:function(e,t){return A(e,t,"uni-id")},getActionPath:function(e,s,n){const i=function(e,s,n){const i=$(e,s),o=[];for(let e=0;e<i.length;e++){const s=i[e];let a;const c=t.resolve(s,`uni-clientDB-actions/${n}.js`);try{a=r.statSync(c)}catch(e){}a&&a.isFile()&&o.push(c)}return o}(e,s,n);if(0===i.length)throw new L(`未找到uni-clientDB-actions[${n}]`,"NOT_FOUND");if(i.length>1)throw console.error(`uni-clientDB-actions[${n}]存在名称冲突，请解决冲突后再试。产生冲突的路径如下：`),i.forEach(e=>{console.error(e)}),new L(`uni-clientDB-actions[${n}]名称冲突，请解决后再试`,"CONFLICT_NAME");return i[0]},getSchemaPath:function(e,s,n){const i=function(e,s,n){const i=U(e,s),o=[];for(let e=0;e<i.length;e++){const s=i[e];let a;const c=t.resolve(s,n+".schema.json");try{a=r.statSync(c)}catch(e){}a&&a.isFile()&&o.push(c)}return o}(e,s,n);if(0===i.length)throw new L(`项目database目录下缺少${n}.schema.json。如云端的该表已配置schema，请下载到database目录中`,"NOT_FOUND");if(i.length>1)throw console.error(n+"表对应的schema存在名称冲突，请解决冲突后再试。产生冲突的路径如下："),i.forEach(e=>{console.error(e)}),new L(n+"表对应的schema名称冲突，请解决后再试","CONFLICT_NAME");return i[0]},getValidateFunctionPath:function(e,s,n){const i=function(e,s,n){const i=U(e,s),o=[];for(let e=0;e<i.length;e++){const s=i[e];let a;const c=t.resolve(s,`validateFunction/${n}.js`);try{a=r.statSync(c)}catch(e){}a&&a.isFile()&&o.push(c)}return o}(e,s,n);if(0===i.length)throw new L(`未找到扩展校验函数[${n}]`,"NOT_FOUND");if(i.length>1)throw console.error(`扩展校验函数[${n}]存在名称冲突，请解决冲突后再试。产生冲突的路径如下：`),i.forEach(e=>{console.error(e)}),new L(`扩展校验函数[${n}]名称冲突，请解决后再试`,"CONFLICT_NAME");return i[0]},getWorkspacePathFromFilePath:function(e){const t=e.match(/(.*?)\/(uniCloud-(?:aliyun|tcb)|src\/uni_modules|uni_modules)/);return t&&t[1]},isUniAppCli:j,isModuleEncrypted:function(e){return r.existsSync(t.resolve(e,"encrypt"))},isFileEncrypted:function(e){let t;try{t=r.statSync(e)}catch(e){return!1}const s=r.openSync(e),n=Buffer.alloc(Math.min(t.size,512));return r.readSync(s,n),r.closeSync(s),Array.from(n).some(e=>0===e)},...T};const W="win32"===process.platform?"npm.cmd":"npm";let J;function G(e){void 0===J&&(J=r.existsSync(t.resolve(__dirname,"dcloud.debug"))),J&&r.appendFileSync(t.resolve(__dirname,"log.txt"),(new Date).toLocaleString()+" "+e+"\n")}function V(e){const t=e&&e.uri&&e.uri.fsPath,s=t.split(":");return 1===s.length?t:(s[0]=s[0].toUpperCase(),s.join(":"))}function H(e){return"/"!==(e=e.replace(/\\/g,"/"))[e.length-1]&&(e+="/"),new RegExp("^"+e,"i")}function Y(e){if(e.error)throw new _({code:"NETWORK_ERROR",message:"请求DCloud服务失败："+JSON.stringify(e.error)});const t=JSON.parse(e.data),s=t.header&&t.header.result&&t.header.result.rspcode,r=t.header&&t.header.result&&t.header.result.rspdesc;if("1001"!==s)throw new _({code:"NETWORK_ERROR",message:`请求DCloud服务失败：错误码为：${s}，详细错误信息为：${r}`});return t.body}const z="ide.liuyingyong.cn";let Q={};const K=new Map;async function Z({provider:e,spaceId:t,appId:s,useCache:r=!1}={}){const n=`${t}_${r}`;let i;K.has(n)&&"pending"===K.get(n).status||(i=async function({provider:e,spaceId:t,appId:s,useCache:r=!1}={}){if(r&&Q[t]&&Q[t].expireTime-Date.now()>1e4){const{uniCloudSecret:e,expireTime:s}=Q[t];return{uniCloudSecret:e,restTime:(s-Date.now())/1e3}}const n=Y(await P.http.request({url:`https://${z}/serverless/space/debug-token`,method:"post",params:{param:JSON.stringify({header:{token:"${user.checked.token}"},body:{provider:e,spaceId:t,appid:s}})}}));let i;switch(e){case"aliyun":{const{Token:e}=n.Credentials;i={spaceId:t,serverSecret:e};break}case"tcb":{const{TmpSecretId:e,TmpSecretKey:s,Token:r}=n.Credentials;i={spaceId:t,secretId:e,secretKey:s,sessionToken:r};break}}const o=parseInt(n.RestTime);return Q[t]={uniCloudSecret:i,expireTime:Date.now()+1e3*o},{uniCloudSecret:i,restTime:o}}({provider:e,spaceId:t,appId:s,useCache:r}),K.set(n,{promise:i,status:"pending"}));const o=K.get(n);let a;try{a=await o.promise,o.status="fulfilled"}catch(e){throw o.status="rejected",e}return a}function X(){return["<node_internals>/**/*.js",process.env.UNICLOUD_DEBUGGER_PATH.replace(/\\/g,"/")+"/**/*.js"]}async function ee(){const e=await new Promise(e=>{const t=i.spawn(W,["-v"]);t.on("exit",()=>{0===t.exitCode?e(W):e(void 0)})});return e||t.resolve(__dirname,"../../npm",W)}function te(e,{npmCmd:s=W}={}){return new Promise((n,o)=>{const a=t.resolve(e,"package.json");if(!r.existsSync(a))return void n();let c;try{c=JSON.parse(r.readFileSync(a).toString())}catch(e){return void n()}const l=c&&c.dependencies&&Object.keys(c.dependencies).every(e=>0===c.dependencies[e].indexOf("file:")),h=i.spawn(s,["ls"],{cwd:e});h.on("exit",()=>{0===h.exitCode?n():n({type:l?"local":"npm"})})})}async function se(e,{npmCmd:t=W}={}){const s=[];for(let r=0;r<e.length;r++){const n=e[r],i=await te(n,{npmCmd:t});i&&s.push({dir:n,functionPath:n,...i})}return s}async function re(e,{npmCmd:t=W}){const s=[];for(let r=0;r<e.length;r++){const n=e[r],i=await te(n,{npmCmd:t});i&&s.push({dir:n,commonModulePath:n,...i})}return s}function ne(e,{npmCmd:s=W}={}){const n=t.resolve(e,"package-lock.json");return r.existsSync(n)&&r.unlinkSync(n),new Promise((t,r)=>{const n=i.spawn(s,["install","--production"],{cwd:e});let o=Buffer.alloc(0);n.stderr.on("data",e=>{o=Buffer.concat([o,e])}),n.on("exit",()=>{0===n.exitCode?t():r(new Error(`npm进程退出码：${n.exitCode}\n详细错误信息如下：\n${o.toString()}`))})})}function ie(e,t,s){return e(s={path:t,exports:{},require:function(e,t){return oe(null==t&&s.path)}},s.exports),s.exports}function oe(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}P.authorize.onUserLogout((function(){Q={}}));var ae={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),EMPTY_BUFFER:Buffer.alloc(0),NOOP:()=>{}},ce="function"==typeof __webpack_require__?__non_webpack_require__:oe,le=process.config&&process.config.variables||{},he=!!process.env.PREBUILDS_ONLY,ue=process.versions.modules,de=!(!process.versions||!process.versions.electron)||!!process.env.ELECTRON_RUN_AS_NODE||"undefined"!=typeof window&&window.process&&"renderer"===window.process.type?"electron":"node",pe=n.arch(),fe=n.platform(),me=process.env.LIBC||(function(e){return"linux"===e&&r.existsSync("/etc/alpine-release")}(fe)?"musl":"glibc"),_e=process.env.ARM_VERSION||("arm64"===pe?"8":le.arm_version)||"",ge=(process.versions.uv||"").split(".")[0],ve=ye;function ye(e){return ce(ye.path(e))}function we(e){try{return r.readdirSync(e)}catch(e){return[]}}function be(e,s){var r=we(e).filter(s);return r[0]&&t.join(e,r[0])}function Se(e){return/\.node$/.test(e)}function ke(e){var t=e.split("-");if(2===t.length){var s=t[0],r=t[1].split("+");if(s&&r.length&&r.every(Boolean))return{name:e,platform:s,architectures:r}}}function xe(e,t){return function(s){return null!=s&&(s.platform===e&&s.architectures.includes(t))}}function Ce(e,t){return e.architectures.length-t.architectures.length}function Ee(e){var t=e.split("."),s={file:e,specificity:0};if("node"===t.pop()){for(var r=0;r<t.length;r++){var n=t[r];if("node"===n||"electron"===n||"node-webkit"===n)s.runtime=n;else if("napi"===n)s.napi=!0;else if("abi"===n.slice(0,3))s.abi=n.slice(3);else if("uv"===n.slice(0,2))s.uv=n.slice(2);else if("armv"===n.slice(0,4))s.armv=n.slice(4);else{if("glibc"!==n&&"musl"!==n)continue;s.libc=n}s.specificity++}return s}}function Pe(e,t){return function(s){return null!=s&&(!(s.runtime!==e&&!function(e){return"node"===e.runtime&&e.napi}(s))&&(!(s.abi!==t&&!s.napi)&&((!s.uv||s.uv===ge)&&((!s.armv||s.armv===_e)&&(!s.libc||s.libc===me)))))}}function Oe(e){return function(t,s){return t.runtime!==s.runtime?t.runtime===e?-1:1:t.abi!==s.abi?t.abi?-1:1:t.specificity!==s.specificity?t.specificity>s.specificity?-1:1:0}}ye.path=function(e){e=t.resolve(e||".");try{var s=ce(t.join(e,"package.json")).name.toUpperCase().replace(/-/g,"_");process.env[s+"_PREBUILD"]&&(e=process.env[s+"_PREBUILD"])}catch(e){}if(!he){var r=be(t.join(e,"build/Release"),Se);if(r)return r;var n=be(t.join(e,"build/Debug"),Se);if(n)return n}var i=c(e);if(i)return i;var o=c(t.dirname(process.execPath));if(o)return o;var a=["platform="+fe,"arch="+pe,"runtime="+de,"abi="+ue,"uv="+ge,_e?"armv="+_e:"","libc="+me,"node="+process.versions.node,process.versions.electron?"electron="+process.versions.electron:"","function"==typeof __webpack_require__?"webpack=true":""].filter(Boolean).join(" ");throw new Error("No native build was found for "+a+"\n    loaded from: "+e+"\n");function c(e){var s=we(t.join(e,"prebuilds")).map(ke).filter(xe(fe,pe)).sort(Ce)[0];if(s){var r=t.join(e,"prebuilds",s.name),n=we(r).map(Ee).filter(Pe(de,ue)).sort(Oe(de))[0];return n?t.join(r,n.file):void 0}}},ye.parseTags=Ee,ye.matchTags=Pe,ye.compareTags=Oe,ye.parseTuple=ke,ye.matchTuple=xe,ye.compareTuples=Ce;var Ie={mask:(e,t,s,r,n)=>{for(var i=0;i<n;i++)s[r+i]=e[i]^t[3&i]},unmask:(e,t)=>{const s=e.length;for(var r=0;r<s;r++)e[r]^=t[3&r]}},Ne=ie((function(e){try{e.exports=ve(__dirname)}catch(t){e.exports=Ie}})),Te=ie((function(e){const{EMPTY_BUFFER:t}=ae;function s(e,s){if(0===e.length)return t;if(1===e.length)return e[0];const r=Buffer.allocUnsafe(s);let n=0;for(let t=0;t<e.length;t++){const s=e[t];r.set(s,n),n+=s.length}return n<s?r.slice(0,n):r}function r(e,t,s,r,n){for(let i=0;i<n;i++)s[r+i]=e[i]^t[3&i]}function n(e,t){const s=e.length;for(let r=0;r<s;r++)e[r]^=t[3&r]}function i(e){return e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function o(e){if(o.readOnly=!0,Buffer.isBuffer(e))return e;let t;return e instanceof ArrayBuffer?t=Buffer.from(e):ArrayBuffer.isView(e)?t=Buffer.from(e.buffer,e.byteOffset,e.byteLength):(t=Buffer.from(e),o.readOnly=!1),t}try{const t=Ne,a=t.BufferUtil||t;e.exports={concat:s,mask(e,t,s,n,i){i<48?r(e,t,s,n,i):a.mask(e,t,s,n,i)},toArrayBuffer:i,toBuffer:o,unmask(e,t){e.length<32?n(e,t):a.unmask(e,t)}}}catch(t){e.exports={concat:s,mask:r,toArrayBuffer:i,toBuffer:o,unmask:n}}}));const Le=Symbol("kDone"),Me=Symbol("kRun");var Re=class{constructor(e){this[Le]=()=>{this.pending--,this[Me]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[Me]()}[Me](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[Le])}}};const{kStatusCode:je,NOOP:De}=ae,Fe=Buffer.from([0,0,255,255]),$e=Symbol("permessage-deflate"),Ue=Symbol("total-length"),Be=Symbol("callback"),Ae=Symbol("buffers"),qe=Symbol("error");let We;var Je=class{constructor(e,t,s){if(this._maxPayload=0|s,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!We){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;We=new Re(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[Be];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,s=e.find(e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits));if(!s)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(s.server_no_context_takeover=!0),t.clientNoContextTakeover&&(s.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(s.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?s.client_max_window_bits=t.clientMaxWindowBits:!0!==s.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete s.client_max_window_bits,s}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach(e=>{Object.keys(e).forEach(t=>{let s=e[t];if(s.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(s=s[0],"client_max_window_bits"===t){if(!0!==s){const e=+s;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${s}`);s=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${s}`)}else if("server_max_window_bits"===t){const e=+s;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${s}`);s=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==s)throw new TypeError(`Invalid value for parameter "${t}": ${s}`)}e[t]=s})}),e}decompress(e,t,s){We.add(r=>{this._decompress(e,t,(e,t)=>{r(),s(e,t)})})}compress(e,t,s){We.add(r=>{this._compress(e,t,(e,t)=>{r(),s(e,t)})})}_decompress(e,t,s){const r=this._isServer?"client":"server";if(!this._inflate){const e=r+"_max_window_bits",t="number"!=typeof this.params[e]?f.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=f.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[$e]=this,this._inflate[Ue]=0,this._inflate[Ae]=[],this._inflate.on("error",He),this._inflate.on("data",Ve)}this._inflate[Be]=s,this._inflate.write(e),t&&this._inflate.write(Fe),this._inflate.flush(()=>{const e=this._inflate[qe];if(e)return this._inflate.close(),this._inflate=null,void s(e);const n=Te.concat(this._inflate[Ae],this._inflate[Ue]);t&&this.params[r+"_no_context_takeover"]?(this._inflate.close(),this._inflate=null):(this._inflate[Ue]=0,this._inflate[Ae]=[]),s(null,n)})}_compress(e,t,s){const r=this._isServer?"server":"client";if(!this._deflate){const e=r+"_max_window_bits",t="number"!=typeof this.params[e]?f.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=f.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[Ue]=0,this._deflate[Ae]=[],this._deflate.on("error",De),this._deflate.on("data",Ge)}this._deflate[Be]=s,this._deflate.write(e),this._deflate.flush(f.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let e=Te.concat(this._deflate[Ae],this._deflate[Ue]);t&&(e=e.slice(0,e.length-4)),this._deflate[Be]=null,t&&this.params[r+"_no_context_takeover"]?(this._deflate.close(),this._deflate=null):(this._deflate[Ue]=0,this._deflate[Ae]=[]),s(null,e)})}};function Ge(e){this[Ae].push(e),this[Ue]+=e.length}function Ve(e){this[Ue]+=e.length,this[$e]._maxPayload<1||this[Ue]<=this[$e]._maxPayload?this[Ae].push(e):(this[qe]=new RangeError("Max payload size exceeded"),this[qe][je]=1009,this.removeListener("data",Ve),this.reset())}function He(e){this[$e]._inflate=null,e[je]=1007,this[Be](e)}var Ye=function(e){const t=e.length;let s=0;for(;s<t;)if(0==(128&e[s]))s++;else if(192==(224&e[s])){if(s+1===t||128!=(192&e[s+1])||192==(254&e[s]))return!1;s+=2}else if(224==(240&e[s])){if(s+2>=t||128!=(192&e[s+1])||128!=(192&e[s+2])||224===e[s]&&128==(224&e[s+1])||237===e[s]&&160==(224&e[s+1]))return!1;s+=3}else{if(240!=(248&e[s]))return!1;if(s+3>=t||128!=(192&e[s+1])||128!=(192&e[s+2])||128!=(192&e[s+3])||240===e[s]&&128==(240&e[s+1])||244===e[s]&&e[s+1]>143||e[s]>244)return!1;s+=4}return!0},ze=ie((function(e){try{e.exports=ve(__dirname)}catch(t){e.exports=Ye}})),Qe=ie((function(e,t){try{const e=ze;t.isValidUTF8="object"==typeof e?e.Validation.isValidUTF8:e}catch(e){t.isValidUTF8=()=>!0}t.isValidStatusCode=e=>e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999}));const{Writable:Ke}=m,{BINARY_TYPES:Ze,EMPTY_BUFFER:Xe,kStatusCode:et,kWebSocket:tt}=ae,{concat:st,toArrayBuffer:rt,unmask:nt}=Te,{isValidStatusCode:it,isValidUTF8:ot}=Qe;var at=class extends Ke{constructor(e,t,s,r){super(),this._binaryType=e||Ze[0],this[tt]=void 0,this._extensions=t||{},this._isServer=!!s,this._maxPayload=0|r,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=0,this._loop=!1}_write(e,t,s){if(8===this._opcode&&0==this._state)return s();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(s)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=t.slice(e),t.slice(0,e)}const t=Buffer.allocUnsafe(e);do{const s=this._buffers[0],r=t.length-e;e>=s.length?t.set(this._buffers.shift(),r):(t.set(new Uint8Array(s.buffer,s.byteOffset,e),r),this._buffers[0]=s.slice(e)),e-=s.length}while(e>0);return t}startLoop(e){let t;this._loop=!0;do{switch(this._state){case 0:t=this.getInfo();break;case 1:t=this.getPayloadLength16();break;case 2:t=this.getPayloadLength64();break;case 3:this.getMask();break;case 4:t=this.getData(e);break;default:return void(this._loop=!1)}}while(this._loop);e(t)}getInfo(){if(this._bufferedBytes<2)return void(this._loop=!1);const e=this.consume(2);if(0!=(48&e[0]))return this._loop=!1,ct(RangeError,"RSV2 and RSV3 must be clear",!0,1002);const t=64==(64&e[0]);if(t&&!this._extensions[Je.extensionName])return this._loop=!1,ct(RangeError,"RSV1 must be clear",!0,1002);if(this._fin=128==(128&e[0]),this._opcode=15&e[0],this._payloadLength=127&e[1],0===this._opcode){if(t)return this._loop=!1,ct(RangeError,"RSV1 must be clear",!0,1002);if(!this._fragmented)return this._loop=!1,ct(RangeError,"invalid opcode 0",!0,1002);this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented)return this._loop=!1,ct(RangeError,"invalid opcode "+this._opcode,!0,1002);this._compressed=t}else{if(!(this._opcode>7&&this._opcode<11))return this._loop=!1,ct(RangeError,"invalid opcode "+this._opcode,!0,1002);if(!this._fin)return this._loop=!1,ct(RangeError,"FIN must be set",!0,1002);if(t)return this._loop=!1,ct(RangeError,"RSV1 must be clear",!0,1002);if(this._payloadLength>125)return this._loop=!1,ct(RangeError,"invalid payload length "+this._payloadLength,!0,1002)}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=128==(128&e[1]),this._isServer){if(!this._masked)return this._loop=!1,ct(RangeError,"MASK must be set",!0,1002)}else if(this._masked)return this._loop=!1,ct(RangeError,"MASK must be clear",!0,1002);if(126===this._payloadLength)this._state=1;else{if(127!==this._payloadLength)return this.haveLength();this._state=2}}getPayloadLength16(){if(!(this._bufferedBytes<2))return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength();this._loop=!1}getPayloadLength64(){if(this._bufferedBytes<8)return void(this._loop=!1);const e=this.consume(8),t=e.readUInt32BE(0);return t>Math.pow(2,21)-1?(this._loop=!1,ct(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009)):(this._payloadLength=t*Math.pow(2,32)+e.readUInt32BE(4),this.haveLength())}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return this._loop=!1,ct(RangeError,"Max payload size exceeded",!1,1009);this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=Xe;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&nt(t,this._mask)}return this._opcode>7?this.controlMessage(t):this._compressed?(this._state=5,void this.decompress(t,e)):(t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage())}decompress(e,t){this._extensions[Je.extensionName].decompress(e,this._fin,(e,s)=>{if(e)return t(e);if(s.length){if(this._messageLength+=s.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return t(ct(RangeError,"Max payload size exceeded",!1,1009));this._fragments.push(s)}const r=this.dataMessage();if(r)return t(r);this.startLoop(t)})}dataMessage(){if(this._fin){const e=this._messageLength,t=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let s;s="nodebuffer"===this._binaryType?st(t,e):"arraybuffer"===this._binaryType?rt(st(t,e)):t,this.emit("message",s)}else{const s=st(t,e);if(!ot(s))return this._loop=!1,ct(Error,"invalid UTF-8 sequence",!0,1007);this.emit("message",s.toString())}}this._state=0}controlMessage(e){if(8===this._opcode)if(this._loop=!1,0===e.length)this.emit("conclude",1005,""),this.end();else{if(1===e.length)return ct(RangeError,"invalid payload length 1",!0,1002);{const t=e.readUInt16BE(0);if(!it(t))return ct(RangeError,"invalid status code "+t,!0,1002);const s=e.slice(2);if(!ot(s))return ct(Error,"invalid UTF-8 sequence",!0,1007);this.emit("conclude",t,s.toString()),this.end()}}else 9===this._opcode?this.emit("ping",e):this.emit("pong",e);this._state=0}};function ct(e,t,s,r){const n=new e(s?"Invalid WebSocket frame: "+t:t);return Error.captureStackTrace(n,ct),n[et]=r,n}const{randomFillSync:lt}=d,{EMPTY_BUFFER:ht}=ae,{isValidStatusCode:ut}=Qe,{mask:dt,toBuffer:pt}=Te,ft=Buffer.alloc(4);class mt{constructor(e,t){this._extensions=t||{},this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){const s=t.mask&&t.readOnly;let r=t.mask?6:2,n=e.length;e.length>=65536?(r+=8,n=127):e.length>125&&(r+=2,n=126);const i=Buffer.allocUnsafe(s?e.length+r:r);return i[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(i[0]|=64),i[1]=n,126===n?i.writeUInt16BE(e.length,2):127===n&&(i.writeUInt32BE(0,2),i.writeUInt32BE(e.length,6)),t.mask?(lt(ft,0,4),i[1]|=128,i[r-4]=ft[0],i[r-3]=ft[1],i[r-2]=ft[2],i[r-1]=ft[3],s?(dt(e,ft,i,r,e.length),[i]):(dt(e,ft,e,0,e.length),[i,e])):[i,e]}close(e,t,s,r){let n;if(void 0===e)n=ht;else{if("number"!=typeof e||!ut(e))throw new TypeError("First argument must be a valid error code number");if(void 0===t||""===t)n=Buffer.allocUnsafe(2),n.writeUInt16BE(e,0);else{const s=Buffer.byteLength(t);if(s>123)throw new RangeError("The message must not be greater than 123 bytes");n=Buffer.allocUnsafe(2+s),n.writeUInt16BE(e,0),n.write(t,2)}}this._deflating?this.enqueue([this.doClose,n,s,r]):this.doClose(n,s,r)}doClose(e,t,s){this.sendFrame(mt.frame(e,{fin:!0,rsv1:!1,opcode:8,mask:t,readOnly:!1}),s)}ping(e,t,s){const r=pt(e);if(r.length>125)throw new RangeError("The data size must not be greater than 125 bytes");this._deflating?this.enqueue([this.doPing,r,t,pt.readOnly,s]):this.doPing(r,t,pt.readOnly,s)}doPing(e,t,s,r){this.sendFrame(mt.frame(e,{fin:!0,rsv1:!1,opcode:9,mask:t,readOnly:s}),r)}pong(e,t,s){const r=pt(e);if(r.length>125)throw new RangeError("The data size must not be greater than 125 bytes");this._deflating?this.enqueue([this.doPong,r,t,pt.readOnly,s]):this.doPong(r,t,pt.readOnly,s)}doPong(e,t,s,r){this.sendFrame(mt.frame(e,{fin:!0,rsv1:!1,opcode:10,mask:t,readOnly:s}),r)}send(e,t,s){const r=pt(e),n=this._extensions[Je.extensionName];let i=t.binary?2:1,o=t.compress;if(this._firstFragment?(this._firstFragment=!1,o&&n&&(o=r.length>=n._threshold),this._compress=o):(o=!1,i=0),t.fin&&(this._firstFragment=!0),n){const e={fin:t.fin,rsv1:o,opcode:i,mask:t.mask,readOnly:pt.readOnly};this._deflating?this.enqueue([this.dispatch,r,this._compress,e,s]):this.dispatch(r,this._compress,e,s)}else this.sendFrame(mt.frame(r,{fin:t.fin,rsv1:!1,opcode:i,mask:t.mask,readOnly:pt.readOnly}),s)}dispatch(e,t,s,r){if(!t)return void this.sendFrame(mt.frame(e,s),r);const n=this._extensions[Je.extensionName];this._bufferedBytes+=e.length,this._deflating=!0,n.compress(e,s.fin,(t,n)=>{if(this._socket.destroyed){const e=new Error("The socket was closed while data was being compressed");"function"==typeof r&&r(e);for(let t=0;t<this._queue.length;t++){const s=this._queue[t][4];"function"==typeof s&&s(e)}}else this._bufferedBytes-=e.length,this._deflating=!1,s.readOnly=!1,this.sendFrame(mt.frame(n,s),r),this.dequeue()})}dequeue(){for(;!this._deflating&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[1].length,Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[1].length,this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}}var _t=mt;class gt{constructor(e,t){this.target=t,this.type=e}}class vt extends gt{constructor(e,t){super("message",t),this.data=e}}class yt extends gt{constructor(e,t,s){super("close",s),this.wasClean=s._closeFrameReceived&&s._closeFrameSent,this.reason=t,this.code=e}}class wt extends gt{constructor(e){super("open",e)}}class bt extends gt{constructor(e,t){super("error",t),this.message=e.message,this.error=e}}var St={addEventListener(e,t,s){if("function"!=typeof t)return;function r(e){t.call(this,new vt(e,this))}function n(e,s){t.call(this,new yt(e,s,this))}function i(e){t.call(this,new bt(e,this))}function o(){t.call(this,new wt(this))}const a=s&&s.once?"once":"on";"message"===e?(r._listener=t,this[a](e,r)):"close"===e?(n._listener=t,this[a](e,n)):"error"===e?(i._listener=t,this[a](e,i)):"open"===e?(o._listener=t,this[a](e,o)):this[a](e,t)},removeEventListener(e,t){const s=this.listeners(e);for(let r=0;r<s.length;r++)s[r]!==t&&s[r]._listener!==t||this.removeListener(e,s[r])}};const kt=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function xt(e,t,s){void 0===e[t]?e[t]=[s]:e[t].push(s)}var Ct={format:function(e){return Object.keys(e).map(t=>{let s=e[t];return Array.isArray(s)||(s=[s]),s.map(e=>[t].concat(Object.keys(e).map(t=>{let s=e[t];return Array.isArray(s)||(s=[s]),s.map(e=>!0===e?t:`${t}=${e}`).join("; ")})).join("; ")).join(", ")}).join(", ")},parse:function(e){const t=Object.create(null);if(void 0===e||""===e)return t;let s,r,n=Object.create(null),i=!1,o=!1,a=!1,c=-1,l=-1,h=0;for(;h<e.length;h++){const u=e.charCodeAt(h);if(void 0===s)if(-1===l&&1===kt[u])-1===c&&(c=h);else if(32===u||9===u)-1===l&&-1!==c&&(l=h);else{if(59!==u&&44!==u)throw new SyntaxError("Unexpected character at index "+h);{if(-1===c)throw new SyntaxError("Unexpected character at index "+h);-1===l&&(l=h);const r=e.slice(c,l);44===u?(xt(t,r,n),n=Object.create(null)):s=r,c=l=-1}}else if(void 0===r)if(-1===l&&1===kt[u])-1===c&&(c=h);else if(32===u||9===u)-1===l&&-1!==c&&(l=h);else if(59===u||44===u){if(-1===c)throw new SyntaxError("Unexpected character at index "+h);-1===l&&(l=h),xt(n,e.slice(c,l),!0),44===u&&(xt(t,s,n),n=Object.create(null),s=void 0),c=l=-1}else{if(61!==u||-1===c||-1!==l)throw new SyntaxError("Unexpected character at index "+h);r=e.slice(c,h),c=l=-1}else if(o){if(1!==kt[u])throw new SyntaxError("Unexpected character at index "+h);-1===c?c=h:i||(i=!0),o=!1}else if(a)if(1===kt[u])-1===c&&(c=h);else if(34===u&&-1!==c)a=!1,l=h;else{if(92!==u)throw new SyntaxError("Unexpected character at index "+h);o=!0}else if(34===u&&61===e.charCodeAt(h-1))a=!0;else if(-1===l&&1===kt[u])-1===c&&(c=h);else if(-1===c||32!==u&&9!==u){if(59!==u&&44!==u)throw new SyntaxError("Unexpected character at index "+h);{if(-1===c)throw new SyntaxError("Unexpected character at index "+h);-1===l&&(l=h);let o=e.slice(c,l);i&&(o=o.replace(/\\/g,""),i=!1),xt(n,r,o),44===u&&(xt(t,s,n),n=Object.create(null),s=void 0),r=void 0,c=l=-1}}else-1===l&&(l=h)}if(-1===c||a)throw new SyntaxError("Unexpected end of input");-1===l&&(l=h);const u=e.slice(c,l);return void 0===s?xt(t,u,n):(void 0===r?xt(n,u,!0):xt(n,r,i?u.replace(/\\/g,""):u),xt(t,s,n)),t}};const{randomBytes:Et,createHash:Pt}=d,{URL:Ot}=p,{BINARY_TYPES:It,EMPTY_BUFFER:Nt,GUID:Tt,kStatusCode:Lt,kWebSocket:Mt,NOOP:Rt}=ae,{addEventListener:jt,removeEventListener:Dt}=St,{format:Ft,parse:$t}=Ct,{toBuffer:Ut}=Te,Bt=["CONNECTING","OPEN","CLOSING","CLOSED"],At=[8,13];class qt extends a{constructor(e,t,s){super(),this._binaryType=It[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage="",this._closeTimer=null,this._extensions={},this._protocol="",this._readyState=qt.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,Array.isArray(t)?t=t.join(", "):"object"==typeof t&&null!==t&&(s=t,t=void 0),function e(t,s,r,n){const i={protocolVersion:At[1],maxPayload:104857600,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...n,createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:void 0,host:void 0,path:void 0,port:void 0};if(!At.includes(i.protocolVersion))throw new RangeError(`Unsupported protocol version: ${i.protocolVersion} (supported versions: ${At.join(", ")})`);let o;s instanceof Ot?(o=s,t._url=s.href):(o=new Ot(s),t._url=s);const a="ws+unix:"===o.protocol;if(!(o.host||a&&o.pathname))throw new Error("Invalid URL: "+t.url);const h="wss:"===o.protocol||"https:"===o.protocol,u=h?443:80,d=Et(16).toString("base64"),p=h?l.get:c.get;let f;i.createConnection=h?Gt:Jt,i.defaultPort=i.defaultPort||u,i.port=o.port||u,i.host=o.hostname.startsWith("[")?o.hostname.slice(1,-1):o.hostname,i.headers={"Sec-WebSocket-Version":i.protocolVersion,"Sec-WebSocket-Key":d,Connection:"Upgrade",Upgrade:"websocket",...i.headers},i.path=o.pathname+o.search,i.timeout=i.handshakeTimeout,i.perMessageDeflate&&(f=new Je(!0!==i.perMessageDeflate?i.perMessageDeflate:{},!1,i.maxPayload),i.headers["Sec-WebSocket-Extensions"]=Ft({[Je.extensionName]:f.offer()}));r&&(i.headers["Sec-WebSocket-Protocol"]=r);i.origin&&(i.protocolVersion<13?i.headers["Sec-WebSocket-Origin"]=i.origin:i.headers.Origin=i.origin);(o.username||o.password)&&(i.auth=`${o.username}:${o.password}`);if(a){const e=i.path.split(":");i.socketPath=e[0],i.path=e[1]}let m=t._req=p(i);i.timeout&&m.on("timeout",()=>{Vt(t,m,"Opening handshake has timed out")});m.on("error",e=>{t._req.aborted||(m=t._req=null,t._readyState=qt.CLOSING,t.emit("error",e),t.emitClose())}),m.on("response",o=>{const a=o.headers.location,c=o.statusCode;if(a&&i.followRedirects&&c>=300&&c<400){if(++t._redirects>i.maxRedirects)return void Vt(t,m,"Maximum redirects exceeded");m.abort();const o=new Ot(a,s);e(t,o,r,n)}else t.emit("unexpected-response",m,o)||Vt(t,m,"Unexpected server response: "+o.statusCode)}),m.on("upgrade",(e,s,n)=>{if(t.emit("upgrade",e),t.readyState!==qt.CONNECTING)return;m=t._req=null;const o=Pt("sha1").update(d+Tt).digest("base64");if(e.headers["sec-websocket-accept"]!==o)return void Vt(t,s,"Invalid Sec-WebSocket-Accept header");const a=e.headers["sec-websocket-protocol"],c=(r||"").split(/, */);let l;if(!r&&a?l="Server sent a subprotocol but none was requested":r&&!a?l="Server sent no subprotocol":a&&!c.includes(a)&&(l="Server sent an invalid subprotocol"),l)Vt(t,s,l);else{if(a&&(t._protocol=a),f)try{const s=$t(e.headers["sec-websocket-extensions"]);s[Je.extensionName]&&(f.accept(s[Je.extensionName]),t._extensions[Je.extensionName]=f)}catch(e){return void Vt(t,s,"Invalid Sec-WebSocket-Extensions header")}t.setSocket(s,n,i.maxPayload)}})}(this,e,t,s)):this._isServer=!0}get binaryType(){return this._binaryType}set binaryType(e){It.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,s){const r=new at(this.binaryType,this._extensions,this._isServer,s);this._sender=new _t(e,this._extensions),this._receiver=r,this._socket=e,r[Mt]=this,e[Mt]=this,r.on("conclude",Yt),r.on("drain",zt),r.on("error",Qt),r.on("message",Zt),r.on("ping",Xt),r.on("pong",es),e.setTimeout(0),e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",ts),e.on("data",ss),e.on("end",rs),e.on("error",ns),this._readyState=qt.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=qt.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[Je.extensionName]&&this._extensions[Je.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=qt.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==qt.CLOSED){if(this.readyState===qt.CONNECTING){const e="WebSocket was closed before the connection was established";return Vt(this,this._req,e)}this.readyState!==qt.CLOSING?(this._readyState=qt.CLOSING,this._sender.close(e,t,!this._isServer,e=>{e||(this._closeFrameSent=!0,this._closeFrameReceived&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),3e4)):this._closeFrameSent&&this._closeFrameReceived&&this._socket.end()}}ping(e,t,s){if(this.readyState===qt.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(s=e,e=t=void 0):"function"==typeof t&&(s=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===qt.OPEN?(void 0===t&&(t=!this._isServer),this._sender.ping(e||Nt,t,s)):Ht(this,e,s)}pong(e,t,s){if(this.readyState===qt.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(s=e,e=t=void 0):"function"==typeof t&&(s=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===qt.OPEN?(void 0===t&&(t=!this._isServer),this._sender.pong(e||Nt,t,s)):Ht(this,e,s)}send(e,t,s){if(this.readyState===qt.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(s=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==qt.OPEN)return void Ht(this,e,s);const r={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[Je.extensionName]||(r.compress=!1),this._sender.send(e||Nt,r,s)}terminate(){if(this.readyState!==qt.CLOSED){if(this.readyState===qt.CONNECTING){const e="WebSocket was closed before the connection was established";return Vt(this,this._req,e)}this._socket&&(this._readyState=qt.CLOSING,this._socket.destroy())}}}Bt.forEach((e,t)=>{const s={enumerable:!0,value:t};Object.defineProperty(qt.prototype,e,s),Object.defineProperty(qt,e,s)}),["binaryType","bufferedAmount","extensions","protocol","readyState","url"].forEach(e=>{Object.defineProperty(qt.prototype,e,{enumerable:!0})}),["open","error","close","message"].forEach(e=>{Object.defineProperty(qt.prototype,"on"+e,{configurable:!0,enumerable:!0,get(){const t=this.listeners(e);for(let e=0;e<t.length;e++)if(t[e]._listener)return t[e]._listener},set(t){const s=this.listeners(e);for(let t=0;t<s.length;t++)s[t]._listener&&this.removeListener(e,s[t]);this.addEventListener(e,t)}})}),qt.prototype.addEventListener=jt,qt.prototype.removeEventListener=Dt;var Wt=qt;function Jt(e){return e.path=e.socketPath,h.connect(e)}function Gt(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=e.host),u.connect(e)}function Vt(e,t,s){e._readyState=qt.CLOSING;const r=new Error(s);Error.captureStackTrace(r,Vt),t.setHeader?(t.abort(),t.once("abort",e.emitClose.bind(e)),e.emit("error",r)):(t.destroy(r),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function Ht(e,t,s){if(t){const s=Ut(t).length;e._socket?e._sender._bufferedBytes+=s:e._bufferedAmount+=s}if(s){s(new Error(`WebSocket is not open: readyState ${e.readyState} (${Bt[e.readyState]})`))}}function Yt(e,t){const s=this[Mt];s._socket.removeListener("data",ss),s._socket.resume(),s._closeFrameReceived=!0,s._closeMessage=t,s._closeCode=e,1005===e?s.close():s.close(e,t)}function zt(){this[Mt]._socket.resume()}function Qt(e){const t=this[Mt];t._socket.removeListener("data",ss),t._readyState=qt.CLOSING,t._closeCode=e[Lt],t.emit("error",e),t._socket.destroy()}function Kt(){this[Mt].emitClose()}function Zt(e){this[Mt].emit("message",e)}function Xt(e){const t=this[Mt];t.pong(e,!t._isServer,Rt),t.emit("ping",e)}function es(e){this[Mt].emit("pong",e)}function ts(){const e=this[Mt];this.removeListener("close",ts),this.removeListener("end",rs),e._readyState=qt.CLOSING,e._socket.read(),e._receiver.end(),this.removeListener("data",ss),this[Mt]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",Kt),e._receiver.on("finish",Kt))}function ss(e){this[Mt]._receiver.write(e)||this.pause()}function rs(){const e=this[Mt];e._readyState=qt.CLOSING,e._receiver.end(),this.end()}function ns(){const e=this[Mt];this.removeListener("error",ns),this.on("error",Rt),e&&(e._readyState=qt.CLOSING,this.destroy())}const{Duplex:is}=m;function os(e){e.emit("close")}function as(){!this.destroyed&&this._writableState.finished&&this.destroy()}function cs(e){this.removeListener("error",cs),this.destroy(),0===this.listenerCount("error")&&this.emit("error",e)}var ls=function(e,t){let s=!0;function r(){s&&e._socket.resume()}e.readyState===e.CONNECTING?e.once("open",(function(){e._receiver.removeAllListeners("drain"),e._receiver.on("drain",r)})):(e._receiver.removeAllListeners("drain"),e._receiver.on("drain",r));const n=new is({...t,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return e.on("message",(function(t){n.push(t)||(s=!1,e._socket.pause())})),e.once("error",(function(e){n.destroyed||n.destroy(e)})),e.once("close",(function(){n.destroyed||n.push(null)})),n._destroy=function(t,s){if(e.readyState===e.CLOSED)return s(t),void process.nextTick(os,n);let r=!1;e.once("error",(function(e){r=!0,s(e)})),e.once("close",(function(){r||s(t),process.nextTick(os,n)})),e.terminate()},n._final=function(t){e.readyState!==e.CONNECTING?null!==e._socket&&(e._socket._writableState.finished?(t(),n._readableState.endEmitted&&n.destroy()):(e._socket.once("finish",(function(){t()})),e.close())):e.once("open",(function(){n._final(t)}))},n._read=function(){e.readyState!==e.OPEN||s||(s=!0,e._receiver._writableState.needDrain||e._socket.resume())},n._write=function(t,s,r){e.readyState!==e.CONNECTING?e.send(t,r):e.once("open",(function(){n._write(t,s,r)}))},n.on("end",as),n.on("error",cs),n};const{createHash:hs}=d,{createServer:us,STATUS_CODES:ds}=c,{format:ps,parse:fs}=Ct,{GUID:ms,kWebSocket:_s}=ae,gs=/^[+/0-9A-Za-z]{22}==$/;var vs=class extends a{constructor(e,t){if(super(),null==(e={maxPayload:104857600,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,...e}).port&&!e.server&&!e.noServer)throw new TypeError('One of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=us((e,t)=>{const s=ds[426];t.writeHead(426,{"Content-Length":s.length,"Content-Type":"text/plain"}),t.end(s)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){const e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(const s of Object.keys(t))e.on(s,t[s]);return function(){for(const s of Object.keys(t))e.removeListener(s,t[s])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,s,r)=>{this.handleUpgrade(t,s,r,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set),this.options=e}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(e&&this.once("close",e),this.clients)for(const e of this.clients)e.terminate();const t=this._server;t&&(this._removeListeners(),this._removeListeners=this._server=null,null!=this.options.port)?t.close(()=>this.emit("close")):process.nextTick(ys,this)}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,s,r){t.on("error",ws);const n=void 0!==e.headers["sec-websocket-key"]&&e.headers["sec-websocket-key"].trim(),i=+e.headers["sec-websocket-version"],o={};if("GET"!==e.method||"websocket"!==e.headers.upgrade.toLowerCase()||!n||!gs.test(n)||8!==i&&13!==i||!this.shouldHandle(e))return bs(t,400);if(this.options.perMessageDeflate){const s=new Je(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const t=fs(e.headers["sec-websocket-extensions"]);t[Je.extensionName]&&(s.accept(t[Je.extensionName]),o[Je.extensionName]=s)}catch(e){return bs(t,400)}}if(this.options.verifyClient){const a={origin:e.headers[""+(8===i?"sec-websocket-origin":"origin")],secure:!(!e.connection.authorized&&!e.connection.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(a,(i,a,c,l)=>{if(!i)return bs(t,a||401,c,l);this.completeUpgrade(n,o,e,t,s,r)});if(!this.options.verifyClient(a))return bs(t,401)}this.completeUpgrade(n,o,e,t,s,r)}completeUpgrade(e,t,s,r,n,i){if(!r.readable||!r.writable)return r.destroy();if(r[_s])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");const o=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+hs("sha1").update(e+ms).digest("base64")],a=new Wt(null);let c=s.headers["sec-websocket-protocol"];if(c&&(c=c.trim().split(/ *, */),c=this.options.handleProtocols?this.options.handleProtocols(c,s):c[0],c&&(o.push("Sec-WebSocket-Protocol: "+c),a._protocol=c)),t[Je.extensionName]){const e=t[Je.extensionName].params,s=ps({[Je.extensionName]:[e]});o.push("Sec-WebSocket-Extensions: "+s),a._extensions=t}this.emit("headers",o,s),r.write(o.concat("\r\n").join("\r\n")),r.removeListener("error",ws),a.setSocket(r,n,this.options.maxPayload),this.clients&&(this.clients.add(a),a.on("close",()=>this.clients.delete(a))),i(a,s)}};function ys(e){e.emit("close")}function ws(){this.destroy()}function bs(e,t,s,r){e.writable&&(s=s||ds[t],r={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(s),...r},e.write(`HTTP/1.1 ${t} ${ds[t]}\r\n`+Object.keys(r).map(e=>`${e}: ${r[e]}`).join("\r\n")+"\r\n\r\n"+s)),e.removeListener("error",ws),e.destroy()}Wt.createWebSocketStream=ls,Wt.Server=vs,Wt.Receiver=at,Wt.Sender=_t;var Ss=Wt,ks=ie((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});class s extends Error{constructor(e){super(e.message),this._code=e.code||0,this._data=e.data||null}get code(){return this._code}get data(){return this._data}}t.MessageError=s;class r extends a.EventEmitter{constructor(e,t){if(super(),this._responsePromiseMap=new Map,this._nextMessageId=0,this._connected=!1,this._emitLog=!1,this._consoleLog=!1,this._requestQueue=[],this.setLogging(t),!e)throw new TypeError("socket cannot be undefined or null");this._socket=e,e.on("open",()=>{this._connected=!0,this._sendQueuedRequests()}),e.on("message",e=>this.processMessage(e))}processMessage(e){let t;this._logMessage(e,"receive");try{t=JSON.parse(e)}catch(e){return this.emit("error",e)}if(t)if(t.id)if(this._responsePromiseMap.has(t.id)){const r=this._responsePromiseMap.get(t.id);t.result?r.resolve(t.result):t.error?r.reject(new s(t.error)):this.emit("error",new Error("Response must have result or error: "+e))}else this.emit("error",new Error(`Response with id:${t.id} has no pending request`));else t.method?this.emit(t.method,t.params):this.emit("error",new Error("Invalid message: "+e));else this.emit("error",new Error("Message cannot be null, empty or undefined"))}setLogging({logEmit:e,logConsole:t}={}){this._emitLog=e,this._consoleLog=t}_send(e){this._requestQueue.push(JSON.stringify(e)),this._sendQueuedRequests()}_sendQueuedRequests(){if(this._connected){for(let e of this._requestQueue)this._logMessage(e,"send"),this._socket.send(e);this._requestQueue=[]}}_logMessage(e,t){this._consoleLog&&console.log("Client "+("send"===t?">":"<"),e),this._emitLog&&this.emit(t,e)}call(e,t){const s=++this._nextMessageId,r={id:s,method:e,params:t};return new Promise((e,t)=>{try{this._send(r),this._responsePromiseMap.set(s,{resolve:e,reject:t})}catch(e){return t(e)}})}notify(e,t){this._send({method:e,params:t})}api(e){if(!Proxy)throw new Error("api() requires ES6 Proxy. Please use an ES6 compatible engine");return new Proxy({},{get:(t,s)=>{if(t[s])return t[s];if("__proto__"===s||"prototype"===s)return Object.prototype;if(void 0===e)t[s]=this.api(s+".");else if("on"===s)t[s]=(t,s)=>this.on(`${e}${t}`,s);else if("emit"===s)t[s]=(t,s)=>this.notify(`${e}${t}`,s);else if("on"===s.substr(0,2)&&s.length>3){const r=s[2].toLowerCase()+s.substr(3);t[s]=t=>this.on(`${e}${r}`,t)}else if("emit"===s.substr(0,4)&&s.length>5){const r=s[4].toLowerCase()+s.substr(5);t[s]=t=>this.notify(`${e}${r}`,t)}else{const r=s;t[s]=t=>this.call(`${e}${r}`,t)}return t[s]}})}}t.Client=r;class n extends a.EventEmitter{constructor(e,t){if(super(),this._exposedMethodsMap=new Map,this._emitLog=!1,this._consoleLog=!1,this.setLogging(t),!e)throw new TypeError("server cannot be undefined or null");this._socketServer=e,e.on("connection",e=>{e.on("message",t=>this.processMessage(t,e))})}processMessage(e,t){let s;this._logMessage(e,"receive");try{s=JSON.parse(e)}catch(e){return this._sendError(t,s,-32700)}if(s&&s.method&&"string"==typeof s.method)if(s.id&&"number"==typeof s.id){const e=this._exposedMethodsMap.get(s.method);if(e)try{const r=e.call(null,s.params);r instanceof Promise?r.then(e=>{this._send(t,{id:s.id,result:e||{}})}).catch(e=>{this._sendError(t,s,-32603,e)}):this._send(t,{id:s.id,result:r||{}})}catch(e){this._sendError(t,s,-32603,e)}else this._sendError(t,s,-32601)}else this.emit(s.method,s.params);else this._sendError(t,s,-32600)}setLogging({logEmit:e,logConsole:t}={}){this._emitLog=e,this._consoleLog=t}_logMessage(e,t){this._consoleLog&&console.log("Server "+("send"===t?">":"<"),e),this._emitLog&&this.emit(t,e)}_send(e,t){const s=JSON.stringify(t);this._logMessage(s,"send"),e.send(s)}_sendError(e,t,s,r){try{this._send(e,{id:t&&t.id||-1,error:this._errorFromCode(s,r&&r.message||r,t&&t.method)})}catch(r){}}_errorFromCode(e,t,s){let r="";switch(e){case-32603:r=`InternalError: Internal Error when calling '${s}'`;break;case-32601:r=`MethodNotFound: '${s}' wasn't found`;break;case-32600:r="InvalidRequest: JSON sent is not a valid request object";break;case-32700:r="ParseError: invalid JSON received"}return{code:e,message:r,data:t}}expose(e,t){this._exposedMethodsMap.set(e,t)}notify(e,t){if(!this._socketServer.clients)throw new Error('SocketServer does not support broadcasting. No "clients: LikeSocket[]" property found');for(let s of this._socketServer.clients)this._send(s,{method:e,params:t})}api(e){if(!Proxy)throw new Error("api() requires ES6 Proxy. Please use an ES6 compatible engine");return new Proxy({},{get:(t,s)=>{if(t[s])return t[s];if("__proto__"===s||"prototype"===s)return Object.prototype;if(void 0===e)t[s]=this.api(s+".");else if("on"===s)t[s]=(t,s)=>this.on(`${e}${t}`,s);else if("emit"===s)t[s]=(t,s)=>this.notify(`${e}${t}`,s);else if("on"===s.substr(0,2)&&s.length>3){const r=s[2].toLowerCase()+s.substr(3);t[s]=t=>this.on(`${e}${r}`,t)}else if("emit"===s.substr(0,4)&&s.length>5){const r=s[4].toLowerCase()+s.substr(5);t[s]=t=>this.notify(`${e}${r}`,t)}else{if("expose"!==s)return;t[s]=t=>{if(!t||"object"!=typeof t)throw new Error("Expected an iterable object to expose functions");for(let s in t)"function"==typeof t[s]&&this.expose(`${e}${s}`,t[s].bind(t))}}return t[s]}})}}t.Server=n}));class xs extends o.EventEmitter{constructor(){super(),this._port=void 0,this._host=void 0,this._ws=void 0}async connect(e,t){this._port=e,this._host=t;const s=await this._discoverWebsocketPath();this._ws=new Ss(s);const r=new ks.Client(this._ws,{logConsole:!1}).api();var n;r.Runtime.enable(),await(n=100,new Promise((e,t)=>{setTimeout(()=>{e()},n)})),this._api=r,this._api.Runtime.on("consoleAPICalled",e=>{this.emit("consoleAPICalled",e)}),this._api.Runtime.on("exceptionThrown",e=>{this.emit("exceptionThrown",e)}),this._api.Runtime.on("executionContextDestroyed",e=>{this.emit("executionContextDestroyed",e)})}async disconnect(){this._ws.close(),this.status="disconnect"}api(){return this._api}async generateObjectStr(e,t=20){let s="{",r=!0;for(let n=0;n<e.length;n++){const i=e[n];if(!i.enumerable)continue;r=!1;const{type:o,subtype:a,description:c,objectId:l,value:h}=i.value,u=a||o;let d=void 0!==h?h:c;switch(u){case"object":case"array":d=await this.getObject(l,u,t-1),d||(d='"<层级过深，无法展示内容>"');break;case"date":d=`new Date("${d}")`}s+=`"${i.name}"`,s+=":",s+="string"===u?JSON.stringify(d):d,s+=","}return r||(s=s.slice(0,-1)),s+="}",s}async generateArrayStr(e,t=20){let s="[",r=!0;for(let n=0;n<e.length;n++){const i=e[n];if(!i.enumerable)continue;r=!1;const{type:o,subtype:a,description:c,objectId:l,value:h}=i.value,u=a||o;let d=void 0!==h?h:c;switch(u){case"object":case"array":d=await this.getObject(l,u,t-1),d||(d='"<层级过深，无法展示内容>"');break;case"date":d=`new Date("${d}")`}s+="string"===u?JSON.stringify(d):d,s+=","}return r||(s=s.slice(0,-1)),s+="]",s}async getObject(e,t,s=20){if(s<0)return!1;const r=await this.api().Runtime.getProperties({objectId:e,ownProperties:!0});switch(t){case"object":return this.generateObjectStr(r.result,s);case"array":return this.generateArrayStr(r.result,s)}}_discoverWebsocketPath(){return this._fetchJSON("/json").then(([{webSocketDebuggerUrl:e}])=>e)}_fetchJSON(e){return new Promise((t,s)=>{const r=c.get({host:this._host,port:this._port,path:e}),n=[];r.on("error",s),r.on("response",(function(e){e.on("error",s),e.on("data",e=>n.push(e)),e.on("end",(function(){const r=Buffer.concat(n).toString();if(200===e.statusCode)try{t(JSON.parse(r))}catch(e){s(new Error("Response didn't contain JSON: "+r))}else s(new Error(`Unexpected ${e.statusCode}: ${r}`))}))}))})}}const Cs=/^((?:[A-Za-z]:)?(?:[\\/][^/:?#]+)+)(?::(\d+))?(?::(\d+))?$/;function Es(e){const t=[],s=e.length;let r=0,n="",i=r;for(;r<=s;){const s=e.charAt(r);if(s&&-1===" \t()<>[]'\"、。｡､，．：；‘“〈《「『【〔（［｛｢｣｝］）〕】』」》〉”’｀～…".indexOf(s))n+=s;else{if(n){const e=n.match(Cs),s=r;if(e){const{1:r,2:n,3:o}=e;t.push({linkPosition:{start:i,end:s},onOpen:function(){P.workspace.openTextDocument(r).then(e=>{P.window.showTextDocument(e,{selection:{start:{line:Number(n),character:Number(o)-1}}})})}})}}n="",i=r+1}r++}return{text:e,hyperlinks:t}}const Ps=[/\[INSPECTOR_ASYNC_STACK_TRACES_NOT_AVAILABLE\]/];class Os extends o.EventEmitter{constructor({title:e,id:t,workspaceFolder:s,provider:r,name:n,uniCloudInfo:i}){super(),this.workspaceFolder=s,this.title=e,this.id=t,this.provider=r,this.name=n,this.uniCloudInfo=i,this._outputView=null,this._show=!1,this.updateProvider(this.provider),this._init()}updateProvider(e){this.provider=e;const t=this.uniCloudInfo.find(t=>t.provider===e);this.spaceName=t&&t.name;const s="aliyun"===this.provider?"阿里云":"腾讯云";this.outputPrefix=1===this.uniCloudInfo.length?"[本地调试]":`[本地云函数调试:${s}:${this.spaceName}]`,this.outputPrefixLength=this.outputPrefix.length}appendMultiline({level:e="info",lastFrame:t,lines:s}){for(let r=0;r<s.length;r++){const n=s[r];let i=n.text;const o=n.hyperlinks||[];if(r===s.length-1&&t){const e=t.lineNumber+1,s=t.columnNumber,r=`${t.relativeUrl}:${e}:${s}`;o.push({linkPosition:{start:i.length+1,end:i.length+1+r.length},onOpen:async function(){P.workspace.openTextDocument(t.url).then(t=>{P.window.showTextDocument(t,{selection:{start:{line:e,character:s}}})})}}),i=i+" "+r}this.appendLine({level:e,line:i,hyperlinks:o})}}appendConsole({level:e="info",lastFrame:t,lines:s,multiline:r}){this.show();let n="",i=[];if(r)this.appendMultiline({level:e,lastFrame:t,lines:s});else{for(let e=0;e<s.length;e++){const t=s[e],r=n.length;n+=t.text+" ",t.hyperlinks&&(i=i.concat(t.hyperlinks.map(e=>(e.linkPosition.start+=r,e.linkPosition.end+=r,e))))}if(t){const e=n.length,s=t.lineNumber+1,r=t.columnNumber,o=`${t.relativeUrl}:${s}:${r}`;i.push({linkPosition:{start:e,end:e+o.length},onOpen:async function(){P.workspace.openTextDocument(t.url).then(e=>{P.window.showTextDocument(e,{selection:{start:{line:s,character:r}}})})}}),n+=o}this.appendLine({level:e,line:n,hyperlinks:i})}}appendPossibleHyperLink({line:e,hyperlinks:t=[]}={}){const{hyperlinks:s}=Es(e);return s.filter(({linkPosition:e}={})=>!t.some(({linkPosition:t}={})=>e.start<=t.end&&e.end>=t.start))}appendLine(e){Ps.some(t=>t.test(e.line))||(this._show||!1===e.forceshow||this.show(),e.line=this.outputPrefix+e.line,e.hyperlinks=e.hyperlinks||[],e.hyperlinks.forEach(e=>{e.linkPosition.start=e.linkPosition.start+this.outputPrefixLength,e.linkPosition.end=e.linkPosition.end+this.outputPrefixLength}),e.hyperlinks.push(...this.appendPossibleHyperLink({line:e.line,hyperlinks:e.hyperlinks})),this._outputView.appendLine(e))}show(){!this._show&&this._outputView&&(this._outputView.show(),this._show=!0)}_init(){this._outputView=P.window.createOutputView({id:this.id,title:this.title})}disconnect(){}}function Is(e){let t="{";const s=e.properties.length>10,r=Math.min(e.properties.length,10);for(let s=0;s<r;s++){const r=e.properties[s],n=r.value;t+=`"${r.name}"`,t+=":",t+="string"===r.type?JSON.stringify(n):n,t+=","}return s?t+="...":r&&(t=t.slice(0,-1)),t+="}",t}function Ns(e){let t="[";const s=e.properties.length>10,r=Math.min(e.properties.length,10);for(let s=0;s<r;s++){const r=e.properties[s],n=r.value;t+="string"===r.type?JSON.stringify(n):n,t+=","}return s?t+="...":r&&(t=t.slice(0,-1)),t+="]",t}const Ts={plainParser:e=>({text:Is(e.preview),objectId:e.objectId,objectType:"object"}),typedarrayParser:e=>({text:Ns(e.preview)}),arrayParser:e=>({text:Ns(e.preview),objectId:e.objectId,objectType:"array"}),nullParser:()=>({text:"null"}),errorParser:e=>({multiline:!0,text:e.description}),defaultParser:e=>({text:e.description})},Ls={objectParser:e=>{if(!e.subtype)return Ts.plainParser(e);let t=e.subtype+"Parser";return Ts[t]||(t="defaultParser"),Ts[t](e)},undefinedParser:()=>({text:"undefined"}),stringParser:e=>({text:JSON.stringify(e.value)}),defaultParser:e=>({text:void 0!==e.value?e.value+"":e.description})};function Ms(e){return e=e.replace(/\\/g,"/").replace("win32"===process.platform?"file:///":"file://",""),e=decodeURIComponent(e)}class Rs extends o.EventEmitter{parseConsole(e){const{type:s,args:r,stackTrace:n,timestamp:i}=e,o=function(e){return e.map(e=>{let t=e.type?e.type+"Parser":"defaultParser";return Ls[t]||(t="defaultParser"),Ls[t](e)})}(r),a={error:"error",warn:"warning"}[s]||"info";let c;const l=H(this.workspaceFolder),h=H(t.resolve(__dirname,"../"));if(n&&n.callFrames){if(c=n.callFrames.find(e=>l.test(Ms(e.url))),!c){const e=n.callFrames[0];h.test(Ms(e.url))||(c=e)}c&&(c.url=Ms(c.url),c.relativeUrl=c.url.replace(l,""))}return{level:a,parsedArgs:o,multiline:o.some(e=>e.multiline),lastFrame:c,timestamp:i}}parseUncaughtException({exceptionDetails:e,timestamp:t}={}){return this.parseConsole({type:"error",args:e.exception,stackTrace:e.stackTrace,timestamp:t})}parseText(e){const t=this.inspector;let s=[];for(let r=0;r<e.length;r++){const n=e[r];if(n.objectId&&n.objectType){n.hyperlinks=[{linkPosition:{start:0,end:n.text.length},onOpen:async function(){if("disconnect"===t.status)P.workspace.openTextDocument({content:"调试已结束，无法再进行变量预览",language:"txt"});else{const e=await t.getObject(n.objectId,n.objectType);P.workspace.openTextDocument({content:e,language:"javascript"})}}}],s.push(n);continue}const i=n.text.replace(/\r\n/g,"\n").split("\n").map(e=>Es(e));s=s.concat(i)}return s}async parseTextAsync(e){const t=this.inspector;let s=[];for(let r=0;r<e.length;r++){const n=e[r];if(n.objectId&&n.objectType){const e=await t.getObject(n.objectId,n.objectType);n.hyperlinks=[{linkPosition:{start:0,end:n.text.length},onOpen:async function(){P.workspace.openTextDocument({content:e,language:"javascript"})}}],s.push(n);continue}const i=n.text.replace(/\r\n/g,"\n").split("\n").map(e=>Es(e));s=s.concat(i)}return s}}class js extends Rs{constructor({workspaceFolder:e,workspaceId:t,name:s,clientInfo:r,uniCloudInfo:n,runMode:i="run"}){super(),this.workspaceFolder=e,this.workspaceId=t,this.clientInfo={},this.name=s,this.runMode=i,this.addClient(r),this.uniCloudInfo=n;const o=this.getLaunchConfig(),a=o&&o.provider;if(this.uniCloudConfig=o,a){if(!this.uniCloudInfo.find(e=>e.provider===a))throw new _({code:"SYSTEM_ERROR",message:"launch.json内配置的provider在本项目中不可用"});this.provider=a}else switch(n.length){case 0:throw new _({code:"SYSTEM_ERROR",message:"项目未绑定uniCloud服务空间，uniCloud本地调试服务未启动，请绑定后重试"});case 1:this.provider=n[0].provider;break;case 2:throw new _({code:"SYSTEM_ERROR",message:"项目绑定了多个服务空间，请在项目目录下的.hbuilderx/launch.json内配置provider指定本地调试使用的服务空间"});default:throw new _({code:"SYSTEM_ERROR",message:"获取项目uniCloud配置出错"})}this.status="ready",this.outputChannelTitle=`[${this.name}] - uniCloud控制台`,this.outputChannelId=this.workspaceId+"-unicloud"}async getSecret({provider:e}){const t=this.uniCloudInfo.find(t=>t.provider===e),s=t.spaceId;return Z({provider:e,spaceId:s,appId:t.appId,useCache:!0})}notify({level:e="info",info:t,forceshow:s}){this.outputChannel.appendLine({level:e,line:t,forceshow:s})}getLaunchConfig(){const e=t.resolve(this.workspaceFolder,".hbuilderx/launch.json");if(r.existsSync(e))try{const t=function(e){const t=r.readFileSync(e).toString().replace("\r\n","\n").replace("\r","\n");return E(t)}(e);return(t.configurations||[]).find(e=>"uniCloud"===e.type)}catch(e){throw new _({code:"SYSTEM_ERROR",message:"项目目录下.hbuilderx/launch.json格式不正确，请检查"})}}async checkDependency({provider:e}){const s=q.getRealWorkspace({uniCloudInfo:this.uniCloudInfo,workspaceFolder:this.workspaceFolder,provider:e});if(!s)return;const n=await ee(),i=q.getCloudfunctionPathList(s,e);for(let e=0;e<i.length;e++){const s=i[e],o=q.getFunctionPathList(s),a=await se(o,{npmCmd:n}),c=q.getCommonModulePathList(s),l=await re(c,{npmCmd:n}),h=a.concat(l).filter(e=>"local"!==e.type);if(0===h.length)continue;this.notify({level:"warning",info:"检测到以下本地云函数/公共模块缺失依赖，可能影响本地云函数调试、运行，正在进行安装..."});const u=h.filter(e=>"local"!==e.type).map(({dir:e,functionPath:t,commonModulePath:s})=>{const r=e.replace(/\\/g,"/").split("/").pop();return s?"common/"+r:r});this.notify({level:"info",info:"缺少依赖的本地云函数/公共模块："+u.join("、")});for(let e=0;e<h.length;e++){const s=h[e],i=s.dir,o=i.replace(/\\/g,"/").split("/").pop(),a=s.commonModulePath?"公共模块":"云函数";try{"local"!==s.type&&this.notify({level:"info",info:`${a}${o}开始安装依赖`}),await ne(i,{npmCmd:n}),"local"!==s.type&&this.notify({level:"info",info:`${a}${o}依赖安装完成`})}catch(e){const n=t.resolve(i,"node_modules");r.existsSync(n)&&this.notify({level:"warning",info:`文件夹(${i})中存在node_modules，且其中依赖缺失，如果出现依赖安装失败的错误请手动删除此node_modules再试`});("local"!==s.type?`${a}${o}依赖安装失败\n${e.message}`:`${a}${o}引入公共模块失败\n${e.message}`).split("\n").forEach(e=>{this.notify({level:"error",info:e})})}}}}async pollSecret({provider:e,retry:t=0}){let s,r;try{const t=await this.getSecret({provider:e});s=t.uniCloudSecret,r=t.restTime}catch(e){return this.notify({level:"error",info:e.message||"获取本地运行参数失败，请检查网络是否正常"}),{}}return{uniCloudSecret:s,restTime:r}}async syncSecret({provider:e}){const{uniCloudSecret:t,restTime:s}=await this.pollSecret({provider:e}),r=Date.now()+1e3*Number(s);if(!t)throw new _({code:"REQUEST_ERROR",message:"获取本地运行参数失败"});return{uniCloudSecret:t,expired:r,provider:e}}initBridge(e){this._jsonRpcServer=new q.JsonRpcServer({bridgeProcess:e}),this._jsonRpcServer.expose("syncSecret",({provider:e}={})=>this.syncSecret({provider:e}))}async startServer(){const e=i.fork("../server/index.js",{execArgv:(this.runMode,["--inspect=0"]),cwd:__dirname,silent:!0,env:{WORKSPACE_FOLDER:this.workspaceFolder,UNICLOUD_INFO:JSON.stringify(this.uniCloudInfo),SPACE_PROVIDER:this.provider,UNICLOUD_DEBUGGER_PATH:process.env.UNICLOUD_DEBUGGER_PATH,UNICLOUD_PLUGIN_PID:process.pid}});this.initBridge(e);const{Transform:t}=require("stream"),s=new t({transform:function(e,t,s){s()}});e.stdout.pipe(s),this.serverProcess=e;const r=this;return new Promise((t,s)=>{e.on("message",(function n(i){if("object"==typeof i)switch(i.action){case"server/start":{const{address:s,servePort:o,debugPort:a}=i.data;r.address=s,r.servePort=o,r.debugPort=a,r.status="start",e.removeListener("message",n),t();break}case"server/error":{const{code:t,message:r,detail:o}=i.data;if(e.removeListener("message",n),"EADDRINUSE"===t)return void s(new _({code:"EADDRINUSE",message:`指定端口（${o.servePort}）冲突，请重新指定或者直接去除此项配置`}));s(new _({code:t,message:r}));break}}})),setTimeout(()=>{s(new _({code:"SERVER_START_TIMEOUT",message:"本地调试服务启动超时"}))},5e3)})}updateProvider(e){this.provider=e,this.outputChannel.updateProvider(e)}getPlatformLaunchType(e,t){return e&&e[t]&&e[t].launchtype||e&&e.default&&e.default.launchtype||"remote"}checkConfig(){let e;try{e=this.getLaunchConfig()}catch(e){}const t=e&&e.provider;if(t&&t!==this.provider){const e={tcb:"腾讯云",aliyun:"阿里云"},s=this.uniCloudInfo.find(e=>e.provider===t);if(!s)return void this.notify({level:"error",info:".hbuilderx/launch.json内配置的provider在本项目下不可用"});this.updateProvider(t),this.notify({level:"warning",info:`当前uniCloud本地调试服务使用的服务空间将切换为:[${e[t]}:${s.name}]`})}const s=this.uniCloudConfig,r=this.uniCloudInfo.find(e=>e.provider===this.provider);["h5","mp-weixin","app-plus","mp-baidu","mp-alipay","mp-toutiao","mp-qq","mp-360"].forEach(t=>{const n=this.getPlatformLaunchType(e,t),i=this.getPlatformLaunchType(s,t);if(n!==i){const e=Object.keys(this.clientInfo).filter(e=>this.clientInfo[e].type===t);e.length&&e.forEach(e=>{this.clientInfo[e]&&this.clientInfo[e].outputView.appendLine({level:"warning",line:"local"===n?"已连接本地云函数环境。注意事项详见：https://uniapp.dcloud.net.cn/uniCloud/quickstart?id=calllocalfunction":"已连接云端云函数环境，服务空间id为"+r.spaceId})})}}),this.uniCloudConfig=e}watchLaunchJson(){const e=t.resolve(this.workspaceFolder,".hbuilderx/launch.json");return r.watch(e,{},()=>{this.checkProviderTimeout&&clearTimeout(this.checkProviderTimeout),this.checkProviderTimeout=setTimeout(()=>{this.checkConfig(),this.checkProviderTimeout=null},300)})}async start(){this.outputChannel=new Os({title:this.outputChannelTitle,id:this.outputChannelId,workspaceFolder:this.workspaceFolder,provider:this.provider,name:this.name,uniCloudInfo:this.uniCloudInfo});for(let e=0;e<this.uniCloudInfo.length;e++){const t=this.uniCloudInfo[e].provider;this.checkDependency({provider:t})}await this.startServer(),this.launchJsonWatcher=this.watchLaunchJson();const e=new xs;this.inspector=e,await e.connect(this.debugPort,"localhost"),e.on("consoleAPICalled",e=>{const t=this.parseConsole(e);t.lines=this.parseText(t.parsedArgs),this.outputChannel.appendConsole(t)}),e.on("exceptionThrown",e=>{const t=this.parseUncaughtException(e);t.lines=this.parseText(t.parsedArgs),this.outputChannel.appendConsole(t)}),this.notify({level:"warning",info:"uniCloud本地调试服务已启动，如需客户端调用本地云函数，请在对应的客户端的运行控制台切换为连接本地云函数",forceshow:!0}),this.notify({level:"error",info:"如需调试本地云函数代码，请点击控制台右上角的调试按钮开启断点调试服务（双击行号添加断点）\n",forceshow:!0})}stop(){this.launchJsonWatcher.close(),this.inspector.disconnect(),this.serverProcess.removeAllListeners(),this.serverProcess.kill(),this.outputChannel.disconnect(),this.status="stop"}addClient(e){this.clientInfo[e.clientConsole._id]=e}deleteClient(e){delete this.clientInfo[e.clientConsole._id],0===Object.keys(this.clientInfo).length&&(this.notify({level:"warning",info:"所有客户端均已停止，uniCloud调试结束",forceshow:!1}),this.stop())}toEnv({platform:e}){const{address:t,servePort:s,debugPort:r}=this;return{address:t,servePort:s,debugPort:r,initialLaunchType:this.getPlatformLaunchType(this.uniCloudConfig,e)}}}let Ds;class Fs extends Os{updateProvider(e){this.provider=e;const t=this.uniCloudInfo.find(t=>t.provider===e);this.spaceName=t&&t.name;const s="aliyun"===this.provider?"阿里云":"腾讯云";this.outputPrefix=1===this.uniCloudInfo.length?"[本地运行]":`[本地运行:${s}:${this.spaceName}]`,this.outputPrefixLength=this.outputPrefix.length}_init(){this._outputView=P.window.createOutputView({id:this.id,title:this.title})}disconnect(){}}class $s extends Rs{constructor({workspaceFolder:e,workspaceId:t,name:s,uniCloudInfo:r,provider:n,port:i,isHxDebugMode:o}){super(),this.workspaceFolder=e,this.workspaceId=t,this.name=s,this.uniCloudInfo=r,this.provider=n,this.debugPort=i,this.isHxDebugMode=o,this.outputChannelTitle=`[${this.name}] - uniCloud控制台`,this.outputChannelId=this.workspaceId+"-unicloud"}async start(){this.outputChannel=new Fs({title:this.outputChannelTitle,id:this.outputChannelId,workspaceFolder:this.workspaceFolder,provider:this.provider,name:this.name,uniCloudInfo:this.uniCloudInfo});const e=new xs;this.inspector=e,await e.connect(this.debugPort,"localhost"),e.on("consoleAPICalled",async e=>{const t=this.parseConsole(e);t.lines=await this.parseTextAsync(t.parsedArgs),this.outputChannel.appendConsole(t)}),e.on("exceptionThrown",async e=>{const t=this.parseUncaughtException(e);t.lines=await this.parseTextAsync(t.parsedArgs),this.outputChannel.appendConsole(t)}),e.on("executionContextDestroyed",()=>{setTimeout(()=>{this.stop(),this.emit("stop")},300)}),this.isHxDebugMode||e.api().Runtime.runIfWaitingForDebugger()}async stop(){this.inspector.disconnect(),this.outputChannel.disconnect(),this.status="stop"}}const Us=new class{constructor(){this.runnerList=[]}async startRunner({workspaceFolder:e,workspaceId:t,name:s,uniCloudInfo:r,provider:n,port:i,isHxDebugMode:o}){const a=new $s({workspaceFolder:e,workspaceId:t,name:s,uniCloudInfo:r,provider:n,port:i,isHxDebugMode:o});await a.start(),this.runnerList.push(a),a.on("stop",()=>{const e=this.runnerList.indexOf(a);e>-1&&this.runnerList.splice(e,1)})}};const Bs=new Map;async function As({provider:e,spaceId:s,appId:r,jqlPath:n,jqlContent:o,workspaceFolder:a,uuid:c,useCloudSchema:l=!1}={}){let h;try{h=await Z({provider:e,spaceId:s,appId:r,useCache:!0})}catch(e){return{code:e.code||"NETWORK_ERROR",message:e.message}}const{uniCloudSecret:u}=h,d=i.fork(`../${e}/index.js`,["jql-runner",t.resolve(__dirname,"../internal-functions"),JSON.stringify({jqlPath:n,jqlContent:o})],{silent:!0,cwd:__dirname,env:{UNICLOUD_DEBUGGER_PATH:process.env.UNICLOUD_DEBUGGER_PATH,UNICLOUD_INFO:JSON.stringify([]),SPACE_PROVIDER:e,WORKSPACE_FOLDER:a,UNICLOUD_SECRET:JSON.stringify(u),CALL_BY:"jql-runner",USE_CLOUD_SCHEMA:l?"true":"false"}}),p=new q.JsonRpcServer({bridgeProcess:d});return p.expose("getSchema",({name:t}={})=>async function({provider:e,appId:t,spaceId:s,name:r}={}){const n=await P.http.request({url:`https://${z}/serverless/clientdb/schema-list`,method:"post",params:{param:JSON.stringify({header:{token:"${user.checked.token}"},body:{provider:e,spaceId:s,appid:t,name:r}})}}),{list:i}=Y(n),o={};for(let e=0;e<i.length;e++){const t=i[e];o[t.name]=t.content}return o}({provider:e,spaceId:s,appId:r,name:t})),p.expose("getValidateFunction",({name:t}={})=>async function({provider:e,appId:t,spaceId:s,name:r}={}){const n=await P.http.request({url:`https://${z}/serverless/clientdb/validator-list`,method:"post",params:{param:JSON.stringify({header:{token:"${user.checked.token}"},body:{provider:e,spaceId:s,appid:t,name:r}})}}),{list:i}=Y(n),o={};for(let e=0;e<i.length;e++){const t=i[e];o[t.name]=t.content}return o}({provider:e,spaceId:s,appId:r,name:t})),Bs.set(c,d),new Promise((e,t)=>{d.on("message",t=>{if("ExecuteResult"===t.type){Bs.delete(c);const s={...t.result,message:qs(t.result),fullRes:{result:t.result}};e(s)}})})}function qs(e){if(e.message)return e.message;const{data:t,total:s,count:r,updated:n,deleted:i,inserted:o,ids:a,id:c,timeCost:l}=e;let h="";return void 0!==t?(h+=`查询到${t.length}条数据`,void 0!==r&&(h+=`，满足条件的数据总数为${r}条`),500!==t.length&&1e3!==t.length||(h+='，查询数量限制请参考：<a href="https://uniapp.dcloud.net.cn/uniCloud/cf-database?id=limit" target="_blank">https://uniapp.dcloud.net.cn/uniCloud/cf-database?id=limit</a>')):void 0!==o?h+=`批量插入成功，插入条数：${o}，插入数据的id列表为：${a.join(",")}`:void 0!==i?h+="删除完成，删除条数："+i:void 0!==n?h+="更新完成，更新条数："+n:void 0!==s?h+="计数完成，总条数："+s:void 0!==c&&(h+="插入成功，id为"+c),h+=`，本次请求耗时（包含网络传输时间）：${l}ms`,h}const Ws=new class{constructor(){if(Ds)return Ds;this.serverMap=new Map,Ds=this}parseSession(e){const t=V(e.workspaceFolder),s=e.workspaceFolder.id,r=e.type,n=e.console,i={};i.type={Develop:"app-plus",Develop_WX:"mp-weixin",Previou_Develop_Uniapp:"h5",Develop_Baidu:"mp-baidu",Develop_Alipay:"mp-alipay",Develop_Bytedance:"mp-toutiao",Develop_QQ:"mp-qq",Develop_360:"mp-360"}[r]||r,i.clientConsole=n,i.outputView=P.window.createOutputView({id:n._id,title:n._title});return{workspaceFolder:t,workspaceId:s,name:e.workspaceFolder.name,clientInfo:i,uniCloudInfo:e.configuration&&e.configuration.spaces?e.configuration.spaces.map(e=>(e.clientSecret?e.provider="aliyun":e.provider="tcb",e.spaceId=e.id,e)):[],runMode:e.runMode||"run"}}async startServer(e){const{workspaceFolder:t,workspaceId:s,name:r,clientInfo:n,uniCloudInfo:i,runMode:o}=this.parseSession(e);if(G("收到启动服务请求，参数："+JSON.stringify({workspaceFolder:t,workspaceId:s,name:r,uniCloudInfo:i,runMode:o})),!i||0===i.length)return;if(this.serverMap.has(t)){const e=this.serverMap.get(t);return G("服务已启动，重用现有服务。服务信息："+JSON.stringify(e.toEnv({platform:n.type}))),e.addClient(n),e.toEnv({platform:n.type})}for(let e=0;e<i.length;e++){const s=i[e],r=s.provider,n=q.getRealWorkspace({workspaceFolder:t,uniCloudInfo:i,provider:r}),o=q.getAppid(n);if(!o)throw new _({code:"APPID_MISSING",message:n===t?"manifest.json内未配置AppId，请重新获取后再试":`项目(${n})下manifest.json内未配置AppId，请重新获取后再试`});s.appId=o}const a={workspaceFolder:t,workspaceId:s,name:r,clientInfo:n,uniCloudInfo:i,runMode:o};G("准备启动服务，参数："+JSON.stringify(a));const c=new js(a);await c.start(),this.serverMap.set(t,c),G("服务已启动，服务信息："+JSON.stringify(c.toEnv({platform:n.type})));return{...c.toEnv({platform:n.type}),skipFiles:X()}}killAllServer(){this.serverMap.forEach(e=>{"stop"!==e.status&&e.stop()}),this.serverMap.clear()}killServer(e){if(!this.serverMap.has(e))return;this.serverMap.get(e).stop(),this.serverMap.delete(e)}async stopServer(e){const{workspaceFolder:t,clientInfo:s}=this.parseSession(e);if(!this.serverMap.has(t))return{code:"NO_SUCH_SERVER",message:"no such server"};const r=this.serverMap.get(t);return r.deleteClient(s),"stop"===r.status&&this.serverMap.delete(t),{code:0,serverStatus:r.status}}};exports.activate=function(e){const t=s.commands.registerCommand("extension.stopDebugServer",async()=>(Ws.killAllServer(),{}));return e.subscriptions.push(t),{async startDebugging(e){try{return await Ws.startServer(e)}catch(e){G("服务启动时捕获到错误："+(e&&e.stack)),s.window.showErrorMessage("uniCloud本地调试服务启动失败，错误信息为："+e.message+"<br/>请按照上述错误信息调整后重新运行uni-app项目")}},stopDebugging:async e=>await Ws.stopServer(e),async runJQL(e){let t;G("开始JQL查询："+JSON.stringify(e));try{t=await As(e)}catch(e){t={code:e.code||"INTERNAL_ERROR",message:e.message,detail:e.stack}}return t},stopJQL:async e=>(G("停止JQL查询："+JSON.stringify(e)),async function({uuid:e}){if(!Bs.has(e))return;Bs.get(e).kill("SIGKILL"),Bs.delete(e)}(e)),async customRequest({method:e,params:t}={}){switch(e){case"spaceChanged":{const e=V(t&&t.workspaceFolder);if(!Ws.serverMap.has(e))return{code:0};return Ws.serverMap.get(e).notify({level:"warning",info:"服务空间已改变，对本项目的本地调试服务自动关闭。请停止本项目所有正在运行的客户端后重新运行"}),Ws.killServer(e),{code:0}}case"localDebugLog":return G("开始本地运行："+JSON.stringify(t)),await async function({funurl:e,port:t,projectid:s,provider:r,root:n,spacename:i,debugMode:o=!1}){e=e.replace(/\\/g,"/");const a=s,c=q.getWorkspacePathFromFilePath(e),l=[{provider:r,name:i}],h=c.split("/").pop();await Us.startRunner({workspaceFolder:c,workspaceId:a,name:h,uniCloudInfo:l,provider:r,port:t,isHxDebugMode:o})}(t),{code:0,skipFiles:X()}}}}},exports.deactivate=function(){Ws.killAllServer()};
